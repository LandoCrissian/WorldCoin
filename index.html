<!-- SECTION 1 START -->
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CROnation ‚Äî One World. One CROnation.</title>

  <!-- Force dark BEFORE paint -->
  <script>document.documentElement.setAttribute('data-theme','dark');</script>

  <!-- Canonical + SEO -->
  <link rel="canonical" href="https://cronation.netlify.app/" />
  <meta name="description" content="Mark your country, mint a simple passport, and watch the Cronos community light up the world map." />
  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#0b0d12" />

  <!-- OG / Twitter -->
  <meta property="og:title" content="CROnation ‚Äî One World. One CROnation." />
  <meta property="og:description" content="Mark your country, mint a simple passport, and watch the Cronos community light up the world map." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://cronation.netlify.app/" />
  <meta property="og:image" content="https://raw.githubusercontent.com/LandoCrissian/WorldCoin/refs/heads/main/8DAEE2BE-F14F-4EB2-A993-E8EFE1EC2E35.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="CROnation ‚Äî One World. One CROnation." />
  <meta name="twitter:site" content="@cronation8" />
  <meta name="twitter:description" content="Join the map. Mint your passport. One CROnation." />
  <meta name="twitter:image" content="https://raw.githubusercontent.com/LandoCrissian/WorldCoin/refs/heads/main/8DAEE2BE-F14F-4EB2-A993-E8EFE1EC2E35.png" />
  <link rel="icon" href="https://raw.githubusercontent.com/LandoCrissian/WorldCoin/refs/heads/main/8DAEE2BE-F14F-4EB2-A993-E8EFE1EC2E35.png" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Ethers -->
  <script defer src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Firebase (compat builds) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    :root{ --bg:#0b0d12; --text:#e5e7eb; --muted:#9ca3af; --line:#1f2937; --soft:#0f1219; --accent:#3b82f6; --accent-600:#2563eb; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",sans-serif; color:var(--text); background:var(--bg); line-height:1.5; }

    header{ padding-top: calc(env(safe-area-inset-top, 0px)); position:sticky; top:0; backdrop-filter:saturate(120%) blur(8px); background: color-mix(in srgb, var(--bg) 86%, transparent); border-bottom:1px solid var(--line); z-index:10; }
    html { scroll-padding-top: 80px; }

    .notice{ background:color-mix(in srgb, var(--accent) 12%, var(--bg) 88%); border-bottom:1px solid var(--line); color:var(--text); }
    .notice .wrap{ width:min(1120px,92vw); margin:0 auto; padding:10px 0; font-weight:600; display:flex; gap:10px; align-items:center; justify-content:center; text-align:center; }
    .notice small{ color:var(--muted); font-weight:500; }

    .container{ width:min(1120px, 92vw); margin-inline:auto; padding:24px 0 72px; }
    .nav{ width:min(1120px, 92vw); margin-inline:auto; display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 0; }
    .brand{ display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; }
    .nav a.link{ text-decoration:none; color:var(--muted); font-weight:500; margin:0 10px; }
    .actions{ display:flex; align-items:center; gap:10px; }

    .btn{ appearance:none; border:1px solid var(--line); background:var(--bg); color:var(--text); padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; transition:.12s; min-height:44px; }
    .btn:hover{ transform: translateY(-1px); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; transform:none; }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#fff; }
    .btn.primary:hover{ background:var(--accent-600); }
    .btn.ghost{ background:transparent; }

    a.btn { display:inline-flex; align-items:center; justify-content:center; text-decoration:none; }

    #connectBtn, #buyBtn { min-width:160px; text-align:center; }

    .hero{ padding:32px 0 8px; display:grid; gap:16px; align-items:center; text-align:center; }
    .hero h1{ margin:0; font-size: clamp(28px, 3.2vw + 12px, 48px); letter-spacing:-0.02em; }
    .hero p.lead{ margin:6px auto 0; color:var(--muted); max-width:740px; font-size:clamp(15px, 1.2vw + 10px, 18px); }
    .hero .cta{ margin-top:18px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .hero .stats{ margin-bottom: 8px; }

    .stats{ margin-top:28px; display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    .stat{ padding:14px 16px; border:1px solid var(--line); border-radius:12px; background:var(--soft); display:flex; align-items:center; justify-content:center; gap:10px; font-weight:600; }
    .stat small{ color:var(--muted); display:block; font-weight:500; }

    .grid{ margin-top:36px; display:grid; gap:24px; grid-template-columns:1.3fr 1fr; }
    @media (max-width:960px){ .grid{ grid-template-columns:1fr; } }
    .card{ border:1px solid var(--line); border-radius:14px; background:var(--bg); box-shadow:0 2px 16px rgba(0,0,0,.04); }
    .card h3{ margin:0 0 6px; font-size:18px; }
    .card .body{ padding:16px; }
    .muted{ color:var(--muted); }

    #map{ width:100%; height:clamp(280px, 58vh, 560px); border-radius:12px; overflow:hidden; border:1px solid var(--line); background:var(--soft); }
    .leaflet-container{ font:inherit; }
    .map-note{ margin-top:10px; color:var(--muted); font-size:14px; }
    .leaflet-control-zoom { margin:10px; }
    .leaflet-control-zoom a { width:34px; height:34px; line-height:34px; }

    table{ width:100%; border-collapse:collapse; }
    th, td{ text-align:left; padding:10px 12px; border-bottom:1px solid var(--line); }
    th{ color:var(--muted); font-weight:600; font-size:14px; }
    .rank{ width:56px; color:var(--muted); font-weight:600; }
    .count{ text-align:right; }

    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.70); display:none; align-items:center; justify-content:center; padding:20px; z-index:5000; }
    .modal[open]{ display:flex; }
    .modal .panel{ width:min(560px, 96vw); background:var(--bg); border:1px solid var(--line); border-radius:16px; box-shadow:0 18px 60px rgba(0,0,0,.45); overflow:hidden; position:relative; z-index:5001; }
    .modal .header, .modal .content, .modal .footer{ background:var(--bg); }
    .modal .header{ padding:14px 16px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; }
    .modal .content{ padding:16px; display:grid; gap:16px; }
    .modal .footer{ padding:16px; border-top:1px solid var(--line); display:flex; justify-content:flex-end; gap:10px; }

    .join-grid{ display:grid; grid-template-columns:1fr; gap:14px; }
    .join-grid .full{ grid-column:1 / -1; }
    @media (min-width:640px){ .join-grid{ grid-template-columns:1fr 1fr; } }

    @media (max-width:640px){
      .spotlight{ 
        margin: 8px 0 10px; 
        padding: 8px 12px; 
      }
    }

    input, select, textarea{ font-size:16px; }
    .modal input, .modal select{ width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:color-mix(in srgb, var(--bg) 92%, #000 8%); font:inherit; color:var(--text); }
    body.modal-open{ overflow:hidden; }
    body.modal-open .leaflet-tooltip{ opacity:0 !important; pointer-events:none !important; }

    /* --- Nav sizing/behavior --- */
    .actions{ display:flex; align-items:center; gap:10px; flex-wrap:nowrap; min-width:0; }
    .actions .btn, .actions a.btn{ display:inline-flex; align-items:center; justify-content:center; min-width:160px; white-space:nowrap; text-decoration:none; }
    @media (max-width: 720px){ #buyBtn{ display:none; } .hamburger{ display:inline-flex; } }
    .hamburger{ width:44px; height:44px; }
    .nav{ position:relative; }
    .links{ display:flex; gap:16px; }
    .hamburger{ display:none; margin-left:8px; border:1px solid var(--line); border-radius:10px; background:var(--soft); cursor:pointer; align-items:center; justify-content:center; gap:4px; }
    .hamburger span{ display:block; width:18px; height:2px; background:var(--text); border-radius:2px; }
    .mobile-menu{ display:none; position:fixed; left:0; right:0; top:64px; background:var(--bg); border-top:1px solid var(--line); border-bottom:1px solid var(--line); padding:10px 12px; z-index:9; }
    .mobile-menu a.link{ display:block; padding:12px; color:var(--text); text-decoration:none; }
    .mobile-menu a.link + a.link{ border-top:1px solid var(--line); }
    @media (max-width:640px){ .links{ display:none; } .hamburger{ display:inline-flex; } .actions{ margin-left:auto; gap:8px; } .actions .btn{ padding:10px 12px; } }
    @media (min-width:641px){ .mobile-menu{ display:none !important; } }
    .mobile-menu.open{ display:block; }
    .hamburger[aria-expanded="true"] span:nth-child(2){ opacity:0; }
    .hamburger[aria-expanded="true"] span:nth-child(1){ transform: translateY(6px) rotate(45deg); }
    .hamburger[aria-expanded="true"] span:nth-child(3){ transform: translateY(-6px) rotate(-45deg); }

    /* ===== Passport (with flag background) ===== */
    .passport {
      position: relative;
      display: grid !important;
      grid-template-columns: 96px 1fr;
      gap: 16px;
      align-items: center;
      padding: 16px;
      border: 1px solid var(--line);
      border-radius: 16px;
      background: #0d203a;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    .passport > * { position:relative; z-index:1; }

    #passport-flag {
      position:absolute; inset:0;
      background-size:cover;
      background-position:center;
      filter:saturate(150%) contrast(1.15) brightness(1.05) blur(0.6px);
      opacity:.32;
      mix-blend-mode:overlay;
    }

    .passport::after {
      content:"";
      position:absolute; inset:0;
      background-image:url('https://www.transparenttextures.com/patterns/paper-fibers.png');
      background-size:300px;
      opacity:.15;
      mix-blend-mode:multiply;
      pointer-events:none;
      z-index:0;
    }

    .passport::before{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        -30deg,
        rgba(255,255,255,.06) 0px,
        rgba(255,255,255,.06) 18px,
        rgba(255,255,255,0)   18px,
        rgba(255,255,255,0)   42px
      );
      pointer-events:none;
      z-index:0;
    }

    #passport-flag {
      mask-image: radial-gradient(circle at center, rgba(0,0,0,1) 80%, rgba(0,0,0,0) 100%);
      -webkit-mask-image: radial-gradient(circle at center, rgba(0,0,0,1) 80%, rgba(0,0,0,0) 100%);
    }

    .passport .emblem { width:96px; height:96px; border-radius:14px; overflow:hidden; background:color-mix(in srgb, var(--soft) 70%, #000 30%); border:1px solid rgba(148,163,184,.25); display:grid; place-items:center; }
    .passport .emblem img{ width:100%; height:100%; object-fit:cover; background:#fff; }

    .passport .info b{ display:block; font-size:18px; letter-spacing:.01em; }
    .passport .info small{ color:var(--muted); }

    .passport .chip{
      display:inline-block; padding:4px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.28);
      background: rgba(2,6,23,.35);
      font-size:12px; font-weight:600; letter-spacing:.04em;
    }

    #passport-watermark{
      position: absolute; right:16px; bottom:16px; left:16px;
      font-weight:800; font-size:42px; line-height:1.05;
      text-transform:uppercase; letter-spacing:.06em;
      color:#fff; opacity:.08; pointer-events:none;
      word-break: break-word;
      z-index:0;
    }

    .passport{
      border:1px solid color-mix(in srgb, var(--line) 80%, transparent);
      box-shadow:
        inset 0 0 12px rgba(255,255,255,0.05),
        inset 0 0 28px rgba(0,0,0,0.28),
        0 14px 44px rgba(0,0,0,.28);
    }

    .passport .actions{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }
    .passport:hover { box-shadow: 0 16px 48px rgba(0,0,0,.30); }

    /* --- Flag polish + legibility --- */
    #passport-flag{
      position:absolute; inset:0;
      background-size:cover; background-position:center;
      filter: saturate(1.25) contrast(1.2) brightness(.9) blur(.4px);
      opacity:.42; mix-blend-mode:overlay;
      mask-image: radial-gradient(circle at 55% 55%, rgba(0,0,0,1) 82%, rgba(0,0,0,0) 100%);
      -webkit-mask-image: radial-gradient(circle at 55% 55%, rgba(0,0,0,1) 82%, rgba(0,0,0,0) 100%);
    }

    .passport .shade{
      position:absolute; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(120% 140% at 10% 10%, rgba(0,0,0,.52) 0%, rgba(0,0,0,0) 55%),
        linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,0) 38%);
    }

    .passport .gloss{
      position:absolute; inset:0; pointer-events:none; z-index:0;
      background: linear-gradient(25deg, rgba(255,255,255,.12), rgba(255,255,255,0) 28% 72%, rgba(255,255,255,.10));
      mix-blend-mode:soft-light; opacity:.6;
    }

    .passport .emblem{
      box-shadow: 0 6px 22px rgba(0,0,0,.35), 0 0 0 1px rgba(148,163,184,.22) inset;
    }

    #passport-watermark{ opacity:.10; letter-spacing:.08em; }

    .flag-icon{
      width:18px; height:12px;
      border-radius:2px;
      margin-left:6px;
      object-fit:cover;
      box-shadow:0 0 0 1px rgba(255,255,255,.15) inset;
    }

    .passport{
      background:
        linear-gradient(180deg, rgba(255,255,255,.03), transparent 38%),
        #0d203a;
    }

    @keyframes glowPulse {
      0%   { box-shadow:0 12px 40px rgba(0,0,0,.25), 0 0 0 rgba(59,130,246,.0); }
      50%  { box-shadow:0 12px 40px rgba(0,0,0,.25), 0 0 24px rgba(59,130,246,.8); }
      100% { box-shadow:0 12px 40px rgba(0,0,0,.25), 0 0 0 rgba(59,130,246,.0); }
    }
    .passport.activated{ animation: glowPulse 1.8s ease-in-out 1; }

    /* Leaderboard accordions */
    #leaderboard details { border:1px solid var(--line); border-radius:10px; background:var(--soft); margin-bottom:10px; }
    #leaderboard summary { list-style:none; cursor:pointer; padding:10px 12px; font-weight:600; display:flex; align-items:center; justify-content:space-between; }
    #leaderboard summary::-webkit-details-marker{ display:none; }
    #leaderboard .badge { background:rgba(148,163,184,.18); border:1px solid var(--line); border-radius:999px; padding:4px 10px; font-size:12px; margin-left:10px; }
    #leaderboard .panel { padding:10px 12px; border-top:1px solid var(--line); }

    /* Citizens list (modal + leaderboard) */
    .citizens-list .citizen { display:flex; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid var(--line); }
    .citizens-list .citizen:last-child{ border-bottom:none; }
    .citizens-list .avatar { width:24px; height:24px; border-radius:50%; background:#0f1219; display:grid; place-items:center; font-size:12px; font-weight:700; }
    .citizens-list .meta { display:flex; gap:8px; align-items:center; }
    .citizens-list small { color:var(--muted); }

    .passport-controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn.block{
      flex:1 1 180px;
      text-align:center;
    }
    @media (max-width:560px){
      .btn.block{ flex:1 1 100%; }
    }

    #passport + #passport-controls { margin-top:12px; }

    .badge.holder{
  display:inline-flex;
  align-items:center;
  gap:6px;
  margin-left:8px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(59,130,246,.45);
  background:linear-gradient(180deg, rgba(59,130,246,.22), rgba(2,6,23,.45));
  font-size:12px;
  font-weight:700;
  letter-spacing:.03em;
  box-shadow:0 0 0 1px rgba(59,130,246,.20) inset, 0 4px 18px rgba(59,130,246,.25);
  white-space:nowrap;
}
.badge.holder::before{ content:"‚óà"; transform:translateY(-1px); }

.passport.holder-glow{
  box-shadow:
    0 0 0 1px rgba(59,130,246,.35) inset,
    0 14px 44px rgba(0,0,0,.28),
    0 0 40px rgba(59,130,246,.35);
}
.passport.tier-1{
  --accent:#60a5fa;
  box-shadow:
    0 0 0 1px rgba(96,165,250,.45) inset,
    0 18px 56px rgba(0,0,0,.32),
    0 0 40px rgba(96,165,250,.35);
}
.passport.tier-2{
  --accent:#7dd3fc;
  position:relative;
  box-shadow:
    0 0 0 1px rgba(125,211,252,.55) inset,
    0 22px 66px rgba(0,0,0,.36),
    0 0 60px rgba(125,211,252,.45);
}
.passport.tier-2 .gloss{
  opacity:.95;
  animation: glossSweep 6s linear infinite;
}
.passport.tier-3{
  --accent:#fbbf24;
  position:relative;
  box-shadow:
    0 0 0 1px rgba(251,191,36,.65) inset,
    0 26px 76px rgba(0,0,0,.4),
    0 0 84px rgba(251,191,36,.6);
}
.passport.tier-3::before{
  content:"";
  position:absolute; inset:-1px;
  pointer-events:none; z-index:1;
  background:
    conic-gradient(from 0deg, rgba(255,255,255,.18), rgba(255,255,255,0) 40%, rgba(255,255,255,.18) 80%, rgba(255,255,255,0));
  mix-blend-mode:soft-light;
  animation: holoHue 8s linear infinite;
  border-radius: inherit;
}
.passport.tier-2 .badge.holder{ filter: drop-shadow(0 0 10px rgba(125,211,252,.3)); }
.passport.tier-3 .badge.holder{ filter: drop-shadow(0 0 12px rgba(251,191,36,.4)); }

@keyframes glossSweep{
  0% { background-position:-200% 0; }
  50%{ background-position:0 0; }
  100%{ background-position:200% 0; }
}
@keyframes holoHue{
  0% { filter:hue-rotate(0deg) saturate(1.15); }
  50%{ filter:hue-rotate(180deg) saturate(1.3); }
  100%{ filter:hue-rotate(360deg) saturate(1.15); }
}
@media (prefers-reduced-motion: reduce){
  .passport.holder-glow,
  .passport.tier-2 .gloss,
  .passport.tier-3 .gloss,
  .passport.tier-3::before{ animation:none; }
}

    .spotlight{
  position: relative;
  margin: 10px 0 12px;
  border-radius: 12px;
  border:1px solid color-mix(in srgb, var(--accent) 40%, var(--line));
  background:
    radial-gradient(120% 120% at 20% 50%, color-mix(in srgb, var(--accent) 14%, transparent), transparent 60%),
    color-mix(in srgb, var(--soft) 85%, #000);
  overflow:hidden;
  padding: 10px 14px;
}
.spotlight .glow{
  position:absolute; inset:-40% -10%;
  background: radial-gradient(60% 60% at 15% 50%, color-mix(in srgb, var(--accent) 32%, transparent), transparent 60%);
  filter: blur(20px); opacity:.5; pointer-events:none;
  animation: spotPulse 3.2s ease-in-out infinite;
}
@keyframes spotPulse { 0%,100%{opacity:.35} 50%{opacity:.7} }
.spotlight .spotlight-content{
  position:relative; display:flex; align-items:center; gap:10px; z-index:1;
  font-weight:700;
}
#spotlight-flag{
  width:24px; height:18px; border-radius:3px; object-fit:cover;
  box-shadow:0 0 0 1px rgba(255,255,255,.25) inset;
}

    /* Spotlight pulse */
@keyframes spotlightPulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(59,130,246,0.4); }
  50% { box-shadow: 0 0 12px 4px rgba(59,130,246,0.25); }
}

.spotlight.pulse {
  animation: spotlightPulse 3s ease-in-out infinite;
}

    /* --- Toast + Loader --- */
    .toast {
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#0f1219;border:1px solid var(--line);color:var(--text);
      padding:10px 12px;border-radius:10px;
      box-shadow:0 8px 30px rgba(0,0,0,.35);
      z-index:6000;opacity:0;pointer-events:none;transition:.2s;
    }
    .toast.show { opacity:1;pointer-events:auto; }

    .loader {
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;
      z-index:5500;
    }
    .loader[aria-busy="true"] { display:flex; }

    .loader .dot {
      width:8px;height:8px;border-radius:50%;background:#fff;
      margin:0 4px;animation:ld 1s infinite;
    }
    .loader .dot:nth-child(2){animation-delay:.15s;}
    .loader .dot:nth-child(3){animation-delay:.3s;}

    @keyframes ld {
      0%,80%,100%{opacity:.2;transform:scale(.8);}
      40%{opacity:1;transform:scale(1);}
    }

    .tab-panel .table { width:100%; border-collapse:collapse; }
    .tab-panel .table th, .tab-panel .table td { padding:8px 10px; border-bottom:1px solid var(--line); font-size:14px; }
    .tab-panel .table th { color:var(--muted); text-align:left; }
    .tab-panel button[data-tab].active { border-color: var(--accent); color:#fff; background: var(--accent); }
  </style>
</head>
<!-- SECTION 1 END -->
  <!-- SECTION 2 START -->
<body>

  <!-- Global toast + loader -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="loader" class="loader" aria-hidden="true">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>

  <!-- Status notice -->
  <div class="notice" role="status" aria-live="polite">
    <div class="wrap">
      <span><b>Passport mint is LIVE.</b></span>
      <span><small>On-chain NFT mint is coming soon. Connect your wallet (CRON8 holders) and select your country.</small></span>
    </div>
  </div>

  <header>
    <nav class="nav" aria-label="Primary">
      <a class="brand" href="#top" aria-label="CROnation home">
        <img src="https://raw.githubusercontent.com/LandoCrissian/WorldCoin/refs/heads/main/8DAEE2BE-F14F-4EB2-A993-E8EFE1EC2E35.png" 
             alt="CROnation logo" style="width:32px;height:32px;border-radius:50%;" />
        <b>CROnation</b>
      </a>

      <!-- Desktop links -->
      <div class="links">
        <a class="link" href="#map-section">Map</a>
        <a class="link" href="#leaderboard-card">Leaderboard</a>
        <a class="link" href="#about">About</a>
        <a class="link" href="https://x.com/cronation8" target="_blank" rel="noopener">ùïè</a>
        <a class="link" href="https://t.me/CRONationOfficial" target="_blank" rel="noopener">Telegram</a>
        <a class="link" href="https://www.puush.fun/coin/0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF" target="_blank" rel="noopener">Buy CRON8</a>
        <a class="link" id="adminLink" href="#admin" style="display:none;">Admin</a>
      </div>

      <div class="actions">
        <button id="connectBtn" class="btn ghost">Connect Wallet</button>
        <a id="buyBtn" class="btn ghost" 
           href="https://www.puush.fun/coin/0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF" 
           target="_blank" rel="noopener">Buy CRON8</a>
        <button class="hamburger" id="hamburger" aria-label="Menu" aria-controls="mobile-menu" aria-expanded="false">
          <span></span><span></span><span></span>
        </button>
      </div>

      <!-- Mobile menu -->
      <div class="mobile-menu" id="mobile-menu" role="menu">
        <a class="link" role="menuitem" href="#map-section">Map</a>
        <a class="link" role="menuitem" href="#leaderboard-card">Leaderboard</a>
        <a class="link" role="menuitem" href="#about">About</a>
        <a class="link" role="menuitem" href="https://x.com/cronation8" target="_blank" rel="noopener">Follow on ùïè</a>
        <a class="link" role="menuitem" href="https://t.me/CRONationOfficial" target="_blank" rel="noopener">Join on Telegram</a>
        <a class="link" role="menuitem" href="https://www.puush.fun/coin/0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF" target="_blank" rel="noopener">Buy CRON8</a>
      </div>
    </nav>
  </header>
<!-- SECTION 2 END -->
  <!-- SECTION 3 START: <main> + Hero -->
<main id="top">
  <section class="container hero">
    <h1>One World. One CROnation.</h1>
    <p class="lead">A clean, global map of our community on Cronos. Mark your country, mint a simple passport, and watch the world light up.</p>
    <div class="cta">
      <button id="markBtn" class="btn primary" onclick="scrollToMap()">Mark Your Country</button>
      <a href="https://x.com/cronation8" target="_blank" rel="noopener" class="btn" title="Follow on ùïè">Follow on ùïè</a>
      <a href="https://t.me/CRONationOfficial" target="_blank" rel="noopener" class="btn">Join on Telegram</a>
    </div>

    <div class="stats" role="status" aria-live="polite">
      <div class="stat"><div><small>Countries represented</small><span id="stat-countries">0</span></div></div>
      <div class="stat"><div><small>Citizens joined</small><span id="stat-citizens">0</span></div></div>
      <div class="stat"><div><small>Most active</small><span id="stat-top">‚Äî</span></div></div>
      <div class="stat"><div><small>Country spotlight</small><span id="stat-spotlight">‚Äî</span></div></div>
    </div>
  </section>
<!-- SECTION 3 END -->
  <!-- SECTION 4 START: Map + Leaderboard + Join -->
  <!-- Country Spotlight (wide banner above map) -->
<div id="spotlight-banner" class="spotlight" style="display:none">
  <div class="glow"></div>
  <div class="spotlight-content">
    <img id="spotlight-flag" alt="" />
    <span id="spotlight-text">‚Äî</span>
  </div>
</div>

  
  <section id="map-section" class="container grid">
    <div class="card">
      <div class="body">
        <h3>Community Map</h3>
        <p class="muted">Tap a country to join. You can also use the form below.</p>
        <div id="map" aria-label="Interactive world map"></div>
        <p class="map-note">Passport is live. On-chain NFT mint coming soon.</p>
      </div>
    </div>

    <aside class="card" id="leaderboard-card">
      <div class="body">
        <h3>Leaderboard</h3>
        <div id="leaderboard"></div>
      </div>
    </aside>

    <div class="card" id="join-card">
      <div class="body">
        <h3>Join CROnation</h3>

        <!-- ADMIN PANEL (PRO) -->
<div id="admin" class="card" style="display:none;">
  <div class="body">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
      <h3 style="margin:0">Admin</h3>
      <small class="muted">Token: <code id="ad-token"></code> ¬∑ Net: Cronos</small>
    </div>

    <!-- Tabs -->
    <div style="margin-top:12px;border-bottom:1px solid var(--line);display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn ghost" data-tab="airdrop">Airdrop</button>
      <button class="btn ghost" data-tab="audit">Campaigns / Audit</button>
      <button class="btn ghost" data-tab="tools">Tools</button>
      <button class="btn ghost" data-tab="settings">Settings</button>
    </div>

    <!-- TAB: AIRDROP -->
    <div class="tab-panel" id="tab-airdrop" style="display:block;margin-top:12px;">
      <div class="spotlight" style="margin:0 0 12px;">
        <div class="spotlight-content"><span>Smart airdrop control ¬∑ deterministic & auditable</span></div>
      </div>

      <div style="display:grid;gap:12px;grid-template-columns:1fr;max-width:880px;">
        <!-- Token -->
        <label style="display:flex;gap:10px;align-items:center;">
          <span style="min-width:140px;">Token (ERC-20)</span>
          <input id="ad-token-input" placeholder="0x‚Ä¶ (leave blank for CRON8)" style="flex:1;padding:8px;">
        </label>

        <!-- Mode -->
        <label style="display:flex;gap:10px;align-items:center;">
          <span style="min-width:140px;">Mode</span>
          <select id="ad-mode" style="flex:1;padding:8px;">
            <option value="simple">Simple Transfer (same amount)</option>
            <option value="tiered">Tiered Transfer (by country)</option>
            <option value="csv">CSV / Manual (address,amount)</option>
            <option value="erc721">ERC-721 Mint (simulated)</option>
            <option value="erc1155">ERC-1155 Airdrop (simulated)</option>
          </select>
        </label>

        <!-- Filters -->
        <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr;">
          <label style="display:flex;gap:10px;align-items:center;">
            <span>Country filter</span>
            <select id="ad-country" style="flex:1;padding:8px;">
              <option value="">All countries</option>
            </select>
          </label>
          <label style="display:flex;gap:10px;align-items:center;">
            <span>Limit</span>
            <input id="ad-limit" type="number" min="0" step="1" placeholder="e.g. 50 (blank = all)" style="flex:1;padding:8px;">
          </label>
        </div>

        <label style="display:flex;gap:8px;align-items:center;">
          <input id="ad-unique" type="checkbox" checked>
          <span>Unique per campaign (skip wallets already paid in this campaign)</span>
        </label>

        <!-- Amounts / per-mode -->
        <div id="ad-amounts">
          <!-- Simple -->
          <label class="ad-mode-simple" style="display:flex;gap:10px;align-items:center;">
            <span style="min-width:140px;">Amount / wallet</span>
            <input id="ad-amount" type="number" min="0" step="0.000001" value="1000" style="flex:1;padding:8px;">
          </label>

          <!-- Tiered -->
          <div class="ad-mode-tiered" style="display:none;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <b>Tier rules</b>
              <button id="ad-tier-add" class="btn">Add rule</button>
            </div>
            <div id="ad-tier-rows" style="border:1px solid var(--line);border-radius:10px;padding:8px;"></div>
            <small class="muted">Each rule: Country ‚Üí Amount. ‚ÄúElse‚Äù row applies to any country not listed.</small>
          </div>

          <!-- CSV -->
          <div class="ad-mode-csv" style="display:none;">
            <label style="display:flex;gap:10px;align-items:flex-start;">
              <span style="min-width:140px;">CSV / Manual</span>
              <textarea id="ad-csv" rows="6" style="flex:1;padding:8px;" placeholder="address,amount
0xabc...,1000
0xdef...,2500"></textarea>
            </label>
            <div style="display:flex;gap:10px;align-items:center;">
              <input id="ad-csv-file" type="file" accept=".csv" class="btn" />
              <small class="muted">Columns: address,amount ‚Äî amounts in human units (e.g., 1000)</small>
            </div>
          </div>
        </div>

        <!-- Run options -->
        <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr;">
          <label style="display:flex;gap:10px;align-items:center;">
            <span>Batch size</span>
            <input id="ad-batch" type="number" min="1" step="1" value="1" style="flex:1;padding:8px;">
          </label>
          <label style="display:flex;gap:10px;align-items:center;">
            <span>Gas limit</span>
            <input id="ad-gas" type="number" min="0" step="1000" placeholder="optional" style="flex:1;padding:8px;">
          </label>
          <label style="display:flex;gap:8px;align-items:center;">
            <input id="ad-dry" type="checkbox" checked>
            <span>Dry run (no tokens sent)</span>
          </label>
        </div>

        <!-- Actions -->
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button id="ad-preview" class="btn">Preview Plan</button>
          <button id="ad-go" class="btn primary">Start Airdrop</button>
          <button id="ad-copy-plan" class="btn">Copy Plan CSV</button>
          <button id="ad-copy-addrs" class="btn">Copy Addresses</button>
        </div>

        <!-- Status + Log -->
        <div id="ad-status" class="muted" style="padding:8px 0;">Status: ‚Äî</div>
        <textarea id="ad-log" rows="10" style="width:100%;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;padding:10px;background:#0f1219;color:#e5e7eb;border:1px solid var(--line);border-radius:8px;" placeholder="Log‚Ä¶"></textarea>
      </div>
    </div>

    <!-- TAB: AUDIT -->
    <div class="tab-panel" id="tab-audit" style="display:none;margin-top:12px;">
      <div id="audit-table"></div>
      <div style="display:flex;gap:10px;margin-top:10px;">
        <button id="audit-refresh" class="btn">Refresh</button>
        <button id="audit-export-csv" class="btn">Export CSV</button>
        <button id="audit-export-json" class="btn">Export JSON</button>
      </div>
    </div>

    <!-- TAB: TOOLS -->
    <div class="tab-panel" id="tab-tools" style="display:none;margin-top:12px;max-width:880px;">
      <div style="display:grid;gap:12px;">
        <div class="card"><div class="body" style="display:grid;gap:10px;">
          <b>Balance Check</b>
          <label style="display:flex;gap:10px;align-items:center;">
            <span style="min-width:120px;">Address</span>
            <input id="tool-balance-addr" placeholder="0x‚Ä¶" style="flex:1;padding:8px;">
          </label>
          <button id="tool-balance-go" class="btn">Check</button>
          <small id="tool-balance-out" class="muted">‚Äî</small>
        </div></div>

        <div class="card"><div class="body" style="display:grid;gap:10px;">
          <b>Holder Snapshot (passports)</b>
          <button id="tool-snapshot" class="btn">Export CSV</button>
          <small class="muted">Exports: address,country,nick,created</small>
        </div></div>

        <div class="card"><div class="body" style="display:grid;gap:10px;">
          <b>De-dupe Helper</b>
          <textarea id="tool-dedupe-in" rows="4" placeholder="One address per line"></textarea>
          <button id="tool-dedupe-go" class="btn">De-dupe</button>
          <textarea id="tool-dedupe-out" rows="4" placeholder="Unique, lowercased‚Ä¶" readonly></textarea>
          <small id="tool-dedupe-count" class="muted">‚Äî</small>
        </div></div>
      </div>
    </div>

    <!-- TAB: SETTINGS -->
    <div class="tab-panel" id="tab-settings" style="display:none;margin-top:12px;max-width:880px;">
      <div style="display:grid;gap:12px;">
        <label style="display:flex;gap:10px;align-items:center;">
          <span style="min-width:180px;">Default batch size</span>
          <input id="cfg-batch" type="number" min="1" step="1" value="1" style="flex:1;padding:8px;">
        </label>
        <label style="display:flex;gap:10px;align-items:center;">
          <span style="min-width:180px;">Default gas limit</span>
          <input id="cfg-gas" type="number" min="0" step="1000" placeholder="optional" style="flex:1;padding:8px;">
        </label>
        <label style="display:flex;gap:8px;align-items:center;">
          <input id="cfg-confirm" type="checkbox" checked>
          <span>Dangerous actions require confirm()</span>
        </label>
        <div>
          <b>Admin allow-list (local mirror)</b>
          <textarea id="cfg-admins" rows="3" placeholder="0x‚Ä¶ one per line"></textarea>
          <button id="cfg-admins-save" class="btn" style="margin-top:8px;">Save mirror (local)</button>
          <small class="muted">Source of truth still the hard-coded set in JS.</small>
        </div>
      </div>
    </div>
  </div>
</div>

        <form id="join-form" class="join-grid">
          <div class="field">
            <label for="country">Country</label>
            <select id="country" required>
              <option value="">Select your country</option>
            </select>
          </div>

          <div class="field">
            <label for="nickname">Nickname (optional)</label>
            <input id="nickname" placeholder="e.g. WillyBilly" />
          </div>

          <div class="field full" style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="mintBtn" class="btn primary" type="submit">Mint Passport</button>
          </div>
        </form>

        <!-- Passport card -->
        <div id="passport" class="passport" style="display:none; margin-top:12px;">
          <div id="passport-flag" aria-hidden="true"></div>
          <div class="shade" aria-hidden="true"></div>
          <div class="gloss" aria-hidden="true"></div>

          <div class="emblem">
            <img id="passport-pfp"
                 src="https://raw.githubusercontent.com/LandoCrissian/WorldCoin/refs/heads/main/8DAEE2BE-F14F-4EB2-A993-E8EFE1EC2E35.png"
                 alt="CROnation logo">
          </div>

          <div class="info">
  <b>CROnation Passport <span id="passport-serial">#000000</span></b>
  <small>
    <span id="passport-nick">‚Äî</span> ‚Äî
    <span id="passport-country">‚Äî</span>
    <img id="passport-flag-icon" class="flag-icon" alt="" style="display:none;" />
    <span id="passport-address-chip" class="chip" style="margin-left:6px;">‚Äî</span>
    <span id="holder-badge" class="badge holder" style="display:none;" aria-label="CRON8 holder badge"></span>
  </small>
</div>

          <div id="passport-watermark" aria-hidden="true"></div>
        </div>

        <!-- Controls OUTSIDE the passport -->
        <div id="passport-controls" class="passport-controls" style="display:none; margin-top:12px;">
          <label class="btn block" style="cursor:pointer;">
            <input id="pfpInput" type="file" accept="image/*" style="display:none;">
            Upload PFP
          </label>
          <button id="shareBtn" type="button" class="btn block">Share to ùïè</button>
          <button id="downloadBtn" type="button" class="btn block">Download PNG</button>
        </div>

        <!-- ABOUT -->
        <div class="card" id="about">
          <div class="body">
            <h3>About</h3>
            <p class="muted">CROnation is a simple, global participation map for the Cronos community. It‚Äôs not a complicated game or an overpromised utility ‚Äî just a clean way to visualize where we all are, and a minimal passport to flex your origin.</p>
            <p class="muted">Design language: premium, minimal, accessible. Built mobile-first with a lightweight stack and room to grow into wallet connections, airdrops, and seasonal leaderboards.</p>
          </div>
        </div>
      </div>
    </div>
  </section>
<!-- SECTION 4 END -->
  <!-- SECTION 5 START: Join Modal -->
    <div class="modal" id="join-modal" role="dialog" aria-modal="true" aria-labelledby="join-title">
      <div class="panel">
        <div class="header">
          <b id="join-title">Join CROnation</b>
          <button class="btn" onclick="closeModal()">Close</button>
        </div>
        <div class="content">
          <div class="field">
            <label for="modal-country">Country</label>
            <input id="modal-country" disabled>
          </div>
          <div class="field">
            <label for="modal-nickname">Nickname (optional)</label>
            <input id="modal-nickname" placeholder="e.g. WillyBillyCRO">
          </div>
          <div class="field full">
            <div id="citizens-list" class="citizens-list"></div>
          </div>
        </div>
        <div class="footer">
          <button id="modalMintBtn" class="btn primary" onclick="mintFromModal()">Mint Passport</button>
        </div>
      </div>
    </div>
  </main>
<!-- SECTION 5 END -->
  <!-- SECTION 6 START: Footer + handoff to scripts -->
  <footer class="footer">
    <div class="container">
      <div style="display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
        <small>¬© <span id="year"></span> CROnation. Built for Cronos ‚Äî community-first.</small>
        <small class="muted">This platform is evolving ‚Äî join us as we build CROnation together.</small>
      </div>
    </div>
  </footer>

  <!-- Scripts continue in next section -->
<!-- SECTION 6 END -->
  <!-- SECTION 7.A START: <script> (bootstrap, flags, Firebase, helpers) -->
<script>
window.addEventListener('DOMContentLoaded', () => {
  /**** Flags ****/
  const FLAGS = {
    TOKEN_GATE: true,
    REQUIRE_WALLET: true,
    AUTO_CONNECT: false,
    PASSPORT_MINT_ENABLED: true,
    NFT_MINT_ENABLED: false
  };

  const LAUNCH = {
    xHandle: 'cronation8',
    siteUrl: 'https://cronation.netlify.app',
    token: {
      address: '0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF',
      decimals: 18,
      minBalance: '1',
      chainIdHex: '0x19', // Cronos Mainnet (25)
      rpc: 'https://evm.cronos.org',
      abi: [{"constant":true,"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"type":"function"}],
    }
  };

  /* Admin allow-list (strings, normalized to lowercase) */
const ADMIN_WALLETS = new Set([
  '0x69b6c23e59f9fd56fa3de3edf624d5c2c67c05f0'  // üëà lowercase string
  // add more if needed
]);

  /**** Firebase ****/
  const firebaseConfig = {
    apiKey: "AIzaSyAJ0eSdO1mEYdbVNVRbiB0BlOwn6UEjT10",
    authDomain: "cronation-6058b.firebaseapp.com",
    projectId: "cronation-6058b",
    storageBucket: "cronation-6058b.appspot.com",
    messagingSenderId: "303748855698",
    appId: "1:303748855698:web:b03fe82e7314ab371bf34b"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /**** Helpers ****/
  const el = (id)=>document.getElementById(id);

  // --- download helpers ---
  const dataUrlToBlob = async (dataUrl) => (await fetch(dataUrl)).blob();
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function scrollToMap(){
    const header = document.querySelector('header');
    const sec = document.getElementById('map-section');
    if(!header || !sec) return;
    const y = sec.getBoundingClientRect().top + window.pageYOffset - header.getBoundingClientRect().height - 8;
    window.scrollTo({ top: y, behavior:'smooth' });
  }
  window.scrollToMap = scrollToMap;

  function toast(msg){
    const t=document.getElementById('toast');
    t.textContent=msg;
    t.classList.add('show');
    clearTimeout(t._h);
    t._h=setTimeout(()=>t.classList.remove('show'),2600);
  }

  function setBusy(on){
    const l=document.getElementById('loader');
    l.setAttribute('aria-busy',on?'true':'false');
    l.setAttribute('aria-hidden',on?'false':'true');
  }

  /* UI helpers + privacy */
  function hideCTAIfMinted(){
    const btn = document.getElementById('markBtn');
    if (btn) btn.style.display = 'none';
  }
  function shortAddrFull(a){ return a ? a.slice(0,6)+'‚Ä¶'+a.slice(-4) : ''; }
  function initialsFromNick(n){
    n = (n||'').trim();
    if(!n) return 'üë§';
    const parts = n.split(/\s+/).slice(0,2);
    return parts.map(p=>p[0]).join('').toUpperCase();
  }

  // Small helpers
  const loadImg = (src) => new Promise((res, rej) => { const i = new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src; });
  const blobToDataUrl = (b) => new Promise(r => { const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(b); });
  const fetchAsDataUrl = async (url) => { const r = await fetch(url,{mode:'cors',cache:'force-cache'}); const b=await r.blob(); return blobToDataUrl(b); };

  // Render a PNG of the passport without DOM snapshot (CORS-safe)
async function renderPassportPNGViaCanvas({ country, nick, serial, address, tier = (window.__cron8Tier || 0) }) {
  const W = 1200, H = 480, DPR = Math.min(2, window.devicePixelRatio || 1.5);
  const c = document.createElement('canvas'); c.width=W*DPR; c.height=H*DPR;
  const ctx = c.getContext('2d'); ctx.scale(DPR, DPR);

  // Rounded backdrop
  const bg = '#0d203a', radius = 24;
  roundRect(ctx, 0, 0, W, H, radius); ctx.fillStyle = bg; ctx.fill();

  // Flag background (fetch as data URL to avoid taint)
  const iso2 = countryToISO2(country);
  if (iso2){
    try{
      const flagUrl = await fetchAsDataUrl(`https://flagcdn.com/w320/${iso2}.png`);
      const flagImg = await loadImg(flagUrl);
      ctx.save();
      try{ ctx.filter = 'blur(0.8px) saturate(1.25)'; }catch(_){}
      ctx.globalAlpha = 0.42;
      drawCover(flagImg, W, H, ctx);
      ctx.restore();
    }catch(_){}
  }

  // Subtle diagonal sheen
  const grad = ctx.createLinearGradient(0,0, W,H);
  grad.addColorStop(0,'rgba(255,255,255,.05)');
  grad.addColorStop(.35,'rgba(255,255,255,0)');
  grad.addColorStop(.7,'rgba(255,255,255,.04)');
  grad.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle = grad; roundRect(ctx,0,0,W,H,radius); ctx.fill();

  // Emblem/PFP (convert current <img> to data URL if needed)
  const pfpEl = document.getElementById('passport-pfp');
  let pfpSrc = pfpEl?.src || '';
  if (pfpSrc && !pfpSrc.startsWith('data:')) {
    try { pfpSrc = await fetchAsDataUrl(pfpSrc); } catch(_){ pfpSrc = null; }
  }
  if (pfpSrc){
    const EMB = { x: 36, y: 36, w: 128, h: 128, r: 18 };
    const p = await loadImg(pfpSrc);
    ctx.fillStyle='rgba(15,18,25,.7)'; roundRect(ctx, EMB.x-2, EMB.y-2, EMB.w+4, EMB.h+4, EMB.r); ctx.fill();
    roundRect(ctx, EMB.x, EMB.y, EMB.w, EMB.h, EMB.r); ctx.save(); ctx.clip();
    ctx.drawImage(p, EMB.x, EMB.y, EMB.w, EMB.h); ctx.restore();
    ctx.strokeStyle='rgba(148,163,184,.25)'; ctx.lineWidth=2; roundRect(ctx, EMB.x, EMB.y, EMB.w, EMB.h, EMB.r); ctx.stroke();
  }

  // Title / serial
  ctx.fillStyle='#fff'; ctx.textBaseline='top';
  ctx.font='700 52px Inter, system-ui, -apple-system'; ctx.fillText('CROnation Passport', 188, 40);
  ctx.font='800 58px Inter, system-ui, -apple-system'; ctx.fillText(`#${String(serial).padStart(6,'0')}`, 188, 100);

  // Subtitle
  ctx.font='600 30px Inter, system-ui, -apple-system'; ctx.fillStyle='rgba(229,231,235,.88)';
  ctx.fillText(`CROnation ‚Äî ${country}`, 188, 170);

  // Address chip
  if (address){
    const chip = address.slice(0,6)+'‚Ä¶'+address.slice(-4);
    const x=188, y=220, padX=16, h=40, r=18;
    ctx.font='700 24px Inter, system-ui, -apple-system';
    const w = Math.ceil(ctx.measureText(chip).width)+padX*2;
    ctx.fillStyle='rgba(2,6,23,.35)'; roundRect(ctx,x,y,w,h,r); ctx.fill();
    ctx.strokeStyle='rgba(148,163,184,.28)'; ctx.lineWidth=2; roundRect(ctx,x,y,w,h,r); ctx.stroke();
    ctx.fillStyle='#e5e7eb'; ctx.fillText(chip, x+padX, y+8);
  }

  // Watermark
  ctx.save(); ctx.globalAlpha=0.09; ctx.fillStyle='#fff';
  ctx.font='800 96px Inter, system-ui, -apple-system';
  wrapBig(ctx, (country||'').toUpperCase(), 36, H-140, W-72); ctx.restore();

    // --- Holder tier pill (just under the address chip) ---
  if (tier > 0){
    const label = tier === 3 ? 'üëë CRON8 Elite Diplomat'
                : tier === 2 ? '‚óÜ CRON8 Nation Builder'
                : '‚óà CRON8 Citizen Holder';

    // Anchor to the same x as the info column and just below the address chip
    const INFO_X = 188;
    const CHIP_Y = 220;     // where we drew the address chip
    const GAP    = 22;      // space between chip and tier
    const PILL_Y = CHIP_Y + 40 /*chip h*/ + GAP;

    // Measure / fit
    const padX = 18, r = 20, pillH = 48;
    ctx.font = '700 28px Inter, system-ui, -apple-system';
    let textW = Math.ceil(ctx.measureText(label).width);
    const maxW = 1200 - INFO_X - 36; // keep inside right edge
    const pillW = Math.min(textW + padX*2, maxW);

    // Background gradient by tier
    const g = ctx.createLinearGradient(INFO_X, PILL_Y, INFO_X + pillW, PILL_Y + pillH);
    if (tier === 3){ g.addColorStop(0,'rgba(251,191,36,.28)'); g.addColorStop(1,'rgba(2,6,23,.55)'); }
    else if (tier === 2){ g.addColorStop(0,'rgba(125,211,252,.26)'); g.addColorStop(1,'rgba(2,6,23,.55)'); }
    else { g.addColorStop(0,'rgba(96,165,250,.24)'); g.addColorStop(1,'rgba(2,6,23,.55)'); }

    roundRect(ctx, INFO_X, PILL_Y, pillW, pillH, r); ctx.fillStyle = g; ctx.fill();
    ctx.strokeStyle = tier === 3 ? 'rgba(251,191,36,.55)'
                    : tier === 2 ? 'rgba(125,211,252,.45)'
                    : 'rgba(96,165,250,.45)';
    ctx.lineWidth = 2; roundRect(ctx, INFO_X, PILL_Y, pillW, pillH, r); ctx.stroke();

    // Text (truncate if needed)
    ctx.fillStyle = '#e5e7eb';
    let shown = label;
    while (ctx.measureText(shown).width > pillW - padX*2 && shown.length > 3) {
      shown = shown.slice(0, -2) + '‚Ä¶';
    }
    ctx.fillText(shown, INFO_X + padX, PILL_Y + (pillH - 28)/2 - 2);

    // Subtle outer glow
    ctx.shadowColor = ctx.strokeStyle; ctx.shadowBlur = 10;
    roundRect(ctx, INFO_X, PILL_Y, pillW, pillH, r); ctx.stroke();
    ctx.shadowBlur = 0;
  }

  return c.toDataURL('image/png', 0.95);

  // --- helpers ---
  function roundRect(c,x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); c.beginPath(); c.moveTo(x+rr,y); c.arcTo(x+w,y,x+w,y+h,rr); c.arcTo(x+w,y+h,x,y+h,rr); c.arcTo(x,y+h,x,y,rr); c.arcTo(x,y,x+w,y,rr); c.closePath(); }
  function drawCover(img,W,H,ctx){ const wr=W/img.width, hr=H/img.height, r=Math.max(wr,hr); const dw=img.width*r, dh=img.height*r, dx=(W-dw)/2, dy=(H-dh)/2; ctx.drawImage(img,dx,dy,dw,dh); }
  function wrapBig(c, text, x, y, maxW){ const words=(text||'').split(/\s+/); let line='', yy=y; const lh=84; for (const w of words){ const t=(line?line+' ':'')+w; if(c.measureText(t).width>maxW && line){ c.fillText(line,x,yy); line=w; yy+=lh; } else { line=t; } } if(line) c.fillText(line,x,yy); }
}

  /* Firestore: get citizens for a country */
  async function fetchCitizens(country){
    const qs = await db.collection('passports').where('country','==',country).get();
    const rows = [];
    qs.forEach(doc=>{
      const d = doc.data();
      if(!d) return;
      rows.push({ nick: d.nick || 'Anonymous', address: d.address || '' });
    });
    rows.sort((a,b)=> (a.nick||'').localeCompare(b.nick||''));
    return rows;
  }

  /* Render citizens into a container */
  function renderCitizens(container, citizens){
    if(!container) return;
    if(!citizens.length){ container.innerHTML = `<small class="muted">No citizens yet.</small>`; return; }
    container.innerHTML = citizens.map(c=>`
      <div class="citizen">
        <div class="avatar">${initialsFromNick(c.nick)}</div>
        <div class="meta">
          <b>${c.nick || 'Anonymous'}</b>
          <small>${shortAddrFull(c.address)}</small>
        </div>
      </div>
    `).join('');
  }

  /* Load citizens into the modal */
  async function loadCitizensIntoModal(country){
    const box = document.getElementById('citizens-list');
    if(!box) return;
    box.innerHTML = `<small class="muted">Loading citizens‚Ä¶</small>`;
    try{
      const citizens = await fetchCitizens(country);
      renderCitizens(box, citizens);
      toast(`Loaded ${citizens.length} citizen${citizens.length===1?'':'s'}`);
    }catch(e){
      console.error(e);
      box.innerHTML = `<small class="muted">Could not load citizens right now.</small>`;
    }
  }

  
  /**** Country coloring + layers ****/
  const countryLayers = new Map();
  function colorFor(count){
    if (count >= 25) return '#1d4ed8';
    if (count >= 10) return '#3b82f6';
    if (count >= 1)  return '#93c5fd';
    return '#e5e7eb';
  }
  function updateCountryStyle(name){
    const layer = countryLayers.get(name);
    if (!layer) return;
    const count = countryCounts.get(name) || 0;
    layer.setStyle({ fillColor: colorFor(count) });
  }

  /**** Mobile menu ****/
  (function mobileMenu(){
    const btn = el('hamburger');
    const menu = el('mobile-menu');
    if(!btn || !menu) return;
    const close = () => { menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); };
    const open  = () => { menu.classList.add('open');  btn.setAttribute('aria-expanded','true'); };
    btn.addEventListener('click', () => { (btn.getAttribute('aria-expanded') === 'true') ? close() : open(); });
    menu.querySelectorAll('a').forEach(a => a.addEventListener('click', close));
    window.addEventListener('keydown', e => { if(e.key === 'Escape') close(); }, { passive:true });
    window.addEventListener('click', e => { if(!menu.contains(e.target) && e.target !== btn && !btn.contains(e.target)) close(); }, { passive:true });
    window.addEventListener('resize', () => { if(window.innerWidth > 640) close(); }, { passive:true });
  })();

  /**** Map + Countries ****/
  const countryCounts = new Map();
  const countryList = [];
  let totalCitizens = 0;
  el('year').textContent = new Date().getFullYear();

  const map = L.map('map', {
    zoomControl: true,
    minZoom: 1,
    maxZoom: 6,
    worldCopyJump: true,
    attributionControl: false
  }).setView([20, 0], 2);

  const REMOTE_GEOJSON_URL = 'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson';
  const LOCAL_FALLBACK_URL = '/assets/data/countries.geojson';

  async function loadGeojson(url){
    const r = await fetch(url, { cache: 'force-cache' });
    if(!r.ok) throw new Error('geojson fetch failed: ' + r.status);
    return r.json();
  }

  function populateCountryDropdown(list){
    const sel = el('country');
    if(!sel) return;
    const frag = document.createDocumentFragment();
    list.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      frag.appendChild(opt);
    });
    sel.appendChild(frag);
  }

  (async function initMap(){
    let data;
    try{
      data = await loadGeojson(REMOTE_GEOJSON_URL);
    }catch(e1){
      console.warn('Remote GeoJSON failed, using local fallback', e1);
      try{
        data = await loadGeojson(LOCAL_FALLBACK_URL);
      }catch(e2){
        console.error('Fallback GeoJSON failed', e2);
        el('map').innerHTML = `<div style="padding:16px;color:var(--muted)">
          Unable to load map. <button class="btn" onclick="location.reload()">Retry</button>
        </div>`;
        return;
      }
    }

    // Build country list for dropdown
    (data.features||[]).forEach(f => {
      const name = f.properties.ADMIN || f.properties.name || f.properties.COUNTRY || 'Unknown';
      countryList.push(name);
    });
    countryList.sort((a,b)=>a.localeCompare(b));
    populateCountryDropdown(countryList);

    const layer = L.geoJSON(data, {
      style: (feature) => {
        const name = feature.properties.ADMIN || feature.properties.name || feature.properties.COUNTRY || 'Unknown';
        const count = countryCounts.get(name) || 0;
        return { color:'#cbd5e1', weight:1, fillColor:colorFor(count), fillOpacity:1 };
      },
      onEachFeature: (feature, l) => {
        const name = feature.properties.ADMIN || feature.properties.name || feature.properties.COUNTRY || 'Unknown';
        countryLayers.set(name, l);
        l.on({
          mouseover: () => { l.setStyle({ fillOpacity: 1, weight: 1.2 }); },
          mouseout:  () => { updateCountryStyle(name); l.setStyle({ weight: 1 }); },
          click:     () => openModal(name)
        });
        l.bindTooltip(name, { sticky: true });
      }
    }).addTo(map);

    try { map.fitBounds(layer.getBounds(), {padding:[10,10]}); } catch(e){}

    const invalidate = () => { try { map.invalidateSize(); } catch(_) {} };
    requestAnimationFrame(invalidate);
    setTimeout(invalidate, 300);
    ['orientationchange','resize'].forEach(ev =>
      window.addEventListener(ev, invalidate, { passive: true })
    );
  })();

  
  /**** Modal ****/
  function openModal(country){
    const modal = el('join-modal');
    if(!modal) return;
    el('modal-country').value = country || '';
    el('modal-nickname').value = '';
    modal.setAttribute('open', '');
    document.body.classList.add('modal-open');
    loadCitizensIntoModal(country);
  }
  function closeModal(){
    const modal = el('join-modal');
    if(!modal) return;
    modal.removeAttribute('open');
    document.body.classList.remove('modal-open');
  }
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });
  window.openModal = openModal;
  window.closeModal = closeModal;

  /**** Wallet + gating ****/
  const connectBtn = el('connectBtn');
  let provider = null, signer = null, userAddress = null;

  function shortAddr(a){ return a ? a.slice(0,6)+'‚Ä¶'+a.slice(-4) : 'Connect Wallet'; }

  async function withTimeout(promise, ms, label='operation'){
    let t; const timer = new Promise((_,rej)=> t=setTimeout(()=>rej(new Error(label+' timeout')), ms));
    try { return await Promise.race([promise, timer]); }
    finally { clearTimeout(t); }
  }
  function wireProviderEvents(raw){
    if (!raw?.on) return;
    raw.on('connect',    (info)=> console.log('[provider] connect', info));
    raw.on('disconnect', (err)=>  console.log('[provider] disconnect', err));
    raw.on('accountsChanged', (acc)=> console.log('[provider] accountsChanged', acc));
    raw.on('chainChanged',    (ch)=>  console.log('[provider] chainChanged', ch));
  }

  let connecting = false;
  async function connectWallet(){
    if (connecting) return;
    connecting = true;
    setBusy(true);

    try{
      if(!window.ethereum){
        toast('No wallet detected ‚Äî open in MetaMask/Trust/Crypto.com browser or install one');
        alert('No wallet detected. Open this site inside your wallet‚Äôs in-app browser for the smoothest connect.');
        return;
      }

      await withTimeout(window.ethereum.request({ method:'eth_requestAccounts' }), 30_000, 'eth_requestAccounts');

      provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
      signer   = provider.getSigner();
      wireProviderEvents(window.ethereum);

      await new Promise(r => setTimeout(r, 50));

      userAddress = await withTimeout(signer.getAddress(), 10_000, 'getAddress');
      window.userAddress = userAddress;

      await withTimeout(ensureChain(), 20_000, 'ensureChain');

      try{
        const message = `CROnation ‚Äî Verify Wallet
Address: ${userAddress}
Time: ${new Date().toISOString()}`;
        const signature = await withTimeout(signer.signMessage(message), 20_000, 'signMessage');
        localStorage.setItem('cronation_sig', signature);
      }catch(_e){ /* ignore sign cancel */ }

      connectBtn.textContent = shortAddr(userAddress);
      toast('Wallet connected ‚úÖ');
      restorePassportIfAny();
      restorePfpIfAny(userAddress);
      if (isAdmin(userAddress)) showAdminUI(true);

    }catch(err){
      console.error('[connectWallet] error:', err);
      if (String(err?.message||'').includes('timeout')) {
        toast('Connection timed out ‚Äî try again or open in your wallet browser');
      } else {
        toast('Connection cancelled or failed');
      }
      alert('Wallet connection was cancelled or failed.');
    }finally{
      setBusy(false);
      setTimeout(()=> (connecting=false), 600);
    }
  }

  async function ensureChain(){
    const desired = LAUNCH.token.chainIdHex;
    const current = await provider.send('eth_chainId', []);
    if(current?.toLowerCase() !== desired.toLowerCase()){
      try{
        await provider.send('wallet_switchEthereumChain', [{ chainId: desired }]);
      }catch(switchErr){
        if(switchErr.code === 4902){
          await provider.send('wallet_addEthereumChain', [{
            chainId: desired,
            chainName: 'Cronos Mainnet',
            nativeCurrency:{ name:'Cronos', symbol:'CRO', decimals:18 },
            rpcUrls:[LAUNCH.token.rpc],
            blockExplorerUrls:['https://cronoscan.com']
          }]);
        }else{ throw switchErr; }
      }
    }
  }

  async function hasRequiredTokens(address){
    try{
      const token = LAUNCH.token.address;
      if(!token || token === '0x0000000000000000000000000000000000000000') return false;

      const erc20 = new ethers.Contract(token, LAUNCH.token.abi, provider);
      const bal   = await erc20.balanceOf(address);
      const min   = ethers.utils.parseUnits(LAUNCH.token.minBalance, LAUNCH.token.decimals);

      const ok = bal.gte(min);
      if(!ok){ toast('Token gate: need ‚â• 1 $CRON8'); }
      return ok;
    }catch(e){
      console.error('Token-gate check failed:', e);
      toast('Token check failed');
      alert('Could not verify token balance. Check network and token address.');
      return false;
    }
  }

  if (connectBtn) connectBtn.addEventListener('click', connectWallet);

  
  /**** Firestore-backed mint ****/
  async function ensureCountryDoc(country){
  try{
    const ref = db.collection('countries').doc(country);
    const snap = await ref.get();
    if (!snap.exists){
      await ref.set({
        name: country,
        created: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  }catch(e){
    console.warn('ensureCountryDoc failed', e);
  }
}

  
  async function attemptMint(country, nick){
    if(!FLAGS.PASSPORT_MINT_ENABLED){ toast('Mint paused'); alert('Passport mint is temporarily paused.'); return; }
    if(FLAGS.REQUIRE_WALLET && !userAddress){ toast('Connect your wallet first'); alert('Please connect your wallet first.'); return; }

    try{
      setBusy(true);

      if(FLAGS.TOKEN_GATE){
        await ensureChain();
        const ok = await hasRequiredTokens(userAddress);
        if(!ok){ return; }
      }

      const addrKey = userAddress.toLowerCase();
      const docRef = db.collection('passports').doc(addrKey);
      const snap = await docRef.get();
      

      if(snap.exists){
        const p = snap.data();
        showPassport(p.country, p.nick, p.serial);
        hideJoinForm();
        toast('You already minted ‚Äî showing passport');
        alert('You already have a passport. Showing it now.');
        return;
      }

      const serial = Math.floor(Math.random()*999999).toString().padStart(6, '0');
      await docRef.set({
        address: userAddress,
        country, nick,
        serial,
        created: firebase.firestore.FieldValue.serverTimestamp()
      });

      await ensureCountryDoc(country);

      showPassport(country, nick, serial);
      hideJoinForm();
      hideCTAIfMinted();
      toast(`Minted! Passport #${serial}`);
    }catch(err){
      console.error(err);
      toast('Mint failed ‚Äî try again');
      alert('Mint failed. Please try again.');
    }finally{
      setBusy(false);
    }
  }

  function hideJoinForm(){
    const form = el('join-form');
    if(form) form.style.display = 'none';
  }

  (() => {
  const HOLDER_THRESHOLDS = [
    { tier: 3, min: '25000000' }, // 25,000,000
    { tier: 2, min: '5000000'  }, // 5,000,000
    { tier: 1, min: '1000000'  }, // 1,000,000
  ];

  const $ = (id) => document.getElementById(id);

  function parseUnits(v, d){
    if (window.ethers?.parseUnits) return window.ethers.parseUnits(v, d);
    return window.ethers.utils.parseUnits(v, d);
  }
  function formatUnits(v, d){
    if (window.ethers?.formatUnits) return window.ethers.formatUnits(v, d);
    return window.ethers.utils.formatUnits(v, d);
  }

  async function getProviderAndSigner(){
    const E = window.ethers;
    if (E?.BrowserProvider){
      const provider = new E.BrowserProvider(window.ethereum, 'any');
      const signer = await provider.getSigner();
      return { provider, signer };
    }
    const provider = new E.providers.Web3Provider(window.ethereum, 'any');
    const signer = provider.getSigner();
    return { provider, signer };
  }

  async function fetchCron8Balance(address){
    try{
      const { provider } = await getProviderAndSigner();
      const E = window.ethers;
      const abi = (typeof CFG !== 'undefined' ? CFG.token.abi : [{"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"}]);
      const tokenAddr = (typeof CFG !== 'undefined' ? CFG.token.address : '0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF');
      const c = new E.Contract(tokenAddr, abi, provider);
      const bal = await c.balanceOf(address);
      return bal;
    }catch(e){ return null; }
  }

  // --- safe >= for BigNumber (ethers v5) and bigint (ethers v6)
function gteBN(a, b){
  const isV5BN = (x) => !!(x && x._isBigNumber === true);

  // both bigint
  if (typeof a === 'bigint' && typeof b === 'bigint') return a >= b;
  // both v5 BigNumber
  if (isV5BN(a) && isV5BN(b)) return a.gte(b);
  // mixed: normalize to BigInt
  try {
    const A = BigInt(a.toString());
    const B = BigInt(b.toString());
    return A >= B;
  } catch { return false; }
}

// use this instead of your old detectTier
function detectTier(balance){
  try{
    const d = (typeof CFG !== 'undefined' ? CFG.token.decimals : 18);
    const thresholds = HOLDER_THRESHOLDS.map(t => ({ 
      tier: t.tier, 
      min: parseUnits(t.min, d) 
    }));

    for (const t of thresholds){
      if (gteBN(balance, t.min)) return t.tier;
    }
    return 0;
  }catch{ return 0; }
}

    window.__cron8Tier = 0;
    window.__cron8Balance = null;

  function applyHolderUX({ balance, tier }){
  const badge = $('holder-badge');
  const passport = $('passport');
  if (!badge || !passport) return;

  // update globals used by the PNG renderer
  window.__cron8Tier = tier || 0;
  window.__cron8Balance = balance || null;

  if (tier > 0){
    const title = tier === 3 ? 'üëë CRON8 Elite Diplomat'
                : tier === 2 ? '‚óÜ CRON8 Nation Builder'
                : '‚óà CRON8 Citizen Holder';
    badge.textContent = title;
    badge.style.display = 'inline-flex';
    passport.classList.add('holder-glow');
    passport.classList.remove('tier-1','tier-2','tier-3');
    passport.classList.add(`tier-${tier}`);
  } else {
    badge.style.display = 'none';
    passport.classList.remove('holder-glow','tier-1','tier-2','tier-3');
  }
}

  async function refreshHolderUX(){
    const addr = window.userAddress;
    if (!addr) return;
    const bal = await fetchCron8Balance(addr);
    if (!bal) return;
    const tier = detectTier(bal);
    applyHolderUX({ balance: bal, tier });
  }

  const connectBtn = $('connectBtn');
  if (connectBtn && !connectBtn._holderPatch){
    connectBtn._holderPatch = true;
    connectBtn.addEventListener('click', () => {
      setTimeout(refreshHolderUX, 800);
    });
  }

  const _origShowPassport = window.showPassport;
  window.showPassport = function(country, nick, serial){
    if (typeof _origShowPassport === 'function') _origShowPassport(country, nick, serial);
    setTimeout(refreshHolderUX, 300);
  };

  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(refreshHolderUX, 1200);
  });
})();

  /* === Flag mapping (strict/common names only) === */
  const ISO2 = {
    "United States of America":"us","United Kingdom":"gb","Canada":"ca","Mexico":"mx","Brazil":"br","Argentina":"ar","Chile":"cl","Colombia":"co",
    "Germany":"de","France":"fr","Spain":"es","Italy":"it","Portugal":"pt","Netherlands":"nl","Belgium":"be","Switzerland":"ch","Austria":"at","Poland":"pl",
    "Ireland":"ie","Greece":"gr","Sweden":"se","Norway":"no","Denmark":"dk","Finland":"fi","Turkey":"tr","Russia":"ru","Ukraine":"ua","Israel":"il",
    "Saudi Arabia":"sa","United Arab Emirates":"ae","India":"in","Pakistan":"pk","Bangladesh":"bd","Singapore":"sg","Malaysia":"my","Indonesia":"id",
    "Philippines":"ph","Vietnam":"vn","Thailand":"th","China":"cn","Japan":"jp","South Korea":"kr","Australia":"au","New Zealand":"nz","South Africa":"za",
    "Nigeria":"ng","Kenya":"ke","Brazil":"br"
  };
  const countryToISO2 = (name)=> (name && ISO2[name.trim()]) || null;

  function setPassportFlag(country){
    const layer = document.getElementById('passport-flag');
    if(!layer) return;
    const iso2 = countryToISO2(country);
    if (iso2){
      layer.style.backgroundImage = `url(https://flagcdn.com/w320/${iso2}.png)`;
      layer.style.filter = (country === "Germany" || country === "China")
        ? "brightness(1.25) contrast(1.1)"
        : "brightness(1.05) contrast(1.15)";
    }
  }

  function setPassportFlagIcon(country){
    const icon = document.getElementById('passport-flag-icon');
    if(!icon) return;
    const iso2 = countryToISO2(country);
    if (iso2){
      icon.src = `https://flagcdn.com/24x18/${iso2}.png`;
      icon.style.display = 'inline-block';
      icon.alt = country + ' flag';
    } else {
      icon.removeAttribute('src');
      icon.style.display = 'none';
      icon.alt = '';
    }
  }

  // --- PFP persistence (per-wallet, local only) ---
  function pfpKey(addr){ return addr ? `cronation_pfp:${addr.toLowerCase()}` : null; }
  function restorePfpIfAny(addr){
    try{
      const key = pfpKey(addr);
      if(!key) return;
      const dataUrl = localStorage.getItem(key);
      if(dataUrl){
        const img = el('passport-pfp');
        if(img) img.src = dataUrl;
      }
    }catch(_e){}
  }
  async function fileToDataURLResized(file, max=360, quality=0.86){
    const img = await new Promise((res,rej)=>{ const i = new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=URL.createObjectURL(file); });
    const scale = Math.min(1, max / Math.max(img.width, img.height));
    const w = Math.max(1, Math.round(img.width * scale));
    const h = Math.max(1, Math.round(img.height * scale));
    const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, w, h);
    const dataUrl = canvas.toDataURL('image/jpeg', quality);
    try{ URL.revokeObjectURL(img.src); }catch(_e){}
    return dataUrl;
  }

  /* === Passport rendering === */
  function setText(id, text){ const n = document.getElementById(id); if(n) n.textContent = text; }
  function setSrc(id, url){ const n = document.getElementById(id); if(n) n.src = url; }

  function showPassport(country, nick, serial){
    const card = document.getElementById('passport');
    if(!card) return;

    setText('passport-nick', nick);
    setText('passport-country', country);
    setText('passport-serial', '#'+serial);
    setText('passport-watermark', (country||'').toUpperCase().slice(0,22));
    setText('passport-address-chip', shortAddrFull(window.userAddress||userAddress||''));

    setPassportFlag(country);
    setPassportFlagIcon(country);

    // restore any saved pfp for this wallet
    restorePfpIfAny(window.userAddress || userAddress);

    // flash the activation glow
    card.classList.remove('activated');
    requestAnimationFrame(()=>{ card.classList.add('activated'); });

    card.style.display = 'grid';
    try{ card.scrollIntoView({behavior:'smooth', block:'center'}); }catch{}

    // Download PNG
    const dlBtn = document.getElementById('downloadBtn');
    if (dlBtn){
      dlBtn.onclick = async () => {
        try{
          setBusy?.(true);
          const dataUrl = await renderPassportPNGViaCanvas({
  country, nick, serial,
  address: (window.userAddress || ''),
  tier: (window.__cron8Tier || 0)
});
          const blob = await dataUrlToBlob(dataUrl);
          const filename = `cronation-passport-${serial}.png`;

          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

          if (navigator.canShare && navigator.canShare({
            files: [new File([blob], filename, { type: 'image/png' })]
          })) {
            await navigator.share({
              files: [new File([blob], filename, { type: 'image/png' })],
              title: 'CROnation Passport',
              text: 'One World. One CROnation.'
            });
            toast?.('Shared ‚Äî Save Image from the sheet');
            return;
          }

          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.rel = 'noopener';
          document.body.appendChild(a);
          a.click();
          a.remove();
          await sleep(1500);
          URL.revokeObjectURL(url);

          if (isIOS) {
            window.open(dataUrl, '_blank', 'noopener');
            toast?.('Opened image ‚Äî long-press and ‚ÄúSave Image‚Äù');
          } else {
            toast?.('PNG downloaded');
          }

        } catch (e){
          console.error(e);
          alert('Could not generate the image. Try again.');
        } finally {
          setBusy?.(false);
        }
      };
    }

    // show external controls + wire buttons (outside the passport card)
    const controls = document.getElementById('passport-controls');
    if (controls) controls.style.display = 'flex';

    const shareBtn = document.getElementById('shareBtn');
    if (shareBtn){
      shareBtn.onclick = () => shareToX({ country, nick, serial });
    }

    const pfpInput = document.getElementById('pfpInput');
    if (pfpInput && !pfpInput._wired){
      pfpInput._wired = true;
      let lastObjectUrl = null;
      const imgEl = document.getElementById('passport-pfp');

      pfpInput.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        if (!file.type.startsWith('image/')) { alert('Please choose an image.'); return; }
        if (file.size > 5 * 1024 * 1024) { alert('Image is too large (max 5MB).'); return; }

        // instant preview
        if (lastObjectUrl) { URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = null; }
        lastObjectUrl = URL.createObjectURL(file);
        if (imgEl) imgEl.src = lastObjectUrl;

        // persist compressed copy
        (async ()=>{
          try{
            const dataUrl = await fileToDataURLResized(file, 360, 0.86);
            const key = (window.userAddress || userAddress)
              ? `cronation_pfp:${(window.userAddress || userAddress).toLowerCase()}`
              : null;
            if(key) localStorage.setItem(key, dataUrl);
          }catch(_e){}
        })();
      });

      const cleanup = () => { if (lastObjectUrl){ URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = null; } };
      window.addEventListener('pagehide', cleanup, { once:true });
      window.addEventListener('beforeunload', cleanup, { once:true });
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'unloaded') cleanup();
      });
    }
  }

  
  // Stats + leaderboard
  function renderStats(){
    el('stat-countries').textContent = countryCounts.size;
    el('stat-citizens').textContent  = totalCitizens;
    let top = '‚Äî', max = -1;
    countryCounts.forEach((count, name)=>{ if(count > max){ max = count; top = name; } });
    el('stat-top').textContent = max > 0 ? `${top} (${max})` : '‚Äî';
  }

  async function renderLeaderboard(){
    const container = document.getElementById('leaderboard');
    if(!container) return;

    const entries = Array.from(countryCounts.entries()).sort((a,b)=> b[1]-a[1]);
    if(entries.length === 0){
      container.innerHTML = `<div class="muted" style="padding:10px 0;">No countries yet</div>`;
      return;
    }

    container.innerHTML = entries.map(([name, count], i) => `
      <details data-country="${name}">
        <summary>
          <span>${i+1}. ${name}</span>
          <span class="badge">${count}</span>
        </summary>
        <div class="panel"><div class="citizens-list" id="lb-${i}"><small class="muted">Tap to load‚Ä¶</small></div></div>
      </details>
    `).join('');

    container.querySelectorAll('details').forEach((det, idx)=>{
      det.addEventListener('toggle', async () => {
        if(!det.open) return;
        const name = det.getAttribute('data-country');
        const pane = document.getElementById(`lb-${idx}`);
        if(!pane) return;
        pane.innerHTML = `<small class="muted">Loading citizens‚Ä¶</small>`;
        try{
          const citizens = await fetchCitizens(name);
          renderCitizens(pane, citizens);
        }catch(e){
          console.error(e);
          pane.innerHTML = `<small class="muted">Could not load citizens.</small>`;
        }
      }, { passive:true });
    });
  }

  function renderSpotlight(name){
  // small stat tile
  const n = el('stat-spotlight');
  if (n) n.textContent = name || '‚Äî';

  // wide banner above the map
  const box  = el('spotlight-banner');
  const text = el('spotlight-text');
  const flag = el('spotlight-flag');

  if (!box || !text || !flag) return;

  if (!name){
    box.style.display = 'none';
    return;
  }

  text.textContent = `New country joined: ${name}!`;
  const iso2 = countryToISO2(name);
  if (iso2){
    flag.src = `https://flagcdn.com/24x18/${iso2}.png`;
    flag.alt = `${name} flag`;
  } else {
    flag.removeAttribute('src');
    flag.alt = '';
  }

  box.style.display = 'block';

  // üëá reset + retrigger the pulse every time
  box.classList.remove('pulse');
  void box.offsetWidth; // force reflow
  box.classList.add('pulse');
}

  function subscribeSpotlight(){
  try{
    // Primary: most recently created passport => its country
    db.collection('passports')
      .orderBy('created','desc')
      .limit(1)
      .onSnapshot((qs)=>{
        let name = null;
        qs.forEach(doc=>{
          const d = doc.data();
          if (d?.country) name = d.country;
        });
        if (name) {
          renderSpotlight(name);
          return;
        }

        // Fallback: countries collection (in case you keep it)
        db.collection('countries')
          .orderBy('created','desc')
          .limit(1)
          .get()
          .then(q2=>{
            let latest = null;
            q2.forEach(doc=>{ const d=doc.data(); if(d?.name) latest = d.name; });
            renderSpotlight(latest);
          })
          .catch(()=> renderSpotlight(null));
      }, (err)=> console.warn('spotlight sub err', err));
  }catch(e){
    console.warn('spotlight init failed', e);
  }
}


  // recolor after counts change
  countryLayers.forEach((_, name) => updateCountryStyle(name));

  async function restorePassportIfAny(){
    if(!userAddress) return;
    const snap = await db.collection('passports').doc(userAddress.toLowerCase()).get();
    if(snap.exists){
      const p = snap.data();
      showPassport(p.country, p.nick, p.serial);
      toast('Welcome back ‚Äî passport restored');
      hideJoinForm();
    }
  }

  // Real-time listener for stats/leaderboard
  db.collection('passports').onSnapshot((qs)=>{
    countryCounts.clear();
    totalCitizens = 0;
    qs.forEach(doc=>{
      const d = doc.data();
      if(!d || !d.country) return;
      countryCounts.set(d.country, (countryCounts.get(d.country)||0)+1);
      totalCitizens += 1;
    });
    renderStats();
    renderLeaderboard();
    countryLayers.forEach((_, name) => updateCountryStyle(name));
  });

  /* Start Country Spotlight subscription */
subscribeSpotlight();

  // Form submit
  el('join-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const country = el('country').value;
    if(!country){
      toast('Choose your country');
      return;
    }
    const nick = el('nickname').value || 'Anonymous';
    await attemptMint(country, nick);
  });

  // Modal -> mint
  function mintFromModal(){
    const country = el('modal-country').value;
    const nick = el('modal-nickname').value || 'Anonymous';
    attemptMint(country, nick);
    closeModal();
  }
  window.mintFromModal = mintFromModal;

  /**** Share to X ****/
  function shareToX({country, nick, serial}){
    const text = `üåç I just joined CROnation!\nPassport #${serial} ‚Äî ${nick} from ${country}\n\nOne World. One CROnation.\n\n @${LAUNCH.xHandle}`;
    const url = LAUNCH.siteUrl;
    const tags = 'Cronos,CROnation,CRON8,crofam';
    const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}&hashtags=${encodeURIComponent(tags)}`;
    toast('Opening ùïè to share‚Ä¶');
    window.open(shareUrl, '_blank','noopener');
  }

/* ========= Admin wiring (Pro Panel) ========= */
(function adminPanel(){
  const $ = (id)=>document.getElementById(id);
  const setLog = (msg) => { const el=$('ad-log'); if(!el) return; el.value += (msg+'\n'); el.scrollTop=el.scrollHeight; };
  const setStatus = (s) => { const el=$('ad-status'); if(el) el.textContent = 'Status: ' + s; };

  // Show/hide admin entry points
  function isAdmin(addr){
    if (!addr) return false;
    // hard-coded set from your existing code:
    const ADMIN_WALLETS = new Set([
      '0x69b6c23e59f9fd56fa3de3edf624d5c2c67c05f0'
    ]);
    return ADMIN_WALLETS.has(addr) || ADMIN_WALLETS.has((addr||'').toLowerCase());
  }
  function showAdminUI(on){
    const link = $('adminLink'); const panel = $('admin');
    if (link)  link.style.display  = on ? 'inline-block' : 'none';
    if (panel) panel.style.display = on ? 'block' : 'none';
  }
  // Expose (kept same names)
  window.isAdmin = isAdmin;
  window.showAdminUI = showAdminUI;

  // Token defaults
  $('ad-token')?.appendChild(document.createTextNode((LAUNCH.token.address)));
  $('ad-token-input')?.setAttribute('placeholder', LAUNCH.token.address);

  // Tabs
  const tabBtns = Array.from(document.querySelectorAll('button[data-tab]'));
  const tabPanels = {
    airdrop: $('tab-airdrop'),
    audit:   $('tab-audit'),
    tools:   $('tab-tools'),
    settings:$('tab-settings')
  };
  tabBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t = btn.getAttribute('data-tab');
      Object.entries(tabPanels).forEach(([k,p])=> p.style.display = (k===t?'block':'none'));
      if(t==='audit') refreshAudit();
    }, { passive:true });
  });
  // mark default tab
  tabBtns[0]?.classList.add('active');

  // Populate country filter whenever counts change
  function populateAdminCountryFilter(){
    const sel = $('ad-country'); if(!sel) return;
    const keys = Array.from((window.countryCounts||new Map()).keys()).sort();
    sel.innerHTML = `<option value="">All countries</option>` + keys.map(k=>`<option value="${k}">${k}</option>`).join('');
  }
  // call once at boot and again after stats update hook
  populateAdminCountryFilter();
  // Hook your existing live snapshot updater
  const _renderStats = window.renderStats;
  window.renderStats = function(){
    try { if (typeof _renderStats === 'function') _renderStats(); } finally { populateAdminCountryFilter(); }
  };

  /* ---------- Helpers ---------- */
  const E = window.ethers;
  const DECIMALS = LAUNCH.token.decimals || 18;
  const parseUnits = (v, d=DECIMALS) => E.utils.parseUnits(String(v), d);
  const formatUnits = (v, d=DECIMALS) => E.utils.formatUnits(v, d);
  const isAddr = (a)=> /^0x[a-fA-F0-9]{40}$/.test(a||'');

  async function ensureCronosChain(){
    if (!window.provider) return; // you already switch at connect
    const current = await provider.send('eth_chainId', []);
    if ((current||'').toLowerCase() !== (LAUNCH.token.chainIdHex||'').toLowerCase()){
      await provider.send('wallet_switchEthereumChain', [{ chainId: LAUNCH.token.chainIdHex }]);
    }
  }

  function normalizeToken(){
    const manual = ($('ad-token-input')?.value||'').trim();
    return manual || LAUNCH.token.address;
  }

  // Build recipient list from Firestore (filters)
  async function recipientsFromPassports({ country, limit }){
    let q = db.collection('passports').orderBy('created','asc');
    if (country) q = q.where('country','==',country);
    if (limit) q = q.limit(Number(limit));
    const rows = [];
    const qs = await q.get();
    qs.forEach(d=>{
      const x = d.data(); if (!x?.address) return;
      rows.push({ address:String(x.address).trim(), country:x.country||'', nick:x.nick||'' });
    });
    // de-dupe by address
    const seen=new Set(), out=[];
    for(const r of rows){ const k=r.address.toLowerCase(); if(!seen.has(k)){ seen.add(k); out.push(r); } }
    return out;
  }

  // Tier rules UI
  function addTierRow(country='', amount=''){
    const wrap = $('ad-tier-rows'); if(!wrap) return;
    const row = document.createElement('div');
    row.style.cssText='display:flex;gap:8px;align-items:center;padding:6px;border-bottom:1px solid var(--line);';
    row.innerHTML = `
      <input class="tier-country" placeholder="Country or * (else)" value="${country}" style="flex:2;padding:8px;">
      <input class="tier-amount"  placeholder="Amount" value="${amount}"  style="flex:1;padding:8px;">
      <button class="btn" type="button">Remove</button>
    `;
    row.querySelector('button')?.addEventListener('click', ()=> row.remove());
    wrap.appendChild(row);
  }
  $('ad-tier-add')?.addEventListener('click', ()=> addTierRow('', ''));

  // Mode switcher
  function showMode(mode){
    ['simple','tiered','csv'].forEach(m=>{
      document.querySelectorAll('.ad-mode-'+m).forEach(n=> n.style.display = (m===mode?'block':'none'));
    });
  }
  $('ad-mode')?.addEventListener('change', (e)=> showMode(e.target.value));
  showMode(($('ad-mode')?.value)||'simple');

  // CSV upload
  $('ad-csv-file')?.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    const txt = await file.text();
    const box = $('ad-csv'); if (box) box.value = (box.value?box.value.trim()+'\n':'') + txt.trim();
  });

  /* ---------- Plan builders ---------- */
  async function buildRecipientList({ mode, filters, csv, tierRules }){
    // returns: [ { address, amountHuman } ]
    if (mode === 'csv'){
      const rows = [];
      (csv||'').split(/\r?\n/).forEach(line=>{
        line = line.trim(); if(!line) return;
        const [addr, amt] = line.split(',').map(s=>s.trim());
        if (isAddr(addr) && !isNaN(Number(amt))) rows.push({ address: addr, amountHuman: amt });
      });
      return rows;
    }

    const base = await recipientsFromPassports(filters);
    if (mode === 'simple'){
      const amt = String(($('ad-amount')?.value||'0')).trim();
      return base.map(r=> ({ address: r.address, amountHuman: amt }));
    }

    if (mode === 'tiered'){
      const rules = (tierRules||[]).filter(r=>r.amount && (r.country || r.country==='*'));
      const elseRule = rules.find(r=> r.country==='*');
      return base.map(r=>{
        const hit = rules.find(t => t.country && t.country !== '*' && t.country === r.country);
        const amt = hit?.amount || elseRule?.amount || '0';
        return { address: r.address, amountHuman: amt };
      });
    }

    // simulated modes
    if (mode === 'erc721' || mode === 'erc1155'){
      // produce zero-amount recipients for dry-run visualization
      return base.map(r=> ({ address: r.address, amountHuman: '0' }));
    }

    return [];
  }

  function planToCSV(plan){
    return ['address,amount'].concat(plan.recipients.map(r=>`${r.address},${r.amountHuman}`)).join('\n');
  }
  function planAddresses(plan){
    return plan.recipients.map(r=>r.address).join('\n');
  }

  function keccakText(s){
    return E.utils.keccak256(E.utils.toUtf8Bytes(s||''));
  }

  function planHashOf(recipients){
    const body = recipients.map(r=>`${r.address}|${r.amountHuman}`).join('\n');
    return keccakText(body);
  }

  function currentCampaignId(plan){
    // token::mode::planHash::countryKey::hourBucket
    const token = normalizeToken().toLowerCase();
    const mode  = plan.mode;
    const hash  = plan.planHash.slice(0,10);
    const key   = (plan.filter?.country || 'all');
    const hour  = new Date();
    hour.setMinutes(0,0,0);
    return `${token}::${mode}::${hash}::${key}::${hour.toISOString()}`;
  }

  function estimateTotals(plan){
    // totals in human + BigNumber
    let totalHuman = 0;
    for(const r of plan.recipients) totalHuman += Number(r.amountHuman||0);
    const totalUnits = parseUnits(String(totalHuman || 0), DECIMALS);
    // rough gas estimate (transfer ~ 50k-80k): recipients * 80k by default
    const estGas = plan.recipients.length * 80000;
    return { totalAmountHuman: totalHuman, totalAmountUnits: totalUnits, estGas };
  }

  async function alreadyPaidSet(campaign){
    const set = new Set();
    try{
      const q = await db.collection('airdropsPaid').doc(campaign).get();
      const rows = q.exists ? (q.data()?.recipients || []) : [];
      rows.forEach(a=> set.add(String(a).toLowerCase()));
    }catch(_){}
    return set;
  }

  async function recordAudit(refId, partial){
    try{
      await db.collection('airdrops').doc(refId).set(partial, { merge:true });
    }catch(e){ console.warn('audit write failed', e); }
  }

  async function preview(){
    setStatus('Building plan‚Ä¶');
    setLog('‚Äî preview start ‚Äî');

    const mode = $('ad-mode')?.value || 'simple';
    const filters = {
      country: ($('ad-country')?.value||'').trim(),
      limit:   Number(($('ad-limit')?.value||'0')) || undefined
    };
    const tierRules = Array.from(document.querySelectorAll('#ad-tier-rows .tier-country')).map((_,i)=>null)
      .map((_,i)=>({
        country: (document.querySelectorAll('#ad-tier-rows .tier-country')[i].value||'').trim() || '*',
        amount:  (document.querySelectorAll('#ad-tier-rows .tier-amount')[i].value||'').trim()
      }));
    const csv = $('ad-csv')?.value || '';

    const recipients = await buildRecipientList({ mode, filters, csv, tierRules });
    if (!recipients.length){ setLog('No recipients.'); setStatus('No recipients'); return null; }

    // Uniqueness filter
    let uniqNote = '';
    if (($('ad-unique')?.checked)){
      const fakePlan = { mode, recipients, filter: { country: filters.country }, planHash: planHashOf(recipients) };
      const campaign = currentCampaignId(fakePlan);
      const paid = await alreadyPaidSet(campaign);
      const filtered = recipients.filter(r=> !paid.has(r.address.toLowerCase()));
      uniqNote = ` (unique: ${recipients.length-filtered.length} skipped)`;
      recipients.length = 0; recipients.push(...filtered);
    }

    const plan = {
      token: normalizeToken(),
      decimals: DECIMALS,
      mode,
      filter: { country: filters.country, limit: filters.limit||null },
      recipients,
      planHash: planHashOf(recipients)
    };
    const totals = estimateTotals(plan);
    setLog(`Recipients: ${recipients.length}${uniqNote}`);
    setLog(`Total (human): ${totals.totalAmountHuman}`);
    setLog(`Plan hash: ${plan.planHash}`);
    setStatus('Preview ready');
    return { plan, totals };
  }

  async function startAirdrop(){
    try{
      if (!window.userAddress){ toast('Connect admin wallet'); return; }
      if (!isAdmin(window.userAddress)){ toast('Not an admin wallet'); return; }
      await ensureCronosChain();

      const pv = await preview();
      if (!pv) return;
      const { plan, totals } = pv;

      const dry   = !!$('ad-dry')?.checked;
      const batch = Math.max(1, Number(($('ad-batch')?.value||'1')));
      const gasOv = Number(($('ad-gas')?.value||'0')) || undefined;

      // safety confirm
      const ask = ($('cfg-confirm')?.checked)!==false;
      if (ask){
        if (!confirm(`Proceed?\nMode: ${plan.mode}\nRecipients: ${plan.recipients.length}\nTotal (human): ${totals.totalAmountHuman}\nDry run: ${dry ? 'YES' : 'NO'}`)){
          return;
        }
      }

      setBusy?.(true);
      setStatus(dry ? 'Running (dry-run)' : 'Running');

      // ERC-20 transfer path (others simulated only)
      const tokenAddr = plan.token;
      const erc20 = new E.Contract(tokenAddr, [
        'function balanceOf(address) view returns (uint256)',
        'function transfer(address to, uint256 value) returns (bool)'
      ], (window.signer || window.provider.getSigner()));

      // preflight balance
      if (!dry){
        const bal = await erc20.balanceOf(window.userAddress);
        if (bal.lt(totals.totalAmountUnits)){
          setLog('‚úñ Insufficient token balance for total planned amount');
          setStatus('Error: insufficient balance');
          setBusy?.(false);
          return;
        }
      }

      // Write-ahead audit
      const auditRef = db.collection('airdrops').doc(); // auto id
      const campaign = currentCampaignId(plan);
      await recordAudit(auditRef.id, {
        created: firebase.firestore.FieldValue.serverTimestamp(),
        admin: window.userAddress,
        token: tokenAddr,
        decimals: DECIMALS,
        mode: plan.mode,
        campaign,
        filter: plan.filter,
        dry,
        batch,
        gasLimit: gasOv||null,
        plan: {
          totalRecipients: plan.recipients.length,
          totalAmount: totals.totalAmountHuman,
          recipients: plan.recipients,
          planHash: plan.planHash
        },
        status: 'running',
        successes: [],
        failures: []
      });

      // Execute
      const successes=[], failures=[];
      const sendOne = async ({ address, amountHuman })=>{
        if (dry){ setLog(`(dry) -> ${address} : ${amountHuman}`); return { hash: 'dry-run' }; }
        const amount = parseUnits(String(amountHuman||0), DECIMALS);
        const tx = await erc20.transfer(address, amount, gasOv ? { gasLimit: gasOv } : {});
        setLog(`‚Üí ${address}  tx: ${tx.hash}`);
        await tx.wait(1);
        return { hash: tx.hash };
      };

      for (let i=0;i<plan.recipients.length;i+=batch){
        const chunk = plan.recipients.slice(i, i+batch);
        for (const r of chunk){
          let tries=0, ok=false;
          while(tries<3 && !ok){
            try{
              const { hash } = await sendOne(r);
              successes.push({ address:r.address, tx: hash });
              ok=true;
              await recordAudit(auditRef.id, { successes });
            }catch(e){
              tries++;
              if (tries>=3){
                const err = String(e?.message||e);
                failures.push({ address:r.address, error: err });
                setLog(`‚úñ ${r.address}  ${err}`);
                await recordAudit(auditRef.id, { failures });
              }else{
                setLog(`‚Ä¶ retry ${tries} for ${r.address}`);
                await new Promise(res=>setTimeout(res, 1200));
              }
            }
          }
        }
      }

      // finalize
      await recordAudit(auditRef.id, {
        status: dry ? 'dry-complete' : 'complete',
        finished: firebase.firestore.FieldValue.serverTimestamp()
      });

      // mark paid set (for fast uniqueness next time)
      if (!dry && successes.length){
        await db.collection('airdropsPaid').doc(campaign).set({
          recipients: successes.map(s=>s.address.toLowerCase()), status:'success',
          updated: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      }

      setLog(`‚úî Done ‚Äî ${successes.length} success, ${failures.length} failed`);
      setStatus('Complete');
      toast('Airdrop finished');
    }catch(e){
      console.error(e);
      setLog('‚úñ ' + (e?.message||e));
      setStatus('Error');
    }finally{
      setBusy?.(false);
    }
  }

  // Wire buttons
  $('ad-preview')?.addEventListener('click', preview);
  $('ad-go')?.addEventListener('click', startAirdrop);
  $('ad-copy-plan')?.addEventListener('click', async ()=>{
    const pv = await preview(); if(!pv) return;
    await navigator.clipboard.writeText(planToCSV(pv.plan));
    toast('Plan CSV copied');
  });
  $('ad-copy-addrs')?.addEventListener('click', async ()=>{
    const pv = await preview(); if(!pv) return;
    await navigator.clipboard.writeText(planAddresses(pv.plan));
    toast('Addresses copied');
  });

  /* ---------- AUDIT TAB ---------- */
  function renderAuditTable(rows){
    if (!rows || !rows.length){ $('audit-table').innerHTML = `<div class="muted">No campaigns yet.</div>`; return; }
    const html = [
      `<table class="table">`,
      `<thead><tr><th>ID</th><th>Created</th><th>Admin</th><th>Token</th><th>Mode</th><th>Filter</th><th>Recips</th><th>Status</th></tr></thead><tbody>`
    ];
    rows.forEach(r=>{
      const f = r.filter ? (r.filter.country || 'all') : '‚Äî';
      const created = r.created?.toDate ? r.created.toDate().toLocaleString() : '‚Äî';
      html.push(`<tr data-id="${r._id}">
        <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r._id}</td>
        <td>${created}</td>
        <td>${(r.admin||'').slice(0,6)}‚Ä¶${(r.admin||'').slice(-4)}</td>
        <td style="max-width:100px;overflow:hidden;text-overflow:ellipsis;">${r.token}</td>
        <td>${r.mode}</td>
        <td>${f}</td>
        <td>${r.plan?.totalRecipients||0}</td>
        <td>${r.status}</td>
      </tr>`);
    });
    html.push(`</tbody></table>`);
    $('audit-table').innerHTML = html.join('');

    // row click -> detail
    $('audit-table').querySelectorAll('tr[data-id]').forEach(tr=>{
      tr.addEventListener('click', async ()=>{
        const id = tr.getAttribute('data-id');
        const doc = await db.collection('airdrops').doc(id).get();
        if (!doc.exists) return;
        const data = doc.data();
        const blob = new Blob([JSON.stringify(data,null,2)], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank','noopener');
        setTimeout(()=>URL.revokeObjectURL(url), 30000);
      }, { passive:true });
    });
  }

  async function refreshAudit(){
    const qs = await db.collection('airdrops').orderBy('created','desc').limit(50).get();
    const rows = [];
    qs.forEach(d=> rows.push({ _id: d.id, ...d.data() }));
    renderAuditTable(rows);
    window.__lastAudit = rows;
  }
  $('audit-refresh')?.addEventListener('click', refreshAudit);
  $('audit-export-csv')?.addEventListener('click', ()=>{
    const rows = window.__lastAudit||[];
    const header = ['id','created','admin','token','mode','country','recipients','success','fail','status'];
    const body = rows.map(r=>[
      r._id,
      r.created?.toDate ? r.created.toDate().toISOString() : '',
      r.admin||'',
      r.token||'',
      r.mode||'',
      r.filter?.country||'',
      r.plan?.totalRecipients||0,
      (r.successes||[]).length,
      (r.failures||[]).length,
      r.status||''
    ].join(','));
    const csv = [header.join(','), ...body].join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='airdrops.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  });
  $('audit-export-json')?.addEventListener('click', ()=>{
    const rows = window.__lastAudit||[];
    const blob = new Blob([JSON.stringify(rows,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='airdrops.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  });

  /* ---------- TOOLS ---------- */
  $('tool-balance-go')?.addEventListener('click', async ()=>{
    try{
      const addr = ($('tool-balance-addr')?.value||'').trim();
      if(!isAddr(addr)){ toast('Bad address'); return; }
      const token = normalizeToken();
      const c = new E.Contract(token, ['function balanceOf(address) view returns (uint256)'], (window.provider||new E.providers.Web3Provider(window.ethereum)));
      const bal = await c.balanceOf(addr);
      $('tool-balance-out').textContent = `${formatUnits(bal, DECIMALS)} tokens`;
    }catch(e){ $('tool-balance-out').textContent = 'Error'; }
  });

  $('tool-snapshot')?.addEventListener('click', async ()=>{
    const qs = await db.collection('passports').orderBy('created','asc').get();
    const head = 'address,country,nick,created';
    const lines = [];
    qs.forEach(d=>{
      const x=d.data();
      const t=x.created?.toDate ? x.created.toDate().toISOString() : '';
      lines.push([x.address||'', x.country||'', (x.nick||'').replace(/,/g,';'), t].join(','));
    });
    const csv = [head, ...lines].join('\n');
    const url = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    const a = document.createElement('a'); a.href=url; a.download='passports_snapshot.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  });

  $('tool-dedupe-go')?.addEventListener('click', ()=>{
    const raw = ($('tool-dedupe-in')?.value||'').trim().split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const set = new Set(); const out=[];
    for(const a of raw){ const k=a.toLowerCase(); if(isAddr(k) && !set.has(k)){ set.add(k); out.push(k); } }
    $('tool-dedupe-out').value = out.join('\n');
    $('tool-dedupe-count').textContent = `Unique: ${out.length}`;
  });

  /* ---------- SETTINGS ---------- */
  // load/save local mirrors
  (function loadSettings(){
    const cfg = JSON.parse(localStorage.getItem('cronation_admin_cfg')||'{}');
    if (cfg.batch) $('cfg-batch').value = cfg.batch;
    if (cfg.gas) $('cfg-gas').value = cfg.gas;
    if (typeof cfg.confirm === 'boolean') $('cfg-confirm').checked = cfg.confirm;
    if (cfg.admins) $('cfg-admins').value = (cfg.admins||[]).join('\n');
    // apply defaults to run options if empty
    if (!$('ad-batch').value) $('ad-batch').value = cfg.batch || 1;
    if (!$('ad-gas').value)   $('ad-gas').value   = cfg.gas   || '';
  })();

  function saveSettings(){
    const cfg = {
      batch: Math.max(1, Number(($('cfg-batch')?.value||'1'))),
      gas: Number(($('cfg-gas')?.value||'0')) || undefined,
      confirm: !!$('cfg-confirm')?.checked,
      admins: ($('cfg-admins')?.value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean)
    };
    localStorage.setItem('cronation_admin_cfg', JSON.stringify(cfg));
    toast('Settings saved');
  }
  $('cfg-batch')?.addEventListener('change', saveSettings);
  $('cfg-gas')?.addEventListener('change', saveSettings);
  $('cfg-confirm')?.addEventListener('change', saveSettings);
  $('cfg-admins-save')?.addEventListener('click', saveSettings);

  // Reveal admin UI after wallet connect
  setTimeout(()=>{ if (window.userAddress && isAdmin(window.userAddress)) showAdminUI(true); }, 1000);
  if (window.ethereum?.on){
    window.ethereum.on('accountsChanged', ()=> setTimeout(()=>{ if (window.userAddress && isAdmin(window.userAddress)) showAdminUI(true); }, 300));
  }
})();

  <!-- SECTION 7.F START: Boot sequence and closing -->
  /**** Page boot ****/
  (function boot(){
    const mintBtn = el('mintBtn');
    const modalMintBtn = el('modalMintBtn');
    if(!FLAGS.PASSPORT_MINT_ENABLED){
      if(mintBtn){ mintBtn.disabled = true; mintBtn.textContent = 'Mint Passport (disabled)'; }
      if(modalMintBtn){ modalMintBtn.disabled = true; modalMintBtn.textContent = 'Mint Passport (disabled)'; }
    }else{
      if(mintBtn){ mintBtn.disabled = false; mintBtn.textContent = 'Mint Passport'; }
      if(modalMintBtn){ modalMintBtn.disabled = false; modalMintBtn.textContent = 'Mint Passport'; }
    }
    el('year').textContent = new Date().getFullYear();
  })(); // end boot IIFE

});   // end DOMContentLoaded
  </script>

</body>
</html>
<!-- SECTION 7.F END -->
