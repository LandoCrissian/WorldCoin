<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CROnation ‚Äî Mega Jackpot Draw</title>

  <!-- Force dark BEFORE paint -->
  <script>document.documentElement.setAttribute('data-theme','dark');</script>

  <!-- Core libs -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#0b0d12" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{ --bg:#0b0d12; --text:#e5e7eb; --muted:#9ca3af; --line:#1f2937; --soft:#0f1219; --accent:#3b82f6; --accent-600:#2563eb; --gold:#f59e0b; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",sans-serif; color:var(--text); background:var(--bg); line-height:1.5; }

    header{ padding-top: calc(env(safe-area-inset-top, 0px)); position:sticky; top:0; backdrop-filter:saturate(120%) blur(8px); background: color-mix(in srgb, var(--bg) 86%, transparent); border-bottom:1px solid var(--line); z-index:10; }
    html { scroll-padding-top: 80px; }
    .container{ width:min(1120px, 92vw); margin-inline:auto; padding:24px 0 72px; }
    .nav{ width:min(1120px, 92vw); margin-inline:auto; display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 0; }
    .brand{ display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; font-weight:800; }
    .brand img{ width:32px; height:32px; border-radius:50%; }
    .links{ display:flex; gap:16px; }
    .nav a.link{ text-decoration:none; color:var(--muted); font-weight:500; margin:0 10px; }
    .actions{ display:flex; align-items:center; gap:10px; }
    .btn{ appearance:none; border:1px solid var(--line); background:var(--bg); color:var(--text); padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; transition:.12s; min-height:44px; }
    .btn:hover{ transform: translateY(-1px); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; transform:none; }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#fff; }
    .btn.primary:hover{ background:var(--accent-600); }
    .btn.ghost{ background:transparent; }
    a.btn { display:inline-flex; align-items:center; justify-content:center; text-decoration:none; }

    #connect, #disconnect, #buyBtn { min-width:160px; text-align:center; }
    .hamburger{ width:44px; height:44px; display:none; margin-left:8px; border:1px solid var(--line); border-radius:10px; background:var(--soft); cursor:pointer; align-items:center; justify-content:center; gap:4px; }
    .hamburger span{ display:block; width:18px; height:2px; background:var(--text); border-radius:2px; }
    .mobile-menu{ display:none; position:fixed; left:0; right:0; top:64px; background:var(--bg); border-top:1px solid var(--line); border-bottom:1px solid var(--line); padding:10px 12px; z-index:9; }
    .mobile-menu a.link{ display:block; padding:12px; color:var(--text); text-decoration:none; }
    .mobile-menu a.link + a.link{ border-top:1px solid var(--line); }
    .mobile-menu.open{ display:block; }
    .hamburger[aria-expanded="true"] span:nth-child(2){ opacity:0; }
    .hamburger[aria-expanded="true"] span:nth-child(1){ transform: translateY(6px) rotate(45deg); }
    .hamburger[aria-expanded="true"] span:nth-child(3){ transform: translateY(-6px) rotate(-45deg); }
    @media (max-width: 720px){ #buyBtn{ display:none; } .hamburger{ display:inline-flex; } }
    @media (max-width:640px){ .links{ display:none; } .actions{ margin-left:auto; gap:8px; } .actions .btn{ padding:10px 12px; } }
    @media (min-width:641px){ .mobile-menu{ display:none !important; } }

    .page{ width:min(1120px,92vw); margin-inline:auto; padding:20px 0 72px; }
    .grid{ display:grid; gap:16px; }
    .two{ grid-template-columns:1.2fr 1fr; } @media (max-width:960px){ .two{ grid-template-columns:1fr; } }
    .card{ border:1px solid var(--line); border-radius:14px; background:var(--soft); box-shadow:0 2px 16px rgba(0,0,0,.08); }
    .card .body{ padding:16px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted{ color:var(--muted); }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.03); font-size:12px; font-weight:700; white-space:nowrap; }
    .h1{ font-size:clamp(28px,3vw+12px,40px); font-weight:800; margin:10px 0; letter-spacing:-0.01em; }
    .tickets{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,monospace; }

    .numbers{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .n{ min-width:44px; height:44px; padding:0 12px; border-radius:999px; border:1px solid var(--line); display:grid; place-items:center; cursor:pointer; background:transparent; color:var(--text); box-shadow:0 0 0 1px var(--line) inset; }
    .n.on{ background:var(--accent); border-color:var(--accent); color:#fff; box-shadow:none; }
    .n.mega{ border-color:#b45309; }
    .n.mega.on{ background:#f59e0b; color:#111827; border-color:#f59e0b; }

    .notice{ background:color-mix(in srgb, var(--accent) 12%, var(--bg) 88%); border-bottom:1px solid var(--line); color:var(--text); }
    .notice .wrap{ width:min(1120px,92vw); margin:0 auto; padding:10px 0; font-weight:600; display:flex; gap:10px; align-items:center; justify-content:center; text-align:center; }

    .toast { position:fixed;left:50%;bottom:18px;transform:translateX(-50%); background:#0f1219;border:1px solid var(--line);color:var(--text); padding:10px 12px;border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,.35); z-index:6000;opacity:0;pointer-events:none;transition:.2s; }
    .toast.show { opacity:1;pointer-events:auto; }
    .loader { position:fixed;inset:0;background:rgba(0,0,0,.45); display:none;align-items:center;justify-content:center; z-index:5500; }
    .loader[aria-busy="true"] { display:flex; }
    .loader .dot { width:8px;height:8px;border-radius:50%;background:#fff; margin:0 4px;animation:ld 1s infinite; }
    .loader .dot:nth-child(2){animation-delay:.15s;} .loader .dot:nth-child(3){animation-delay:.3s;}
    @keyframes ld { 0%,80%,100%{opacity:.2;transform:scale(.8);} 40%{opacity:1;transform:scale(1);} }

    #debug{ display:none; }
    #debug pre{ white-space:pre-wrap; word-break:break-word; background:#0e1117; border:1px solid var(--line); padding:12px; border-radius:10px; }
    .warn{ color:#fde68a } .err{ color:#fca5a5 }

    /* Mobile polish */
    html, body, .page { overflow-x: hidden; }
    @supports(padding:max(0px)) { .page { padding-bottom: max(72px, env(safe-area-inset-bottom)); } }

    @media (max-width: 400px){
      .container, .page { width: 94vw; }
      .card { border-radius: 12px; }
      .card .body { padding: 12px; }
      .h1 { font-size: clamp(24px, 5.6vw + 8px, 30px); }
      .row { gap: 6px; }
      .pill { font-size: 11.5px; padding: 4px 8px; }
      #status-pill, #countdown, #addr-pill, #chain-pill, #tier-pill, #free-pill { flex: 0 1 auto; }
      .btn { min-height: 44px; padding: 10px 12px; }
      input[type="number"] { height: 44px; }
      .numbers { display: grid; grid-auto-rows: 44px; gap: 8px; }
      #prim.numbers { grid-template-columns: repeat(7, 1fr); }
      #mega.numbers { grid-template-columns: repeat(6, 1fr); }
      .n { min-width: 0; width: 100%; height: 44px; padding: 0; border-radius: 999px; font-weight: 700; touch-action: manipulation; }
      #picker .muted { margin: 6px 0 4px !important; }
      aside .row { flex-direction: row; }
      @supports (display:grid){ aside .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; } }
      #qty { width: 100% !important; }
      .tickets { grid-template-columns: 1fr; gap: 8px; }
      .brand { gap: 8px; }
      .brand img { width: 28px; height: 28px; }
    }
    @media (max-width: 340px){
      #prim.numbers { grid-template-columns: repeat(6, 1fr); }
      #mega.numbers { grid-template-columns: repeat(5, 1fr); }
    }

    /* countdown pulse */
    @keyframes pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(59,130,246,.35); } 50% { box-shadow: 0 0 0 6px rgba(59,130,246,0); } }
    #countdown { animation: pulse 2.4s infinite; }

    /* --- Fix Admin dropdown layout jump on mobile --- */
#admin .mono {
  white-space: normal;
  overflow-wrap: anywhere;   /* break long hashes */
  word-break: break-word;
}

#admin .mono span {
  display: inline-block;
  max-width: 100%;
  overflow-wrap: anywhere;
  word-break: break-word;
}

#admin .body {
  overflow-x: hidden;         /* never allow horizontal push */
}

/* Make the hash + Copy button layout stable */
#admin .mono .btn {
  margin-top: 6px;
  flex-shrink: 0;
}

@media (max-width: 640px){
  #admin .row { flex-wrap: wrap; }
  #admin input[type="number"],
  #admin input[type="datetime-local"] { width: 100% !important; }
}
  </style>
</head>
<body>

  <!-- Global toast + loader -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="loader" class="loader" aria-hidden="true">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>

  <!-- Header -->
  <header>
    <nav class="nav" aria-label="Primary">
      <a class="brand" href="/#top" aria-label="CROnation home">
        <img src="https://raw.githubusercontent.com/LandoCrissian/WorldCoin/refs/heads/main/8DAEE2BE-F14F-4EB2-A993-E8EFE1EC2E35.png" alt="CROnation logo"/>
        <b>CROnation</b>
      </a>

      <div class="links">
        <a class="link" href="/#map-section">Map</a>
        <a class="link" href="/#leaderboard-card">Leaderboard</a>
        <a class="link" href="/#about">About</a>
        <a class="link" href="/draw.html">Draw</a>
        <a class="link" href="https://x.com/cronation8" target="_blank" rel="noopener">ùïè</a>
        <a class="link" href="https://t.me/CRONationOfficial" target="_blank" rel="noopener">Telegram</a>
        <a class="link" href="https://www.puush.fun/coin/0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF" target="_blank" rel="noopener">Buy CRON8</a>
        <a class="link" id="adminLink" href="#admin" style="display:none;">Admin</a>
      </div>

      <div class="actions">
        <button id="connect" class="btn ghost">Connect Wallet</button>
        <button id="disconnect" class="btn ghost" style="display:none;">Disconnect</button>
        <a id="buyBtn" class="btn ghost" href="https://www.puush.fun/coin/0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF" target="_blank" rel="noopener">Buy CRON8</a>
        <button class="hamburger" id="hamburger" aria-label="Menu" aria-controls="mobile-menu" aria-expanded="false">
          <span></span><span></span><span></span>
        </button>
      </div>

      <div class="mobile-menu" id="mobile-menu" role="menu">
        <a class="link" role="menuitem" href="/#map-section">Map</a>
        <a class="link" role="menuitem" href="/#leaderboard-card">Leaderboard</a>
        <a class="link" role="menuitem" href="/#about">About</a>
        <a class="link" role="menuitem" href="/draw.html">Draw</a>
        <a class="link" role="menuitem" href="https://x.com/cronation8" target="_blank" rel="noopener">Follow on ùïè</a>
        <a class="link" role="menuitem" href="https://t.me/CRONationOfficial" target="_blank" rel="noopener">Join on Telegram</a>
        <a class="link" role="menuitem" href="https://www.puush.fun/coin/0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF" target="_blank" rel="noopener">Buy CRON8</a>
      </div>
    </nav>
  </header>

  <!-- Status notice -->
  <div class="notice" role="status" aria-live="polite">
    <div class="wrap">
      <span id="platformBanner"><b>Mega Jackpot Draw.</b></span>
      <span><small>Connect your wallet, claim free entries (by CRON8 tier), or buy more with CRO.</small></span>
    </div>
  </div>

  <!-- Page -->
  <main class="page grid" style="margin-top:14px;">

    <!-- Jackpot header -->
    <section id="jackpot-card" class="card">
      <div class="body">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="muted">Mega Jackpot</div>
            <div class="h1"><span id="jp-cron8">0</span> CRON8 + <span id="jp-cro">0</span> CRO</div>
            <div class="muted">
              Closes: <span id="jp-closes">‚Äî</span>
              ‚Ä¢ <span class="pill" id="status-pill">‚Äî</span>
              ‚Ä¢ <span class="pill" id="countdown">‚Äî</span>
            </div>
          </div>
          <div class="row">
            <span class="pill" id="addr-pill">‚Äî</span>
            <span class="pill" id="chain-pill">‚Äî</span>
            <span class="pill" id="tier-pill">Tier: ‚Äî</span>
            <span class="pill" id="free-pill">Free left: ‚Äî</span>
          </div>
        </div>
        <div id="envWarn" class="muted warn" style="margin-top:6px;display:none;"></div>
      </div>
    </section>

    <!-- Player Card (shown after connect/passport) -->
    <section id="player-card" class="card" style="display:none;">
      <div class="body" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <img id="pc-avatar" alt="" width="44" height="44"
             style="border-radius:10px;border:1px solid var(--line);background:#0f1219;object-fit:cover;">
        <div style="min-width:180px;">
          <div style="font-weight:700;">Passport <span id="pc-serial">#000000</span></div>
          <div class="muted" id="pc-nick-country">‚Äî</div>
        </div>
        <span class="pill" id="pc-tier">Tier: ‚Äî</span>
        <span class="pill" id="pc-balance">CRON8: ‚Äî</span>
        <span class="pill" id="pc-free">Free left: ‚Äî</span>
      </div>
    </section>

    <!-- App actions (shown after connect) -->
    <section id="app" class="grid two" style="display:none;">
      <div id="claim-card" class="card">
        <div class="body">
          <h3>Claim your free entries</h3>
          <p class="muted">Passport holders get free tickets per draw based on CRON8 tier.</p>
          <div class="row" style="margin:10px 0;">
            <button class="btn primary" id="quick-claim">Claim ‚Äî Quick Pick</button>
            <button class="btn" id="manual-claim">Claim ‚Äî Manual</button>
          </div>
          <div id="picker" style="margin-top:6px;">
            <div class="muted" style="margin-bottom:6px;">Pick 5 numbers (1‚Äì69)</div>
            <div id="prim" class="numbers"></div>
            <div class="muted" style="margin:10px 0 6px;">Mega (1‚Äì26)</div>
            <div id="mega" class="numbers"></div>
          </div>
        </div>
      </div>

      <aside id="buy-card" class="card">
        <div class="body">
          <h3>Buy more</h3>
          <p class="muted">Tickets are <b>15 CRO</b> each. v1 sends CRO to the dev wallet.</p>
          <div class="row">
            <input id="qty" type="number" min="1" value="1" style="width:96px;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b0d12;color:var(--text)" />
            <button class="btn primary" id="buy">Buy</button>
          </div>
          <small class="muted">Anti-spam: 3s cooldown.</small>
        </div>
      </aside>
    </section>

    <section id="tickets-card" class="card">
      <div class="body">
        <h3>Your tickets</h3>
        <div id="tickets" class="tickets"></div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="card" style="display:none;">
      <div class="body">
        <div class="row" style="justify-content:space-between;">
          <h3>Admin ‚Äî Draw Controls</h3>
          <span class="pill" id="admin-status">status: ‚Äî</span>
        </div>

        <div class="row" style="margin:8px 0;">
          <label class="row">Close at:
            <input id="admin-closeAt" type="datetime-local" style="margin-left:8px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#0b0d12;color:var(--text)">
          </label>
          <label class="row">Start pots ‚Äî CRON8:
            <input id="admin-cron8" type="number" min="0" value="0" style="width:120px;margin-left:8px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#0b0d12;color:var(--text)">
          </label>
          <label class="row">CRO:
            <input id="admin-cro" type="number" min="0" value="0" style="width:120px;margin-left:8px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#0b0d12;color:var(--text)">
          </label>
        </div>

        <div class="row" style="margin:8px 0;">
          <button class="btn primary" id="admin-open">Open Draw</button>
          <button class="btn" id="admin-lock">Lock Entries</button>
          <button class="btn" id="admin-reveal">Reveal Winners</button>
          <button class="btn ghost" id="admin-refresh">Refresh</button>
        </div>

        <div class="row" style="margin:10px 0; gap:18px;">
          <label class="row" style="gap:8px;">
            <input type="checkbox" id="flag-pause-all"> Pause ALL
          </label>
          <label class="row" style="gap:8px;">
            <input type="checkbox" id="flag-pause-claims"> Pause free claims
          </label>
          <label class="row" style="gap:8px;">
            <input type="checkbox" id="flag-pause-buys"> Pause purchases
          </label>
          <button class="btn" id="admin-save-flags">Save Flags</button>
        </div>

        <div class="mono muted" style="margin-top:6px;">
          Commit: <span id="admin-commit">‚Äî</span> <button class="btn" id="copy-commit">Copy</button><br/>
          Reveal seed: <span id="admin-reveal-seed">‚Äî</span> <button class="btn" id="copy-reveal">Copy</button>
        </div>
      </div>
    </section>

    <!-- Debug -->
    <section id="debug" class="card" aria-live="polite" style="display:none;">
      <div class="body">
        <div class="row" style="justify-content:space-between;gap:12px;">
          <h3>Debug</h3>
          <button id="toggleDebug" class="btn ghost" aria-pressed="true">Hide debug</button>
        </div>
        <pre id="dbg"></pre>
      </div>
    </section>

    <!-- Disclaimer modal -->
    <div id="dlg" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:7000;">
      <div style="width:min(680px,92vw);background:#0f1219;border:1px solid #1f2937;border-radius:14px;padding:16px;">
        <h3 style="margin:0 0 8px;">Before you continue</h3>
        <div style="max-height:38vh;overflow:auto;color:#9ca3af;font-size:14px;line-height:1.5;">
          <p><b>Play at your own risk.</b> This game is experimental community software. Do not spend what you can‚Äôt afford to lose.</p>
          <p><b>Odds:</b> each ticket picks 5 numbers (1‚Äì69) and 1 mega (1‚Äì26); jackpot odds ‚âà 1 in 292,201,338.</p>
          <p>By clicking ‚ÄúI agree & sign‚Äù, you acknowledge these terms and consent to the app storing a proof of your consent (signature hash) tied to your wallet.</p>
        </div>
        <div style="display:flex;gap:10px;margin-top:14px;justify-content:flex-end;">
          <button id="dlg-cancel" class="btn">Cancel</button>
          <button id="dlg-agree"  class="btn primary">I agree & sign</button>
        </div>
      </div>
    </div>

  </main>

  <footer class="footer">
    <div class="container">
      <div style="display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
        <small>¬© <span id="year"></span> CROnation. Built for Cronos ‚Äî community-first.</small>
        <small class="muted">This platform is evolving ‚Äî join us as we build CROnation together.</small>
      </div>
    </div>
  </footer>

  <script>
/* =========================================
   CROnation ‚Äî Mega Jackpot Draw (v1.1)
   - Subcollection tickets: draws/{drawId}/tickets
   - Real-time listeners (draw + my tickets)
   - Canonical statuses: OPEN ‚Üí LOCKED ‚Üí REVEALED ‚Üí PAID
   - Split admin: Open, Lock, Reveal
   - Number ranges hydrated from config/app
   - Stats bumps (per draw + lifetime)
   - Share-to-X PNG scaffold
   ========================================= */

/* ========= CONSTANTS ========= */
const CRONOS = { chainIdHex:'0x19', rpc:'https://evm.cronos.org' };
const DRAW_ID = 'current';
const DEV_WALLET = '0x69b6c23E59F9Fd56fa3DE3edF624D5c2C67c05F0';
const ADMIN_WALLET = DEV_WALLET;

const LS_CONNECTED      = 'cronation_connected_v1';
const SESSION_CONNECTED = 'cronation_session_connected_v1';

const CRON8 = {
  address:'0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF',
  decimals:18,
  abi:[{"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"}]
};

// Default ranges; may be overridden by config/app.numberRange
let NUM = { primMin:1, primMax:69, primPick:5, megaMin:1, megaMax:26 };

const TIER = [
  { tier:3, min:'25000000' },
  { tier:2, min:'5000000'  },
  { tier:1, min:'1000000'  },
  { tier:0, min:'0' }
];
const FREE = { 0:0, 1:1, 2:3, 3:5 };

const CONFIG_DOC = { col: 'config', doc: 'app' };
const FLAGS_DEFAULT = { pauseAll:false, pauseClaims:false, pauseBuys:false };
let __flags = { ...FLAGS_DEFAULT };

let __closeAt=0;
let __drawStatus = 'OPEN';

/* ========= Firebase ========= */
firebase.initializeApp({
  apiKey:"AIzaSyAJ0eSdO1mEYdbVNVRbiB0BlOwn6UEjT10",
  authDomain:"cronation-6058b.firebaseapp.com",
  projectId:"cronation-6058b",
  storageBucket:"cronation-6058b.appspot.com",
  appId:"1:303748855698:web:b03fe82e7314ab371bf34b"
});
const db = firebase.firestore();

/* ========= Helpers ========= */
const $  = (id)=>document.getElementById(id);
const setText=(id,v)=>{ const n=$(id); if(n) n.textContent=v; };
const short=(a)=> a ? a.slice(0,6)+'‚Ä¶'+a.slice(-4) : '';
const toast = (msg)=>{ const t=$('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(t._h); t._h=setTimeout(()=>t.classList.remove('show'),2600); };
const setBusy = (on)=>{ const l=$('loader'); l.setAttribute('aria-busy',on?'true':'false'); l.setAttribute('aria-hidden',on?'false':'true'); };
const compactNumber=(n,max=0)=>{ try{ return Number(n).toLocaleString(undefined, { maximumFractionDigits:max }); }catch{ return String(n); } };
setText('year', new Date().getFullYear());

// Debug buffer
const DBG = [];
function dbg(...a){ try{ const line=a.map(x=>(typeof x==='object'?JSON.stringify(x):String(x))).join(' '); DBG.push(line); const pre=$('dbg'); if(pre) pre.textContent=DBG.join('\n'); }catch(_){} }

/* ========= HTTPS guard ========= */
(function httpsGuard(){
  const ok = (location.protocol === 'https:' || location.hostname === 'localhost');
  if(!ok){ const w=$('envWarn'); if (w){ w.style.display='block'; w.textContent='Serve over HTTPS or localhost. Wallets may refuse http:// or file://.'; } dbg('WARN non-https', location.href); }
})();

/* ========= Mobile menu ========= */
(function mobileMenu(){
  const btn = $('hamburger'); const menu = $('mobile-menu'); if(!btn || !menu) return;
  const close = () => { menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); };
  const open  = () => { menu.classList.add('open');  btn.setAttribute('aria-expanded','true'); };
  btn.addEventListener('click', () => { (btn.getAttribute('aria-expanded') === 'true') ? close() : open(); });
  menu.querySelectorAll('a').forEach(a => a.addEventListener('click', close));
  window.addEventListener('keydown', e => { if(e.key === 'Escape') close(); }, { passive:true });
  window.addEventListener('click', e => { if(!menu.contains(e.target) && e.target !== btn && !btn.contains(e.target)) close(); }, { passive:true });
  window.addEventListener('resize', () => { if(window.innerWidth > 640) close(); }, { passive:true });
})();

/* ========= Wallet detection ========= */
function detectCDC(p){ return !!(p && (p.isDeFiWallet || p.isDeficonnectProvider || p.isCryptoCom)); }
function pickInjectedProvider(){
  const eth = window.ethereum;
  if (!eth) return window.deficonnectProvider || null;
  if (Array.isArray(eth.providers) && eth.providers.length){
    const mm  = eth.providers.find(p=>p && p.isMetaMask);
    const cdc = eth.providers.find(p=>detectCDC(p));
    return mm || cdc || eth.providers[0];
  }
  return eth;
}
function waitForEthereum(timeout=1800){
  return new Promise((resolve)=>{
    if (window.ethereum) return resolve(window.ethereum);
    const t=setTimeout(()=>resolve(window.ethereum||null),timeout);
    window.addEventListener('ethereum#initialized',()=>{ clearTimeout(t); resolve(window.ethereum||null); },{once:true});
  });
}

/* ========= Agreement ========= */
const AGREEMENTS = { col:'agreements' };
function agreementRef(addr){ return db.collection(AGREEMENTS.col).doc(addr); }
function disclaimerMessage(addr){
  const ts = new Date().toISOString();
  return [
    'CROnation ‚Äî Play at your own risk.',
    'Odds ~1 in 292,201,338 per ticket.',
    'No guarantees. Experimental community software.',
    `Wallet: ${addr}`,
    `Timestamp: ${ts}`,
    'By signing you acknowledge the above.'
  ].join('\n');
}

/* ========= Modal focus trap ========= */
let __dlgPrevFocus = null;
const __dlgSelectors = 'button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])';
function showDialog(){
  const dlg = $('dlg'); if(!dlg) return;
  __dlgPrevFocus = document.activeElement;
  dlg.style.display = 'flex';
  document.body.classList.add('modal-open');
  const foci = Array.from(dlg.querySelectorAll(__dlgSelectors)).filter(el=>!el.disabled && el.offsetParent!==null);
  const first = foci[0], last = foci[foci.length-1];
  (first||dlg).focus();
  dlg.onkeydown = (e)=>{
    if(e.key === 'Escape'){ e.preventDefault(); $('dlg-cancel').click(); }
    if(e.key === 'Tab' && foci.length){
      if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
  };
}
function hideDialog(){
  const dlg = $('dlg'); if(!dlg) return;
  dlg.style.display = 'none';
  document.body.classList.remove('modal-open');
  dlg.onkeydown = null;
  if (__dlgPrevFocus && __dlgPrevFocus.focus) __dlgPrevFocus.focus();
}
$('dlg-cancel')?.addEventListener('click', ()=> hideDialog());

/* ========= App state ========= */
let injected=null, provider=null, signer=null, addr=null;

/* ========= Firestore doc/col helpers ========= */
const DRAW_DOC = () => db.collection('draws').doc(DRAW_ID);
const TICKETS_COL = () => DRAW_DOC().collection('tickets');

/* ========= Flags & UI gating ========= */
function applyFlagsToUI(){
  const pausedMsg =
    __flags.pauseAll ? 'Platform paused' :
    __flags.pauseBuys ? 'Purchases paused' :
    __flags.pauseClaims ? 'Free claims paused' : '';
  const banner = $('platformBanner');
  if (banner){ banner.innerHTML = pausedMsg ? `<b>${pausedMsg}.</b>` : '<b>Mega Jackpot Draw.</b>'; }

  const canClaim = !__flags.pauseAll && !__flags.pauseClaims && (__drawStatus==='OPEN');
  const canBuy   = !__flags.pauseAll && !__flags.pauseBuys   && (__drawStatus==='OPEN');

  const qc=$('quick-claim'), mc=$('manual-claim'), buy=$('buy');
  if(qc){ qc.disabled = !canClaim; qc.title = canClaim?'':'Claims disabled'; }
  if(mc){ mc.disabled = !canClaim; mc.title = canClaim?'':'Claims disabled'; }
  if(buy){ buy.disabled = !canBuy; buy.title = canBuy?'':'Purchases disabled'; }
}

/* ========= Hydrate number ranges ========= */
async function hydrateNumberRanges() {
  try {
    const snap = await db.collection(CONFIG_DOC.col).doc(CONFIG_DOC.doc).get();
    const data = snap.exists ? snap.data() : {};
    const nr = data.numberRange || null;
    __flags = { ...FLAGS_DEFAULT, ...(data.flags || {}) };
    if (nr) {
      NUM = {
        primMin: nr.primaryMin ?? NUM.primMin,
        primMax: nr.primaryMax ?? NUM.primMax,
        primPick: nr.primaryPick ?? NUM.primPick,
        megaMin: nr.megaMin ?? NUM.megaMin,
        megaMax: nr.megaMax ?? NUM.megaMax
      };
    }
    renderPicker();
    applyFlagsToUI();
  } catch(e){ dbg('hydrateNumberRanges', e?.message); }
}

/* ========= Draw listener ========= */
let __drawUnsub = null;
let __closeAtMs = 0;
function startDrawListener(){
  if (__drawUnsub) return;
  __drawUnsub = DRAW_DOC().onSnapshot(snap=>{
    const d = snap.exists ? snap.data() : null;
    if (!d){
      setText('status-pill','‚Äî');
      setText('jp-closes','‚Äî');
      setText('jp-cron8','0'); setText('jp-cro','0');
      __drawStatus = 'OPEN';
      __closeAtMs = 0;
      applyFlagsToUI();
      return;
    }
    __drawStatus = d.status || 'OPEN';
    setText('status-pill', __drawStatus);
    setText('jp-closes', d.closeAt ? new Date(d.closeAt).toLocaleString() : '‚Äî');
    setText('jp-cron8', (d.pots?.cron8||0).toLocaleString());
    setText('jp-cro',   (d.pots?.cro||0).toLocaleString());
    __closeAtMs = d.closeAt || 0;

    if (d.status === 'REVEALED' && d.winning){
      const banner = $('platformBanner');
      const w = d.winning;
      if (banner){
        banner.innerHTML = `<b>Winning Numbers:</b> ${w.primary?.join(' - ') || '‚Äî'}  ‚Ä¢  ‚òÖ ${w.mega ?? '‚Äî'}`;
      }
    } else {
      const banner = $('platformBanner');
      if (banner) banner.innerHTML = '<b>Mega Jackpot Draw.</b>';
    }

    applyFlagsToUI();
  }, err=>dbg('draw onSnapshot', err?.message||err));
}

/* ========= Countdown ========= */
setInterval(()=>{
  if(!__closeAtMs){ setText('countdown','‚Äî'); return; }
  let s = Math.floor((__closeAtMs - Date.now())/1000);
  if (s <= 0){
    s = 0;
    if (__drawStatus === 'OPEN'){
      __drawStatus = 'LOCKED';
      setText('status-pill','LOCKED');
      applyFlagsToUI();
    }
  }
  const d = Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60), sec=s%60;
  setText('countdown', `${d}d ${h}h ${m}m ${sec}s`);
}, 1000);

/* ========= Passport / Player Card ========= */
async function fetchPassport(addrLc){
  const snap = await db.collection('passports').doc(addrLc).get();
  return snap.exists ? snap.data() : null;
}
async function cron8Balance(a){
  const read = new ethers.providers.JsonRpcProvider(CRONOS.rpc);
  const erc20 = new ethers.Contract(CRON8.address, CRON8.abi, read);
  return await erc20.balanceOf(a);
}
async function loadPlayerCard(addrLc){
  const box = $('player-card');
  if (!box || !addrLc) return;

  const passport = await fetchPassport(addrLc);
  if (!passport){ box.style.display = 'none'; return; }

  let balFmt = '0', tier = 0;
  try{
    const b = await cron8Balance(addrLc);
    balFmt   = ethers.utils.formatUnits(b, CRON8.decimals);
    for (const t of TIER){
      if (ethers.BigNumber.from(b).gte(ethers.utils.parseUnits(t.min, CRON8.decimals))){ tier = t.tier; break; }
    }
  }catch(_){}

  const claimed = await TICKETS_COL()
    .where('owner','==',addrLc).where('isFree','==',true)
    .get().then(q=>q.size).catch(()=>0);
  const freeLeft = Math.max(0, (FREE[tier] ?? 0) - claimed);

  const nick = (passport.nick || 'Citizen');
  const country = (passport.country || '‚Äî');
  const serial = String(passport.serial||'000000').padStart(6,'0');

  setText('pc-serial', '#'+serial);
  setText('pc-nick-country', `${nick} ‚Äî ${country}`);
  setText('pc-tier', 'Tier: ' + (tier ? `T${tier}` : 'None'));
  setText('pc-balance', 'CRON8: ' + compactNumber(balFmt, 0));
  setText('pc-free', 'Free left: ' + freeLeft);

  const avatar = $('pc-avatar');
  if (avatar){
    const key = `cronation_pfp:${addrLc}`;
    const dataUrl = localStorage.getItem(key);
    avatar.src = dataUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
    avatar.alt = `${nick} avatar`;
  }

  box.style.display = 'block';
}

/* ========= Picker ========= */
const primSel = new Set();
let mega = NUM.megaMin;
function renderPicker(){
  const prim = $('prim'), m = $('mega');
  if(!prim || !m) return;
  prim.innerHTML = ''; m.innerHTML='';
  for(let n=NUM.primMin; n<=NUM.primMax; n++){
    const b = document.createElement('button');
    b.type='button'; b.className='n' + (primSel.has(n)?' on':''); b.textContent=String(n);
    b.onclick = ()=>{ if(primSel.has(n)) primSel.delete(n); else if(primSel.size<NUM.primPick) primSel.add(n); renderPicker(); };
    prim.appendChild(b);
  }
  for(let n=NUM.megaMin; n<=NUM.megaMax; n++){
    const b = document.createElement('button');
    b.type='button'; b.className='n mega' + (mega===n?' on':''); b.textContent=String(n);
    b.onclick = ()=>{ mega = n; renderPicker(); };
    m.appendChild(b);
  }
}
renderPicker();

/* ========= Flags live sub ========= */
db.collection(CONFIG_DOC.col).doc(CONFIG_DOC.doc).onSnapshot(snap => {
  const data = snap.exists ? snap.data() : {};
  __flags = { ...FLAGS_DEFAULT, ...(data.flags || {}) };
  applyFlagsToUI();
}, (err)=>dbg('flags subscribe error', err?.message||err));

/* ========= Wallet flow ========= */
function wireProviderEvents(){
  if(!injected || injected._wired_draw) return;
  injected._wired_draw = true;
  injected.on?.('accountsChanged', async (acc)=>{
    if (acc && acc[0]){
      addr = acc[0].toLowerCase();
      setText('addr-pill', short(addr));
      await afterConnect();
    } else {
      doDisconnectUI();
    }
  });
  injected.on?.('chainChanged', (cid)=>{ location.reload(); });
}

async function ensureCronos(){
  if(!injected) return;
  const desired = CRONOS.chainIdHex;
  let current;
  try{ current = await injected.request({method:'eth_chainId'}); }catch(e){}
  if ((current||'').toLowerCase() === desired) return;
  try{
    await injected.request({ method:'wallet_switchEthereumChain', params:[{ chainId:desired }]});
  }catch(e){
    if (e?.code === 4902){
      await injected.request({ method:'wallet_addEthereumChain', params:[{
        chainId:desired, chainName:'Cronos Mainnet',
        nativeCurrency:{ name:'Cronos', symbol:'CRO', decimals:18 },
        rpcUrls:[CRONOS.rpc], blockExplorerUrls:['https://cronoscan.com']
      }]});
    } else { throw e; }
  }
}

// Require & record 1-time disclaimer BEFORE app
async function requireAgreementOnce(){
  const exists = await agreementRef(addr).get().then(s=>s.exists).catch(()=>false);
  if (exists) return true;

  return await new Promise((resolve)=>{
    showDialog();
    const agree  = $('dlg-agree');
    const cancel = $('dlg-cancel');
    const onAgree = async ()=>{
      agree.disabled = true;
      try{
        const msg = disclaimerMessage(addr);
        const sig = await signer.signMessage(msg);
        await agreementRef(addr).set({
          wallet: addr,
          message: msg,
          signature: sig,
          ua: navigator.userAgent || '',
          signedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        hideDialog();
        resolve(true);
      }catch(e){
        agree.disabled = false;
        hideDialog();
        resolve(false);
      }
    };
    const onCancel = ()=>{ hideDialog(); resolve(false); };
    agree.onclick = onAgree; cancel.onclick = onCancel;
  });
}

async function connect(){
  setBusy(true);
  try{
    await waitForEthereum();
    injected = pickInjectedProvider();
    if(!injected){ alert('No wallet detected. Open this page inside MetaMask or Crypto.com DeFi Wallet.'); return; }

    try { await injected.request({ method:'eth_requestAccounts' }); }
    catch(e){ alert('Connection cancelled.'); return; }

    provider = new ethers.providers.Web3Provider(injected, 'any');
    signer   = provider.getSigner();
    try { addr = (await signer.getAddress()).toLowerCase(); }
    catch(e){ alert('Could not read wallet address.'); return; }

    try { await ensureCronos(); } catch(_) {}

    const ok = await requireAgreementOnce();
    if(!ok){ toast('Signature required to continue.'); return; }

    // Remember choice (persistent + per-tab)
    localStorage.setItem(LS_CONNECTED, '1');
    sessionStorage.setItem(SESSION_CONNECTED, '1');

    const chainId = await injected.request({method:'eth_chainId'}).catch(()=>null);
    setText('addr-pill', short(addr));
    setText('chain-pill', (chainId?.toLowerCase()==='0x19') ? 'Cronos (25)' : `Chain ${chainId||'?'}`);

    $('connect').style.display='none';
    $('disconnect').style.display='inline-block';

    wireProviderEvents();
    await afterConnect();

  }catch(e){
    alert('Wallet connect failed ‚Äî try in your wallet‚Äôs in-app browser.');
  }finally{
    setBusy(false);
  }
}

function doDisconnectUI(){
  addr = null; provider=null; signer=null;
  $('app').style.display='none';
  $('admin').style.display='none';
  $('connect').style.display='inline-block';
  $('disconnect').style.display='none';
  setText('addr-pill','‚Äî'); setText('tier-pill','Tier: ‚Äî'); setText('free-pill','Free left: ‚Äî');
  const pc = $('player-card'); if (pc) pc.style.display='none';
}

function disconnect(){
  localStorage.removeItem(LS_CONNECTED);
  try { sessionStorage.removeItem(SESSION_CONNECTED); } catch(_){}
  doDisconnectUI();
  toast('Disconnected.');
}

/* ========= Tier + free left ========= */
const parseUnits=(v,d)=> ethers.utils.parseUnits(v,d);

async function refreshTier(){
  if(!addr) return;
  try{
    const bal = await cron8Balance(addr);
    let tier = 0;
    for (const t of TIER){
      if (ethers.BigNumber.from(bal).gte(parseUnits(t.min, CRON8.decimals))){ tier = t.tier; break; }
    }
    setText('tier-pill', 'Tier: ' + (tier===0?'None':('T'+tier)));

    const claimed = await TICKETS_COL()
      .where('owner','==',addr).where('isFree','==',true).get()
      .then(q=>q.size).catch(()=>0);
    const left = Math.max(0, (FREE[tier] ?? 0) - claimed);
    setText('free-pill', 'Free left: ' + left);
    window.__freeLeft = left;
  }catch(e){ setText('tier-pill', 'Tier: ‚Äî'); setText('free-pill', 'Free left: ‚Äî'); }
}

async function restorePassport(){
  try{ if(!addr) return; await db.collection('passports').doc(addr).get(); }catch(e){}
}

/* ========= Quick pick helper ========= */
function quickPick(){
  const nums = new Set();
  while(nums.size < NUM.primPick){
    nums.add(Math.floor(Math.random()*(NUM.primMax-NUM.primMin+1))+NUM.primMin);
  }
  return { primary:[...nums].sort((a,b)=>a-b), mega: Math.floor(Math.random()*(NUM.megaMax-NUM.megaMin+1))+NUM.megaMin };
}

/* ========= Stats bump (client v1) ========= */
async function bumpStatsFor(owner){
  const perDraw = db.collection('stats').doc(DRAW_ID).collection('players').doc(owner);
  const lifetime= db.collection('stats').doc('lifetime').collection('players').doc(owner);
  await db.runTransaction(async tx=>{
    const a = await tx.get(perDraw);
    const b = await tx.get(lifetime);
    tx.set(perDraw, { count: (a.exists ? (a.data().count||0) : 0) + 1 }, { merge:true });
    tx.set(lifetime, { count: (b.exists ? (b.data().count||0) : 0) + 1 }, { merge:true });
    const d = await tx.get(DRAW_DOC());
    const prev = d.exists ? (d.data().entriesCount||0) : 0;
    tx.set(DRAW_DOC(), { entriesCount: prev + 1 }, { merge:true });
  });
}

/* ========= Claim & Buy ========= */
async function nudgeCronos(){
  const onCronos = (await injected.request({method:'eth_chainId'}).catch(()=>null))?.toLowerCase() === '0x19';
  if (!onCronos){
    const go = confirm('You are not on Cronos. Switch now?');
    if (go){ try { await ensureCronos(); } catch(_){} }
  }
}

$('quick-claim')?.addEventListener('click', async ()=>{
  if(!addr) return alert('Connect wallet first');

  const agreed = await agreementRef(addr).get().then(s=>s.exists).catch(()=>false);
  if(!agreed){ alert('Please accept the disclaimer first.'); $('connect').click(); return; }

  if (__flags.pauseAll || __flags.pauseClaims) return alert('Free claims are currently paused.');
  if (__drawStatus !== 'OPEN') return alert('This draw is not open.');
  if((window.__freeLeft ?? 0) <= 0) return alert('No free entries left for your tier');

  await nudgeCronos();

  try{
  const picks = quickPick();
  await TICKETS_COL().add({
    owner: addr, primary: picks.primary, mega: picks.mega, isFree:true,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  // stats are best-effort; don't fail the claim if they error
  try { await bumpStatsFor(addr); } catch (sErr) { dbg('stats bump', sErr?.message || sErr); }

  // refresh UI
  await refreshTier();
  await loadPlayerCard(addr);
  toast('Free ticket claimed ‚úÖ');
}catch(e){
  const msg = e?.message || e?.code || 'Unknown error';
  alert('Claim failed: ' + msg);
  dbg('claim quick error', msg);
}
});
}

$('manual-claim')?.addEventListener('click', async ()=>{
  if(!addr) return alert('Connect wallet first');

  const agreed = await agreementRef(addr).get().then(s=>s.exists).catch(()=>false);
  if(!agreed){ alert('Please accept the disclaimer first.'); $('connect').click(); return; }

  if (__flags.pauseAll || __flags.pauseClaims) return alert('Free claims are currently paused.');
  if (__drawStatus !== 'OPEN') return alert('This draw is not open.');
  if(primSel.size !== NUM.primPick) return alert(`Pick exactly ${NUM.primPick} numbers`);
  if((window.__freeLeft ?? 0) <= 0) return alert('No free entries left for your tier');

  await nudgeCronos();

  try{
  const picks = { primary:[...primSel].sort((a,b)=>a-b), mega };
  await TICKETS_COL().add({
    owner: addr, primary: picks.primary, mega: picks.mega, isFree:true,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  }

  // best-effort stats
  try { await bumpStatsFor(addr); } catch (sErr) { dbg('stats bump', sErr?.message || sErr); }

  primSel.clear(); mega = NUM.megaMin; renderPicker();
  await refreshTier(); await loadPlayerCard(addr);
  toast('Free ticket claimed ‚úÖ');
}catch(e){
  const msg = e?.message || e?.code || 'Unknown error';
  alert('Claim failed: ' + msg);
  dbg('claim manual error', msg);
}
});

let __nextBuyAt = 0;
$('buy')?.addEventListener('click', async ()=>{
  if(!addr) return alert('Connect wallet first');

  const agreed = await agreementRef(addr).get().then(s=>s.exists).catch(()=>false);
  if(!agreed){ alert('Please accept the disclaimer first.'); $('connect').click(); return; }

  if (__flags.pauseAll || __flags.pauseBuys) return alert('Purchases are currently paused.');
  if (__drawStatus !== 'OPEN') return alert('This draw is not open.');

  const now=Date.now(); if(now<__nextBuyAt) return alert(`Please wait ${Math.ceil((__nextBuyAt-now)/1000)}s‚Ä¶`);
  await nudgeCronos();

  try{
    const rawQty = parseInt(($('qty').value||'1'),10);
    const qty = Math.min(100, Math.max(1, isFinite(rawQty)?rawQty:1));
    const total=ethers.utils.parseEther(String(15 * qty));
    await injected.request({ method:'eth_sendTransaction', params:[{ from:addr, to:DEV_WALLET, value: total.toHexString() }]});
    __nextBuyAt=Date.now()+3000;

    const batch=[];
    for(let i=0;i<qty;i++){
      const picks=quickPick();
      batch.push(TICKETS_COL().add({
        owner: addr, primary: picks.primary, mega: picks.mega, isFree:false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(()=>bumpStatsFor(addr)));
    }
    batch.push(db.collection('ledger').add({
      drawId:DRAW_ID, type:'purchase', wallet:addr, qty, priceCro:15, to:DEV_WALLET,
      at: firebase.firestore.FieldValue.serverTimestamp()
    }));
    await Promise.all(batch);
    await loadPlayerCard(addr);
    alert(`Purchased ${qty} ticket(s). CRO sent.`);
  }catch(e){
  const msg = e?.message || e?.code || 'Payment cancelled or failed.';
  alert(msg);
  dbg('buy error', msg);
}
});

/* ========= My Tickets ‚Äî real-time ========= */
let __mineUnsub = null;
function startMyTicketsListener(){
  if (!addr){ $('tickets').innerHTML = '<div class="muted">Connect wallet to see your tickets.</div>'; return; }
  if (__mineUnsub) { __mineUnsub(); __mineUnsub = null; }
  const q = TICKETS_COL().where('owner','==',addr).orderBy('createdAt','desc');
__mineUnsub = q.onSnapshot(snap=>{
  const out=[];
  snap.forEach(doc=>{
    const d=doc.data();
    out.push(`<div class="card"><div class="body">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <div>
          <div class="muted">${d.isFree?'Free':'Paid'}</div>
          <div class="mono" style="margin-top:4px;">${(d.primary||[]).join(' - ')}  |  ‚òÖ ${d.mega}</div>
        </div>
        <button class="btn ghost" data-share="${doc.id}">Share</button>
      </div>
    </div></div>`);
  });
  const box = $('tickets');
  box.innerHTML = out.join('') || '<div class="muted">No tickets yet.</div>';
  // wire share buttons
  box.querySelectorAll('button[data-share]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute('data-share');
      const snap = await TICKETS_COL().doc(id).get();
      if (snap.exists) await shareTicketToX(snap.data());
    };
  });
}, async (err)=>{
  // Clearer message + fallback while index builds
  const code = err?.code || '';
  dbg('tickets onSnapshot error', code, err?.message || err);
  if (code === 'failed-precondition') {
    // Fallback: show unsorted list via one-time get()
    try{
      const snap = await TICKETS_COL().where('owner','==',addr).get();
      const out=[];
      snap.forEach(doc=>{
        const d=doc.data();
        out.push(`<div class="card"><div class="body">
          <div class="muted">${d.isFree?'Free':'Paid'}</div>
          <div class="mono" style="margin-top:4px;">${(d.primary||[]).join(' - ')}  |  ‚òÖ ${d.mega}</div>
        </div></div>`);
      });
      $('tickets').innerHTML = (out.join('') || '<div class="muted">No tickets yet.</div>') +
        '<div class="muted" style="margin-top:6px;">(Showing unsorted while index builds)</div>';
    }catch(_){
      $('tickets').innerHTML = '<div class="muted">Tickets unavailable. Index building‚Ä¶</div>';
    }
  } else {
    $('tickets').innerHTML = '<div class="muted">Could not load tickets.</div>';
  }
});

/* ========= Admin (commit‚Äìreveal + flags) ========= */
const SEED_KEY='cronation_draw_seed';
const toHex=(buf)=>Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
async function sha256Hex(str){ const enc=new TextEncoder(); const buf=await crypto.subtle.digest('SHA-256', enc.encode(str)); return '0x'+toHex(buf); }
function randomSeed(){ const b=new Uint8Array(32); crypto.getRandomValues(b); return '0x'+Array.from(b).map(x=>x.toString(16).padStart(2,'0')).join(''); }

async function adminRefresh(){
  try{
    const snap=await DRAW_DOC().get();
    if(!snap.exists){ setText('admin-status','status: (no draw)'); setText('admin-commit','‚Äî'); setText('admin-reveal-seed','‚Äî'); await adminLoadFlags(); applyFlagsToUI(); return; }
    const d=snap.data();
    __drawStatus = d.status || 'OPEN';
    setText('admin-status',`status: ${__drawStatus}`);
    setText('admin-commit',d.commitHash||'‚Äî');
    setText('admin-reveal-seed',d.revealSeed||localStorage.getItem(SEED_KEY)||'‚Äî');
    if(d.closeAt) $('admin-closeAt').value=new Date(d.closeAt).toISOString().slice(0,16);
    $('admin-cron8').value=d.pots?.cron8 ?? 0; $('admin-cro').value=d.pots?.cro ?? 0;
    await adminLoadFlags();
    applyFlagsToUI();
  }catch(e){}
}

async function adminLoadFlags(){
  try{
    const snap = await db.collection(CONFIG_DOC.col).doc(CONFIG_DOC.doc).get();
    const data = snap.exists ? snap.data() : {};
    const f = { ...FLAGS_DEFAULT, ...(data.flags || {}) };
    $('flag-pause-all').checked   = !!f.pauseAll;
    $('flag-pause-claims').checked= !!f.pauseClaims;
    $('flag-pause-buys').checked  = !!f.pauseBuys;
  }catch(e){}
}

$('admin-save-flags')?.addEventListener('click', async ()=>{
  try{
    const f = {
      pauseAll:   $('flag-pause-all').checked,
      pauseClaims:$('flag-pause-claims').checked,
      pauseBuys:  $('flag-pause-buys').checked,
    };
    await db.collection(CONFIG_DOC.col).doc(CONFIG_DOC.doc).set({ flags: f }, { merge:true });
    toast('Flags saved ‚úÖ');
  }catch(e){ alert('Saving flags failed.'); }
});

$('admin-open')?.addEventListener('click', async ()=>{
  try{
    const seed=randomSeed(); const commit=await sha256Hex(seed); localStorage.setItem(SEED_KEY,seed);
    const closeAtStr=$('admin-closeAt').value; const closeAt=closeAtStr? new Date(closeAtStr).getTime() : (Date.now()+7*864e5);
    const cron8=parseFloat($('admin-cron8').value||'0')||0; const cro=parseFloat($('admin-cro').value||'0')||0;
    await DRAW_DOC().set({
      status:'OPEN',
      commitHash:commit,
      closeAt,
      pots:{cron8,cro},
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      winning: firebase.firestore.FieldValue.delete(),
      winners: firebase.firestore.FieldValue.delete()
    },{merge:true});
    await adminRefresh(); toast('Draw opened ‚úÖ');
  }catch(e){ alert('Open failed.'); }
});

$('admin-lock')?.addEventListener('click', async ()=>{
  try{
    await DRAW_DOC().set({ status:'LOCKED' }, { merge:true });
    await adminRefresh(); toast('Entries locked ‚úÖ');
  }catch(e){ alert('Lock failed.'); }
});

$('admin-reveal')?.addEventListener('click', async ()=>{
  try{
    const primStr = prompt(`Enter ${NUM.primPick} primary numbers (comma-separated):`, '');
    const megaStr = prompt('Enter MEGA number:', '');
    if (!primStr || !megaStr) return;
    const primary = primStr.split(',').map(s=>parseInt(s.trim(),10)).filter(n=>Number.isFinite(n));
    const megaNum    = parseInt(megaStr,10);

    if (primary.length !== NUM.primPick) return alert(`Must supply exactly ${NUM.primPick} numbers`);
    if (primary.some(n=>n<NUM.primMin || n>NUM.primMax)) return alert('Primary out of range');
    if (megaNum<NUM.megaMin || megaNum>NUM.megaMax) return alert('Mega out of range');

    await DRAW_DOC().set({
      status: 'REVEALED',
      winning: { primary: primary.sort((a,b)=>a-b), mega: megaNum },
      revealAt: Date.now()
    }, { merge:true });

    // Compute winners (jackpot only in v1)
    const shots = await TICKETS_COL().get();
    const winners=[];
    shots.forEach(doc=>{
      const t = doc.data();
      const matches = (t.primary||[]).filter(n=>primary.includes(n)).length + (t.mega===megaNum ? 1 : 0);
      if (matches === NUM.primPick+1){
        winners.push({ wallet: t.owner, matches, prizeCro: 0, prizeCron8: 0, paid:false, txHash:'' });
      }
    });
    await DRAW_DOC().set({ winners }, { merge:true });
    await adminRefresh(); toast(`Revealed ‚úÖ ‚Äî Winners: ${winners.length}`);
  }catch(e){ alert('Reveal failed.'); }
});

$('admin-refresh')?.addEventListener('click', adminRefresh);
$('copy-commit')?.addEventListener('click', ()=> navigator.clipboard.writeText(($('admin-commit').textContent||'').trim()));
$('copy-reveal')?.addEventListener('click', ()=> navigator.clipboard.writeText(($('admin-reveal-seed').textContent||'').trim()));

/* ========= Share to ùïè (PNG scaffold) ========= */
async function renderTicketPNG(ticket){
  const c=document.createElement('canvas'); c.width=800; c.height=418;
  const g=c.getContext('2d');
  g.fillStyle='#0b0d12'; g.fillRect(0,0,c.width,c.height);
  g.fillStyle='#fff'; g.font='700 28px Inter, sans-serif';
  g.fillText('CROnation ‚Äî Mega Jackpot', 24, 48);
  g.font='600 22px Inter, sans-serif';
  g.fillText(`Wallet: ${short(ticket.owner||'')}`, 24, 88);
  g.fillText(`Numbers: ${(ticket.primary||[]).join(' - ')}  |  ‚òÖ ${ticket.mega}`, 24, 126);
  g.fillStyle='#9ca3af'; g.font='16px Inter, sans-serif';
  g.fillText(new Date().toLocaleString(), 24, 162);
  return new Promise(res=>c.toBlob(b=>res(b),'image/png',0.95));
}
async function shareTicketToX(ticket){
  const blob = await renderTicketPNG(ticket);
  const file = new File([blob], 'cronation-ticket.png', { type:'image/png' });
  try{
    if (navigator.canShare && navigator.canShare({ files:[file] })){
      await navigator.share({ files:[file], text:'My CROnation ticket ‚Äî let‚Äôs go! #CROFam' });
    } else {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='cronation-ticket.png'; a.click();
      const intent = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent('My CROnation ticket ‚Äî let‚Äôs go! #CROFam https://cronation.netlify.app/draw.html');
      window.open(intent,'_blank');
    }
  }catch(_){}
}

/* ========= Boot ========= */
(async ()=>{
  // hydrate ranges + flags
  await hydrateNumberRanges();

  // draw listener
  startDrawListener();

  await waitForEthereum();
  injected = pickInjectedProvider();

  // Bind connect/disconnect
  const btnConnect = $('connect');
  const btnDisc = $('disconnect');
  if(btnConnect && !btnConnect.__bound){ btnConnect.addEventListener('click', (ev)=>{ ev.preventDefault(); connect(); }, { passive:false }); btnConnect.__bound = true; }
  if(btnDisc && !btnDisc.__bound){ btnDisc.addEventListener('click', (ev)=>{ ev.preventDefault(); disconnect(); }, { passive:false }); btnDisc.__bound = true; }

  if (injected){
    try{
      const chainId = await injected.request({method:'eth_chainId'}).catch(()=>null);
      setText('chain-pill', (chainId?.toLowerCase()==='0x19') ? 'Cronos (25)' : `Chain ${chainId||'‚Äî'}`);

      const acc = await injected.request({ method:'eth_accounts' }).catch(()=>[]);
      const shouldRestore =
        localStorage.getItem(LS_CONNECTED) === '1' &&
        sessionStorage.getItem(SESSION_CONNECTED) === '1';

      if (shouldRestore && acc && acc[0]){
        provider = new ethers.providers.Web3Provider(injected, 'any');
        signer   = provider.getSigner();
        addr     = acc[0].toLowerCase();
        setText('addr-pill', short(addr));
        $('connect').style.display='none';
        $('disconnect').style.display='inline-block';
        wireProviderEvents();
        await afterConnect();
      } else {
        setText('addr-pill','‚Äî');
      }
    }catch(e){}
  }

  // Debug toggle
  (function initDebug(){
    const on = new URLSearchParams(location.search).get('debug') === '1';
    const box = $('debug');
    if (box) box.style.display = on ? 'block' : 'none';
    const btn = $('toggleDebug');
    if(btn){
      btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      btn.onclick = () => {
        const open = $('debug').style.display !== 'block';
        $('debug').style.display = open ? 'block' : 'none';
        btn.setAttribute('aria-pressed', open ? 'true':'false');
        btn.textContent = open ? 'Hide debug' : 'Show debug';
      };
    }
  })();

  // Collapse Admin into an accordion on mobile
  (function collapseAdminOnMobile(){
    const admin = document.getElementById('admin');
    if (!admin) return;
    if (window.matchMedia('(max-width: 640px)').matches && !admin.__wrapped) {
      admin.__wrapped = true;
      const details = document.createElement('details');
      const summary = document.createElement('summary');
      summary.textContent = 'Admin ‚Äî Draw Controls';
      summary.style.cursor = 'pointer';
      summary.style.fontWeight = '700';
      summary.style.padding = '10px 12px';
      summary.style.borderBottom = '1px solid var(--line)';
      const body = admin.querySelector('.body');
      admin.replaceChildren(details);
      details.appendChild(summary);
      if (body) details.appendChild(body);
      details.open = false;
    }
  })();
})();

/* ========= After connect ========= */
async function afterConnect(){
  $('app').style.display='grid';
  await refreshTier();
  await restorePassport();
  await loadPlayerCard(addr);
  startMyTicketsListener();

  const isAdmin = !!addr && (addr.toLowerCase() === ADMIN_WALLET.toLowerCase());
  $('admin').style.display = isAdmin ? 'block' : 'none';
  const link = $('adminLink'); if (link) link.style.display = isAdmin ? 'inline-block' : 'none';
  if(isAdmin) await adminRefresh();
}
  </script>
</body>
</html>
