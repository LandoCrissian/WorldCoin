<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CROnation Draw ‚Äî Mega Jackpot</title>

  <!-- Force dark before paint -->
  <script>document.documentElement.setAttribute('data-theme','dark');</script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Ethers v5.7.2 + Firebase compat -->
  <script defer src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    :root{ --bg:#0b0d12; --text:#e5e7eb; --muted:#9ca3af; --line:#1f2937; --soft:#0f1219; --accent:#3b82f6; --accent-600:#2563eb; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--text); background:var(--bg); }

    /* ---- Header copied to match index ---- */
    header{ padding-top:calc(env(safe-area-inset-top,0px)); position:sticky; top:0; z-index:10;
            backdrop-filter:saturate(120%) blur(8px);
            background: color-mix(in srgb, var(--bg) 86%, transparent);
            border-bottom:1px solid var(--line); }
    .nav{ width:min(1120px,92vw); margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 0; }
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit;font-weight:800;}
    .brand img{width:32px;height:32px;border-radius:50%}
    .links{ display:flex; gap:16px; }
    .link{ text-decoration:none; color:var(--muted); font-weight:500; }
    .actions{ display:flex; align-items:center; gap:10px; flex-wrap:nowrap; min-width:0; }
    .btn{ appearance:none; border:1px solid var(--line); background:var(--bg); color:var(--text); padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; transition:.12s; min-height:44px; }
    .btn:hover{ transform:translateY(-1px) }
    .btn:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#fff; }
    .btn.ghost{ background:transparent; }
    .hamburger{ display:none; width:44px; height:44px; border:1px solid var(--line); border-radius:10px; background:var(--soft); cursor:pointer; align-items:center; justify-content:center; gap:4px; }
    .hamburger span{ display:block; width:18px; height:2px; background:var(--text); border-radius:2px; }
    .hamburger[aria-expanded="true"] span:nth-child(2){ opacity:0; }
    .hamburger[aria-expanded="true"] span:nth-child(1){ transform: translateY(6px) rotate(45deg); }
    .hamburger[aria-expanded="true"] span:nth-child(3){ transform: translateY(-6px) rotate(-45deg); }
    .mobile-menu{ display:none; position:fixed; left:0; right:0; top:64px; background:var(--bg); border-top:1px solid var(--line); border-bottom:1px solid var(--line); padding:10px 12px; z-index:9; }
    .mobile-menu a.link{ display:block; padding:12px; color:var(--text); text-decoration:none; }
    .mobile-menu a.link + a.link{ border-top:1px solid var(--line); }
    .mobile-menu.open{ display:block; }
    @media (max-width:640px){ .links{ display:none; } .hamburger{ display:inline-flex; } .actions{ margin-left:auto; gap:8px; } .actions .btn{ padding:10px 12px; } }

    /* ---- Page layout ---- */
    .container{ width:min(1120px,92vw); margin-inline:auto; padding:20px 0 60px; }
    .grid{ display:grid; gap:16px; }
    .two{ grid-template-columns:1.2fr 1fr; } @media (max-width:920px){ .two{ grid-template-columns:1fr } }
    .card{ border:1px solid var(--line); border-radius:14px; background:var(--soft); box-shadow:0 2px 16px rgba(0,0,0,.08); }
    .card .body{ padding:16px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.03); font-size:12px; font-weight:700; }
    .h1{ font-size:clamp(28px,3vw+12px,40px); font-weight:800; margin:10px 0; }
    .muted{ color:var(--muted) }
    .tickets{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,monospace; }

    /* Debug */
    #debug{ display:none; }
    #debug pre{ white-space:pre-wrap; word-break:break-word; background:#0e1117; border:1px solid var(--line); padding:12px; border-radius:10px; }
    .warn{ color:#fde68a } .err{ color:#fca5a5 }
  </style>
</head>
<body>
  <!-- Header identical to index, but links that point to home sections use /#hash -->
  <header>
    <nav class="nav" aria-label="Primary">
      <a class="brand" href="/" aria-label="CROnation home">
        <img src="https://raw.githubusercontent.com/LandoCrissian/WorldCoin/refs/heads/main/8DAEE2BE-F14F-4EB2-A993-E8EFE1EC2E35.png" alt="CROnation logo"/>
        <b>CROnation</b>
      </a>

      <!-- Desktop links -->
      <div class="links">
        <a class="link" href="/#map-section">Map</a>
        <a class="link" href="/#leaderboard-card">Leaderboard</a>
        <a class="link" href="/#about">About</a>
        <a class="link" href="/draw.html">Draw</a>
        <a class="link" href="https://x.com/cronation8" target="_blank" rel="noopener">ùïè</a>
        <a class="link" href="https://t.me/CRONationOfficial" target="_blank" rel="noopener">Telegram</a>
        <a class="link" href="https://www.puush.fun/coin/0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF" target="_blank" rel="noopener">Buy CRON8</a>
        <a class="link" id="adminLink" href="#admin" style="display:none;">Admin</a>
      </div>

      <div class="actions">
        <button id="connect" class="btn ghost">Connect Wallet</button>
        <a id="buyBtn" class="btn ghost" href="https://www.puush.fun/coin/0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF" target="_blank" rel="noopener">Buy CRON8</a>
        <button class="hamburger" id="hamburger" aria-label="Menu" aria-controls="mobile-menu" aria-expanded="false">
          <span></span><span></span><span></span>
        </button>
      </div>

      <!-- Mobile menu -->
      <div class="mobile-menu" id="mobile-menu" role="menu">
        <a class="link" role="menuitem" href="/#map-section">Map</a>
        <a class="link" role="menuitem" href="/#leaderboard-card">Leaderboard</a>
        <a class="link" role="menuitem" href="/#about">About</a>
        <a class="link" role="menuitem" href="/draw.html">Draw</a>
        <a class="link" role="menuitem" href="https://x.com/cronation8" target="_blank" rel="noopener">Follow on ùïè</a>
        <a class="link" role="menuitem" href="https://t.me/CRONationOfficial" target="_blank" rel="noopener">Join on Telegram</a>
        <a class="link" role="menuitem" href="https://www.puush.fun/coin/0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF" target="_blank" rel="noopener">Buy CRON8</a>
      </div>
    </nav>
  </header>

  <main class="container grid" style="margin-top:14px;">
    <section class="card">
      <div class="body">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="muted">Mega Jackpot</div>
            <div class="h1"><span id="jp-cron8">0</span> CRON8 + <span id="jp-cro">0</span> CRO</div>
            <div class="muted">
              Closes: <span id="jp-closes">‚Äî</span>
              ‚Ä¢ <span class="pill" id="status-pill">‚Äî</span>
              ‚Ä¢ <span class="pill" id="countdown">‚Äî</span>
            </div>
          </div>
          <div class="row">
            <span class="pill" id="addr-pill">‚Äî</span>
            <span class="pill" id="chain-pill">‚Äî</span>
            <span class="pill" id="tier-pill">Tier: ‚Äî</span>
            <span class="pill" id="free-pill">Free left: ‚Äî</span>
          </div>
        </div>
        <div id="envWarn" class="muted warn" style="margin-top:6px;display:none;"></div>
      </div>
    </section>

    <!-- Tickets + actions (hidden until connected) -->
    <section id="app" class="grid two" style="display:none;">
      <div class="card">
        <div class="body">
          <h3>Claim your free entries</h3>
          <p class="muted">Passport holders get free tickets every draw.</p>
          <div class="row" style="margin:10px 0;">
            <button class="btn primary" id="quick-claim">Claim ‚Äî Quick Pick</button>
            <button class="btn" id="manual-claim">Claim ‚Äî Manual</button>
          </div>
          <div id="picker" style="margin-top:6px;">
            <div class="muted" style="margin-bottom:6px;">Pick 5 numbers (1‚Äì69)</div>
            <div id="prim" class="row" style="flex-wrap:wrap;"></div>
            <div class="muted" style="margin:10px 0 6px;">Mega (1‚Äì26)</div>
            <div id="mega" class="row" style="flex-wrap:wrap;"></div>
          </div>
        </div>
      </div>
      <aside class="card">
        <div class="body">
          <h3>Buy more</h3>
          <p class="muted">Tickets are <b>15 CRO</b> each. v1 sends CRO to the dev wallet.</p>
          <div class="row">
            <input id="qty" type="number" min="1" value="1" style="width:80px;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b0d12;color:var(--text)">
            <button class="btn primary" id="buy">Buy</button>
          </div>
          <small class="muted">Anti-spam: 3s cooldown.</small>
        </div>
      </aside>
    </section>

    <section class="card">
      <div class="body">
        <h3>Your tickets</h3>
        <div id="tickets" class="tickets"></div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="card" style="display:none;">
      <div class="body">
        <div class="row" style="justify-content:space-between;">
          <h3>Admin ‚Äî Draw Controls</h3>
          <span class="pill" id="admin-status">status: ‚Äî</span>
        </div>
        <div class="row" style="margin:8px 0;">
          <label class="row">Close at:
            <input id="admin-closeAt" type="datetime-local" style="margin-left:8px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#0b0d12;color:var(--text)">
          </label>
          <label class="row">Start pots ‚Äî CRON8:
            <input id="admin-cron8" type="number" min="0" value="0" style="width:120px;margin-left:8px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#0b0d12;color:var(--text)">
          </label>
          <label class="row">CRO:
            <input id="admin-cro" type="number" min="0" value="0" style="width:120px;margin-left:8px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#0b0d12;color:var(--text)">
          </label>
        </div>
        <div class="row" style="margin:8px 0;">
          <button class="btn primary" id="admin-open">Open Draw (commit)</button>
          <button class="btn" id="admin-close">Close & Reveal</button>
          <button class="btn ghost" id="admin-refresh">Refresh</button>
        </div>
        <div class="mono muted" style="margin-top:6px;">
          Commit: <span id="admin-commit">‚Äî</span> <button class="btn" id="copy-commit">Copy</button><br/>
          Reveal seed: <span id="admin-reveal">‚Äî</span> <button class="btn" id="copy-reveal">Copy</button>
        </div>
      </div>
    </section>

    <!-- Debug -->
    <section id="debug" class="card">
      <div class="body">
        <h3>Debug</h3>
        <pre id="dbg"></pre>
      </div>
    </section>
  </main>

  <script>
    /* ===== Mobile menu (same behavior as index) ===== */
    (function mobileMenu(){
      const btn = document.getElementById('hamburger');
      const menu = document.getElementById('mobile-menu');
      if(!btn || !menu) return;
      const close = () => { menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); };
      const open  = () => { menu.classList.add('open');  btn.setAttribute('aria-expanded','true'); };
      btn.addEventListener('click', () => { (btn.getAttribute('aria-expanded') === 'true') ? close() : open(); });
      menu.querySelectorAll('a').forEach(a => a.addEventListener('click', close));
      window.addEventListener('keydown', e => { if(e.key === 'Escape') close(); }, { passive:true });
      window.addEventListener('click', e => { if(!menu.contains(e.target) && e.target !== btn && !btn.contains(e.target)) close(); }, { passive:true });
      window.addEventListener('resize', () => { if(window.innerWidth > 640) close(); }, { passive:true });
    })();

    /* ======= CONSTANTS (exact per your spec) ======= */
    const CRONOS = { chainIdHex:'0x19', rpc:'https://evm.cronos.org' };
    const DEV_WALLET = '0x69b6c23E59F9Fd56fa3DE3edF624D5c2C67c05F0';
    const ADMIN_WALLET = DEV_WALLET;
    const DRAW_ID = 'current';
    const CRON8 = {
      address:'0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF',
      decimals:18,
      abi:[{"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"}]
    };
    const TIER = [
      {tier:3,min:'25000000'}, {tier:2,min:'5000000'}, {tier:1,min:'1000000'}, {tier:0,min:'0'}
    ];
    const FREE = {0:1,1:2,2:3,3:5};
    const NUM = {primMin:1, primMax:69, primPick:5, megaMin:1, megaMax:26};

    /* ======= Firebase ======= */
    firebase.initializeApp({
      apiKey:"AIzaSyAJ0eSdO1mEYdbVNVRbiB0BlOwn6UEjT10",
      authDomain:"cronation-6058b.firebaseapp.com",
      projectId:"cronation-6058b",
      storageBucket:"cronation-6058b.appspot.com",
      appId:"1:303748855698:web:b03fe82e7314ab371bf34b"
    });
    const db = firebase.firestore();

    /* ======= Debug helpers ======= */
    const $ = (id)=>document.getElementById(id);
    const setText=(id,v)=>{const n=$(id); if(n) n.textContent=v;};
    const short=(a)=> a ? a.slice(0,6)+'‚Ä¶'+a.slice(-4) : '';
    const DBG = [];
    function dbg(...a){ try{ DBG.push(a.map(x=>typeof x==='object'?JSON.stringify(x):String(x)).join(' ')); const d=$('dbg'); if(d) d.textContent=DBG.join('\n'); }catch{} }
    // Toggle debug via button or ?debug=1
    (function(){
      const t=document.createElement('button'); /* no-op just keeping structure tidy */
      const toggle=document.getElementById('toggleDebug');
      if(toggle){
        toggle.onclick = ()=> {
          const on = $('debug').style.display !== 'block';
          $('debug').style.display = on?'block':'none';
          toggle.setAttribute('aria-pressed', on?'true':'false');
        };
      }
      if (new URLSearchParams(location.search).get('debug') === '1') { const d=$('debug'); if(d) d.style.display='block'; }
    })();

    // HTTPS guard (wallets often refuse file:// or http://)
    (function httpsGuard(){
      const ok = (location.protocol === 'https:' || location.hostname === 'localhost');
      if(!ok){ const w=$('envWarn'); if(w){ w.style.display='block'; w.textContent='Serve over HTTPS or localhost. Wallets may refuse http:// or file://.'; } dbg('WARN non-https', location.href); }
    })();

    /* ======= Provider selection ======= */
    function detectCDC(p){ return !!(p && (p.isDeFiWallet || p.isDeficonnectProvider || p.isCryptoCom)); }
    function pickInjectedProvider(){
      const eth = window.ethereum;
      if (!eth) return window.deficonnectProvider || null;
      if (Array.isArray(eth.providers) && eth.providers.length){
        const mm = eth.providers.find(p=>p && p.isMetaMask);
        const cdc= eth.providers.find(p=>detectCDC(p));
        return mm || cdc || eth.providers[0];
      }
      return eth;
    }
    function waitForEthereum(timeout=1600){
      return new Promise((resolve)=>{
        if (window.ethereum) return resolve(window.ethereum);
        const t=setTimeout(()=>resolve(window.ethereum||null),timeout);
        window.addEventListener('ethereum#initialized',()=>{ clearTimeout(t); resolve(window.ethereum||null); },{once:true});
      });
    }

    /* ======= Wallet state ======= */
    let injected=null, provider=null, signer=null, addr=null;

    async function ensureCronos(){
      if(!injected) return;
      const desired = CRONOS.chainIdHex;
      let current;
      try{ current = await injected.request({method:'eth_chainId'}); }catch(e){ dbg('eth_chainId error', e?.message); }
      if ((current||'').toLowerCase() === desired) return;
      try{
        await injected.request({ method:'wallet_switchEthereumChain', params:[{ chainId:desired }]});
      }catch(e){
        if (e?.code === 4902){
          dbg('Adding Cronos');
          await injected.request({ method:'wallet_addEthereumChain', params:[{
            chainId:desired, chainName:'Cronos Mainnet',
            nativeCurrency:{name:'Cronos',symbol:'CRO',decimals:18},
            rpcUrls:[CRONOS.rpc], blockExplorerUrls:['https://cronoscan.com']
          }]});
        } else { throw e; }
      }
    }

    function wireProviderEvents(){
      if(!injected || injected._wired_draw) return;
      injected._wired_draw = true;
      injected.on?.('accountsChanged', async (acc)=>{
        dbg('accountsChanged', acc);
        if (acc && acc[0]){
          addr = acc[0].toLowerCase();
          setText('addr-pill', short(addr));
          await afterConnect();
        } else {
          addr = null;
          setText('addr-pill','‚Äî'); setText('tier-pill','Tier: ‚Äî'); setText('free-pill','Free left: ‚Äî');
          $('app').style.display='none';
        }
      });
      injected.on?.('chainChanged', (cid)=>{ dbg('chainChanged', cid); location.reload(); });
    }

    async function connect(){
      await waitForEthereum();
      injected = pickInjectedProvider();
      dbg('picked', injected ? (injected.isMetaMask?'MetaMask':'CDC/Other') : 'none');
      if(!injected){ alert('Open this page inside MetaMask or Crypto.com DeFi Wallet.'); dbg('no provider'); return; }

      try { await ensureCronos(); }
      catch(e){ alert('Please switch/add Cronos Mainnet in your wallet.'); dbg('ensureCronos', e?.message); return; }

      try { await injected.request({ method:'eth_requestAccounts' }); }
      catch(e){ alert('Connection cancelled.'); dbg('eth_requestAccounts', e?.message); return; }

      provider = new ethers.providers.Web3Provider(injected, 'any');
      signer   = provider.getSigner();

      try { addr = (await signer.getAddress()).toLowerCase(); }
      catch(e){ alert('Could not read wallet address.'); dbg('getAddress', e?.message); return; }

      setText('addr-pill', short(addr));
      const chainId = await injected.request({method:'eth_chainId'}).catch(()=>null);
      setText('chain-pill', 'Chain '+(chainId||'?'));
      wireProviderEvents();
      await afterConnect();
    }
    document.getElementById('connect').addEventListener('click', connect);

    /* ======= App after connect ======= */
    async function afterConnect(){
      $('app').style.display='grid';
      await loadDraw();
      await refreshTier();
      await restorePassport();
      await loadMine();
      if (addr && addr.toLowerCase() === ADMIN_WALLET.toLowerCase()){
        $('admin').style.display='block'; adminRefresh();
      } else {
        $('admin').style.display='none';
      }
    }

    /* ======= Draw header ======= */
    let __closeAt=0;
    async function loadDraw(){
      const snap = await db.collection('draws').doc(DRAW_ID).get();
      const d = snap.exists ? snap.data() : {status:'open', commitHash:'‚Äî', closeAt:Date.now()+7*864e5, pots:{cron8:0,cro:0}};
      setText('status-pill', d.status||'‚Äî');
      setText('jp-closes', d.closeAt ? new Date(d.closeAt).toLocaleString() : '‚Äî');
      setText('jp-cron8', (d.pots?.cron8||0).toLocaleString());
      setText('jp-cro',   (d.pots?.cro||0).toLocaleString());
      __closeAt = d.closeAt||0;
    }
    setInterval(()=>{
      if(!__closeAt) { setText('countdown','‚Äî'); return; }
      const s = Math.max(0, Math.floor((__closeAt-Date.now())/1000));
      const d=Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60), sec=s%60;
      setText('countdown', `${d}d ${h}h ${m}m ${sec}s`);
    },1000);

    /* ======= Passport (placeholder pill for now) ======= */
    async function restorePassport(){
      try{
        const doc = await db.collection('passports').doc(addr).get();
        if(!doc.exists){ return; }
        const p = doc.data();
        const serial = String(p.serial||'000000').padStart(6,'0');
        // You can display serial here if you want, keeping UI clean for now
      }catch(e){ dbg('restorePassport', e?.message); }
    }

    /* ======= Tier / free ======= */
    async function cron8Balance(a){
      const read = new ethers.providers.JsonRpcProvider(CRONOS.rpc);
      const erc20 = new ethers.Contract(CRON8.address, CRON8.abi, read);
      return await erc20.balanceOf(a);
    }
    function parseUnits(v,d){ return ethers.utils.parseUnits(v,d); }
    async function refreshTier(){
      if(!addr) return;
      const bal = await cron8Balance(addr);
      let tier = 0;
      for (const t of TIER){
        if (ethers.BigNumber.from(bal).gte(parseUnits(t.min, CRON8.decimals))){ tier = t.tier; break; }
      }
      setText('tier-pill','Tier: ' + (tier===0?'Basic':('T'+tier)));
      const claimed = await db.collection('tickets')
        .where('drawId','==',DRAW_ID).where('wallet','==',addr).where('isFree','==',true).get()
        .then(q=>q.size).catch(()=>0);
      const left = Math.max(0, (FREE[tier] ?? 1) - claimed);
      setText('free-pill', 'Free left: '+left);
      window.__freeLeft = left;
    }

    /* ======= Tickets ======= */
    function qp(){ // quick-pick
      const s=new Set(); while(s.size<NUM.primPick){ s.add(Math.floor(Math.random()*(NUM.primMax-NUM.primMin+1))+NUM.primMin); }
      const mega=Math.floor(Math.random()*(NUM.megaMax-NUM.megaMin+1))+NUM.megaMin;
      return { primary:[...s].sort((a,b)=>a-b), mega };
    }
    async function loadMine(){
      if(!addr){ $('tickets').innerHTML='<div class="muted">Connect wallet to see your tickets.</div>'; return; }
      const snap = await db.collection('tickets')
        .where('drawId','==',DRAW_ID).where('wallet','==',addr).orderBy('created','desc').get();
      const out=[];
      snap.forEach(doc=>{
        const d=doc.data();
        out.push(`<div class="card"><div class="body"><div class="muted">${d.isFree?'Free':'Paid'}</div>
          <div class="mono" style="margin-top:4px;">${(d.picks||[]).join(' - ')}  |  ‚òÖ ${d.mega}</div></div></div>`);
      });
      $('tickets').innerHTML = out.join('') || '<div class="muted">No tickets yet.</div>';
    }
    document.getElementById('quick-claim').onclick = async ()=>{
      if(!addr) return alert('Connect wallet first');
      if((window.__freeLeft ?? 0) <= 0) return alert('No free entries left for your tier');
      const picks = qp();
      await db.collection('tickets').add({
        drawId:DRAW_ID, wallet:addr, picks:picks.primary, mega:picks.mega, isFree:true,
        created: firebase.firestore.FieldValue.serverTimestamp()
      });
      await loadMine(); await refreshTier();
    };

    // Manual picker (light)
    (function buildManual(){
      const prim=$('prim'), mega=$('mega'); let chosen=new Set(), m=NUM.megaMin;
      function render(){
        prim.innerHTML=''; mega.innerHTML='';
        for(let n=NUM.primMin;n<=NUM.primMax;n++){
          const b=document.createElement('button'); b.className='btn ghost'; b.textContent=String(n);
          if(chosen.has(n)) b.style.borderColor='var(--accent)';
          b.onclick=()=>{ if(chosen.has(n)) chosen.delete(n); else if(chosen.size<NUM.primPick) chosen.add(n); render(); };
          prim.appendChild(b);
        }
        for(let n=NUM.megaMin;n<=NUM.megaMax;n++){
          const b=document.createElement('button'); b.className='btn ghost'; b.textContent=String(n);
          if(m===n) b.style.borderColor='#f59e0b';
          b.onclick=()=>{ m=n; render(); }; mega.appendChild(b);
        }
        $('manual-claim').onclick = async ()=>{
          if(!addr) return alert('Connect wallet first');
          if((window.__freeLeft ?? 0) <= 0) return alert('No free entries left for your tier');
          if(chosen.size!==NUM.primPick) return alert(`Pick exactly ${NUM.primPick} numbers`);
          const picks=[...chosen].sort((a,b)=>a-b);
          await db.collection('tickets').add({
            drawId:DRAW_ID, wallet:addr, picks, mega:m, isFree:true,
            created: firebase.firestore.FieldValue.serverTimestamp()
          });
          chosen.clear(); m=NUM.megaMin; render(); await loadMine(); await refreshTier();
        };
      }
      render();
    })();

    /* ======= Buy flow ======= */
    let __nextBuyAt=0;
    $('buy').onclick = async ()=>{
      if(!addr) return alert('Connect wallet first');
      const now=Date.now(); if(now<__nextBuyAt) return alert(`Wait ${Math.ceil((__nextBuyAt-now)/1000)}s‚Ä¶`);
      await ensureCronos();
      const qty=Math.max(1,parseInt(($('qty').value||'1'),10));
      const total=ethers.utils.parseEther(String(15*qty));
      try{
        await injected.request({ method:'eth_sendTransaction', params:[{ from:addr, to:DEV_WALLET, value: total.toHexString() }]});
      }catch(e){ dbg('eth_sendTransaction', e?.message); return alert('Payment cancelled or failed.'); }
      __nextBuyAt=Date.now()+3000;
      const batch=[];
      for(let i=0;i<qty;i++){
        const picks=qp();
        batch.push(db.collection('tickets').add({
          drawId:DRAW_ID, wallet:addr, picks:picks.primary, mega:picks.mega, isFree:false,
          created: firebase.firestore.FieldValue.serverTimestamp()
        }));
      }
      batch.push(db.collection('ledger').add({
        drawId:DRAW_ID, type:'purchase', wallet:addr, qty, priceCro:15, to:DEV_WALLET,
        at: firebase.firestore.FieldValue.serverTimestamp()
      }));
      await Promise.all(batch); await loadMine();
      alert(`Purchased ${qty} ticket(s). CRO sent.`);
    };

    /* ======= Admin (commit‚Äìreveal) ======= */
    const SEED_KEY='cronation_draw_seed';
    const toHex=(buf)=>Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    async function sha256Hex(str){ const enc=new TextEncoder(); const buf=await crypto.subtle.digest('SHA-256', enc.encode(str)); return '0x'+toHex(buf); }
    function randomSeed(){ const b=new Uint8Array(32); crypto.getRandomValues(b); return '0x'+Array.from(b).map(x=>x.toString(16).padStart(2,'0')).join(''); }

    async function adminRefresh(){
      const snap=await db.collection('draws').doc(DRAW_ID).get();
      if(!snap.exists){ setText('admin-status','status: (no draw)'); return; }
      const d=snap.data();
      setText('admin-status',`status: ${d.status||'‚Äî'}`);
      setText('admin-commit',d.commitHash||'‚Äî');
      setText('admin-reveal',d.revealSeed||localStorage.getItem(SEED_KEY)||'‚Äî');
      if(d.closeAt) $('admin-closeAt').value=new Date(d.closeAt).toISOString().slice(0,16);
      $('admin-cron8').value=d.pots?.cron8 ?? 0; $('admin-cro').value=d.pots?.cro ?? 0;
    }
    $('admin-open').onclick = async ()=>{
      const seed=randomSeed(); const commit=await sha256Hex(seed); localStorage.setItem(SEED_KEY,seed);
      const closeAtStr=$('admin-closeAt').value; const closeAt=closeAtStr? new Date(closeAtStr).getTime() : (Date.now()+7*864e5);
      const cron8=parseFloat($('admin-cron8').value||'0')||0; const cro=parseFloat($('admin-cro').value||'0')||0;
      await db.collection('draws').doc(DRAW_ID).set({ status:'open', commitHash:commit, closeAt, pots:{cron8,cro}, revealSeed: firebase.firestore.FieldValue.delete() },{merge:true});
      await adminRefresh(); await loadDraw(); alert('Draw opened. Seed saved locally.');
    };
    $('admin-close').onclick = async ()=>{
      const seed=localStorage.getItem(SEED_KEY); if(!seed) return alert('No local seed to reveal.');
      await db.collection('draws').doc(DRAW_ID).set({ status:'closed', revealSeed:seed },{merge:true});
      await adminRefresh(); await loadDraw(); alert('Draw closed & seed revealed.');
    };
    $('admin-refresh').onclick = adminRefresh;
    $('copy-commit').onclick = ()=> navigator.clipboard.writeText(($('admin-commit').textContent||'').trim());
    $('copy-reveal').onclick = ()=> navigator.clipboard.writeText(($('admin-reveal').textContent||'').trim());

    /* ======= Boot: header + silent restore ======= */
    (async ()=>{
      await loadDraw();

      // show Admin link if connected later (same pattern as index)
      function isAdmin(a){ return !!a && a.toLowerCase() === ADMIN_WALLET.toLowerCase(); }
      function showAdminUI(on){
        const link = document.getElementById('adminLink');
        const panel = document.getElementById('admin');
        if (link)  link.style.display  = on ? 'inline-block' : 'none';
        if (panel) panel.style.display = on ? 'block' : 'none';
      }

      await waitForEthereum();
      injected = pickInjectedProvider();
      if (injected){
        try{
          const acc = await injected.request({ method:'eth_accounts' });
          if (acc && acc[0]){
            provider = new ethers.providers.Web3Provider(injected, 'any');
            signer = provider.getSigner();
            addr = acc[0].toLowerCase();
            setText('addr-pill', short(addr));
            const chainId = await injected.request({method:'eth_chainId'}).catch(()=>null);
            setText('chain-pill','Chain '+(chainId||'?'));
            wireProviderEvents();
            await afterConnect();
            if (isAdmin(addr)) showAdminUI(true);
          }
        }catch(e){ dbg('silent restore', e?.message); }
      }
    })();
  </script>
</body>
</html>
