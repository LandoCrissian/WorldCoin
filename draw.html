<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CROnation ‚Äî Mega Jackpot Draw</title>

  <script>document.documentElement.setAttribute('data-theme','dark');</script>

  <!-- Core libs -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#0b0d12" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{ --bg:#0b0d12; --text:#e5e7eb; --muted:#9ca3af; --line:#1f2937; --soft:#0f1219; --accent:#3b82f6; --accent-600:#2563eb; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",sans-serif; color:var(--text); background:var(--bg); line-height:1.5; }

    header{ padding-top: calc(env(safe-area-inset-top, 0px)); position:sticky; top:0; backdrop-filter:saturate(120%) blur(8px); background: color-mix(in srgb, var(--bg) 86%, transparent); border-bottom:1px solid var(--line); z-index:10; }
    html { scroll-padding-top: 80px; }
    .container{ width:min(1120px, 92vw); margin-inline:auto; padding:24px 0 72px; }
    .nav{ width:min(1120px, 92vw); margin-inline:auto; display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 0; }
    .brand{ display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; font-weight:800; }
    .brand img{ width:32px; height:32px; border-radius:50%; }
    .links{ display:flex; gap:16px; }
    .nav a.link{ text-decoration:none; color:var(--muted); font-weight:500; margin:0 10px; }
    .actions{ display:flex; align-items:center; gap:10px; }
    .btn{ appearance:none; border:1px solid var(--line); background:var(--bg); color:var(--text); padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; transition:.12s; min-height:44px; }
    .btn:hover{ transform: translateY(-1px); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; transform:none; }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#fff; }
    .btn.primary:hover{ background:var(--accent-600); }
    .btn.ghost{ background:transparent; }
    a.btn { display:inline-flex; align-items:center; justify-content:center; text-decoration:none; }

    #connect, #disconnect, #buyBtn { min-width:160px; text-align:center; }
    .hamburger{ width:44px; height:44px; display:none; margin-left:8px; border:1px solid var(--line); border-radius:10px; background:var(--soft); cursor:pointer; align-items:center; justify-content:center; gap:4px; }
    .hamburger span{ display:block; width:18px; height:2px; background:var(--text); border-radius:2px; }
    .mobile-menu{ display:none; position:fixed; left:0; right:0; top:64px; background:var(--bg); border-top:1px solid var(--line); border-bottom:1px solid var(--line); padding:10px 12px; z-index:9; }
    .mobile-menu a.link{ display:block; padding:12px; color:var(--text); text-decoration:none; }
    .mobile-menu a.link + a.link{ border-top:1px solid var(--line); }
    .mobile-menu.open{ display:block; }
    .hamburger[aria-expanded="true"] span:nth-child(2){ opacity:0; }
    .hamburger[aria-expanded="true"] span:nth-child(1){ transform: translateY(6px) rotate(45deg); }
    .hamburger[aria-expanded="true"] span:nth-child(3){ transform: translateY(-6px) rotate(-45deg); }
    @media (max-width: 720px){ #buyBtn{ display:none; } .hamburger{ display:inline-flex; } }
    @media (max-width:640px){ .links{ display:none; } .actions{ margin-left:auto; gap:8px; } .actions .btn{ padding:10px 12px; } }
    @media (min-width:641px){ .mobile-menu{ display:none !important; } }

    .page{ width:min(1120px,92vw); margin-inline:auto; padding:20px 0 72px; }
    .grid{ display:grid; gap:16px; }
    .two{ grid-template-columns:1.2fr 1fr; } @media (max-width:960px){ .two{ grid-template-columns:1fr; } }
    .card{ border:1px solid var(--line); border-radius:14px; background:var(--soft); box-shadow:0 2px 16px rgba(0,0,0,.08); }
    .card .body{ padding:16px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted{ color:var(--muted); }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.03); font-size:12px; font-weight:700; }
    .h1{ font-size:clamp(28px,3vw+12px,40px); font-weight:800; margin:10px 0; }
    .tickets{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,monospace; }

    .numbers{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .n{ min-width:44px; height:44px; padding:0 12px; border-radius:999px; border:1px solid var(--line); display:grid; place-items:center; cursor:pointer; background:transparent; color:var(--text); }
    .n.on{ background:var(--accent); border-color:var(--accent); color:#fff; }
    .n.mega{ border-color:#b45309; }
    .n.mega.on{ background:#f59e0b; color:#111827; border-color:#f59e0b; }

    .notice{ background:color-mix(in srgb, var(--accent) 12%, var(--bg) 88%); border-bottom:1px solid var(--line); color:var(--text); }
    .notice .wrap{ width:min(1120px,92vw); margin:0 auto; padding:10px 0; font-weight:600; display:flex; gap:10px; align-items:center; justify-content:center; text-align:center; }

    .toast { position:fixed;left:50%;bottom:18px;transform:translateX(-50%); background:#0f1219;border:1px solid var(--line);color:var(--text); padding:10px 12px;border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,.35); z-index:6000;opacity:0;pointer-events:none;transition:.2s; }
    .toast.show { opacity:1;pointer-events:auto; }
    .loader { position:fixed;inset:0;background:rgba(0,0,0,.45); display:none;align-items:center;justify-content:center; z-index:5500; }
    .loader[aria-busy="true"] { display:flex; }
    .loader .dot { width:8px;height:8px;border-radius:50%;background:#fff; margin:0 4px;animation:ld 1s infinite; }
    .loader .dot:nth-child(2){animation-delay:.15s;} .loader .dot:nth-child(3){animation-delay:.3s;}
    @keyframes ld { 0%,80%,100%{opacity:.2;transform:scale(.8);} 40%{opacity:1;transform:scale(1);} }

    #debug{ display:none; }
    #debug pre{ white-space:pre-wrap; word-break:break-word; background:#0e1117; border:1px solid var(--line); padding:12px; border-radius:10px; }
    .warn{ color:#fde68a } .err{ color:#fca5a5 }
  </style>
</head>
<body>

  <!-- Global toast + loader -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="loader" class="loader" aria-hidden="true">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>

  <!-- Header -->
  <header>
    <nav class="nav" aria-label="Primary">
      <a class="brand" href="/#top" aria-label="CROnation home">
        <img src="https://raw.githubusercontent.com/LandoCrissian/WorldCoin/refs/heads/main/8DAEE2BE-F14F-4EB2-A993-E8EFE1EC2E35.png" alt="CROnation logo"/>
        <b>CROnation</b>
      </a>

      <div class="links">
        <a class="link" href="/#map-section">Map</a>
        <a class="link" href="/#leaderboard-card">Leaderboard</a>
        <a class="link" href="/#about">About</a>
        <a class="link" href="/draw.html">Draw</a>
        <a class="link" href="https://x.com/cronation8" target="_blank" rel="noopener">ùïè</a>
        <a class="link" href="https://t.me/CRONationOfficial" target="_blank" rel="noopener">Telegram</a>
        <a class="link" href="https://www.puush.fun/coin/0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF" target="_blank" rel="noopener">Buy CRON8</a>
        <a class="link" id="adminLink" href="#admin" style="display:none;">Admin</a>
      </div>

      <div class="actions">
        <button id="connect" class="btn ghost">Connect Wallet</button>
        <button id="disconnect" class="btn ghost" style="display:none;">Disconnect</button>
        <a id="buyBtn" class="btn ghost" href="https://www.puush.fun/coin/0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF" target="_blank" rel="noopener">Buy CRON8</a>
        <button class="hamburger" id="hamburger" aria-label="Menu" aria-controls="mobile-menu" aria-expanded="false">
          <span></span><span></span><span></span>
        </button>
      </div>

      <div class="mobile-menu" id="mobile-menu" role="menu">
        <a class="link" role="menuitem" href="/#map-section">Map</a>
        <a class="link" role="menuitem" href="/#leaderboard-card">Leaderboard</a>
        <a class="link" role="menuitem" href="/#about">About</a>
        <a class="link" role="menuitem" href="/draw.html">Draw</a>
        <a class="link" role="menuitem" href="https://x.com/cronation8" target="_blank" rel="noopener">Follow on ùïè</a>
        <a class="link" role="menuitem" href="https://t.me/CRONationOfficial" target="_blank" rel="noopener">Join on Telegram</a>
        <a class="link" role="menuitem" href="https://www.puush.fun/coin/0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF" target="_blank" rel="noopener">Buy CRON8</a>
      </div>
    </nav>
  </header>

  <!-- Status notice -->
  <div class="notice" role="status" aria-live="polite">
    <div class="wrap">
      <span id="platformBanner"><b>Mega Jackpot Draw.</b></span>
      <span><small>Connect your wallet, claim free entries (by CRON8 tier), or buy more with CRO.</small></span>
    </div>
  </div>

  <!-- Page -->
  <main class="page grid" style="margin-top:14px;">

    <!-- Jackpot header -->
    <section class="card">
      <div class="body">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="muted">Mega Jackpot</div>
            <div class="h1"><span id="jp-cron8">0</span> CRON8 + <span id="jp-cro">0</span> CRO</div>
            <div class="muted">
              Closes: <span id="jp-closes">‚Äî</span>
              ‚Ä¢ <span class="pill" id="status-pill">‚Äî</span>
              ‚Ä¢ <span class="pill" id="countdown">‚Äî</span>
            </div>
          </div>
          <div class="row">
            <span class="pill" id="addr-pill">‚Äî</span>
            <span class="pill" id="chain-pill">‚Äî</span>
            <span class="pill" id="tier-pill">Tier: ‚Äî</span>
            <span class="pill" id="free-pill">Free left: ‚Äî</span>
          </div>
        </div>
        <div id="envWarn" class="muted warn" style="margin-top:6px;display:none;"></div>
      </div>
    </section>

    <!-- App actions (shown after connect) -->
    <section id="app" class="grid two" style="display:none;">
      <div class="card">
        <div class="body">
          <h3>Claim your free entries</h3>
          <p class="muted">Passport holders get free tickets per draw based on CRON8 tier.</p>
          <div class="row" style="margin:10px 0;">
            <button class="btn primary" id="quick-claim">Claim ‚Äî Quick Pick</button>
            <button class="btn" id="manual-claim">Claim ‚Äî Manual</button>
          </div>
          <div id="picker" style="margin-top:6px;">
            <div class="muted" style="margin-bottom:6px;">Pick 5 numbers (1‚Äì69)</div>
            <div id="prim" class="numbers"></div>
            <div class="muted" style="margin:10px 0 6px;">Mega (1‚Äì26)</div>
            <div id="mega" class="numbers"></div>
          </div>
        </div>
      </div>

      <aside class="card">
        <div class="body">
          <h3>Buy more</h3>
          <p class="muted">Tickets are <b>15 CRO</b> each. v1 sends CRO to the dev wallet.</p>
          <div class="row">
            <input id="qty" type="number" min="1" value="1" style="width:96px;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0b0d12;color:var(--text)" />
            <button class="btn primary" id="buy">Buy</button>
          </div>
          <small class="muted">Anti-spam: 3s cooldown.</small>
        </div>
      </aside>
    </section>

    <section class="card">
      <div class="body">
        <h3>Your tickets</h3>
        <div id="tickets" class="tickets"></div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="card" style="display:none;">
      <div class="body">
        <div class="row" style="justify-content:space-between;">
          <h3>Admin ‚Äî Draw Controls</h3>
          <span class="pill" id="admin-status">status: ‚Äî</span>
        </div>

        <div class="row" style="margin:8px 0;">
          <label class="row">Close at:
            <input id="admin-closeAt" type="datetime-local" style="margin-left:8px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#0b0d12;color:var(--text)">
          </label>
          <label class="row">Start pots ‚Äî CRON8:
            <input id="admin-cron8" type="number" min="0" value="0" style="width:120px;margin-left:8px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#0b0d12;color:var(--text)">
          </label>
          <label class="row">CRO:
            <input id="admin-cro" type="number" min="0" value="0" style="width:120px;margin-left:8px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#0b0d12;color:var(--text)">
          </label>
        </div>

        <div class="row" style="margin:8px 0;">
          <button class="btn primary" id="admin-open">Open Draw (commit)</button>
          <button class="btn" id="admin-close">Close & Reveal</button>
          <button class="btn ghost" id="admin-refresh">Refresh</button>
        </div>

        <div class="row" style="margin:10px 0; gap:18px;">
          <label class="row" style="gap:8px;">
            <input type="checkbox" id="flag-pause-all"> Pause ALL
          </label>
          <label class="row" style="gap:8px;">
            <input type="checkbox" id="flag-pause-claims"> Pause free claims
          </label>
          <label class="row" style="gap:8px;">
            <input type="checkbox" id="flag-pause-buys"> Pause purchases
          </label>
          <button class="btn" id="admin-save-flags">Save Flags</button>
        </div>

        <div class="mono muted" style="margin-top:6px;">
          Commit: <span id="admin-commit">‚Äî</span> <button class="btn" id="copy-commit">Copy</button><br/>
          Reveal seed: <span id="admin-reveal">‚Äî</span> <button class="btn" id="copy-reveal">Copy</button>
        </div>
      </div>
    </section>

    <!-- Debug -->
    <section id="debug" class="card" aria-live="polite" style="display:none;">
      <div class="body">
        <div class="row" style="justify-content:space-between;gap:12px;">
          <h3>Debug</h3>
          <button id="toggleDebug" class="btn ghost" aria-pressed="true">Hide debug</button>
        </div>
        <pre id="dbg"></pre>
      </div>
    </section>

    <!-- Disclaimer modal -->
<div id="dlg" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:7000;">
  <div style="width:min(680px,92vw);background:#0f1219;border:1px solid #1f2937;border-radius:14px;padding:16px;">
    <h3 style="margin:0 0 8px;">Before you continue</h3>
    <div style="max-height:38vh;overflow:auto;color:#9ca3af;font-size:14px;line-height:1.5;">
      <p><b>Play at your own risk.</b> This game is experimental community software. No guarantees. Do not spend what you can‚Äôt afford to lose.</p>
      <p><b>Chances of winning:</b> each ticket picks 5 numbers (1‚Äì69) and 1 mega (1‚Äì26). The odds of matching all numbers are approximately 1 in 292,201,338.</p>
      <p>By clicking ‚ÄúI agree & sign‚Äù, you acknowledge these terms and consent to the app storing a proof of your consent (signature hash) tied to your wallet.</p>
    </div>
    <div style="display:flex;gap:10px;margin-top:14px;justify-content:flex-end;">
      <button id="dlg-cancel" class="btn">Cancel</button>
      <button id="dlg-agree"  class="btn primary">I agree & sign</button>
    </div>
  </div>
</div>

  </main>

  <footer class="footer">
    <div class="container">
      <div style="display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
        <small>¬© <span id="year"></span> CROnation. Built for Cronos ‚Äî community-first.</small>
        <small class="muted">This platform is evolving ‚Äî join us as we build CROnation together.</small>
      </div>
    </div>
  </footer>

  <script>
    /* ========= CONSTANTS ========= */
    const CRONOS = { chainIdHex:'0x19', rpc:'https://evm.cronos.org' };
    const DRAW_ID = 'current';
    const DEV_WALLET = '0x69b6c23E59F9Fd56fa3DE3edF624D5c2C67c05F0';
    const ADMIN_WALLET = DEV_WALLET;
    const LS_CONNECTED = 'cronation_connected_v1';

    const CRON8 = {
      address:'0x59405C88eC1145Ca56076aeC7f9EE0c435F75baF',
      decimals:18,
      abi:[{"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"}]
    };
    const TIER = [
      { tier:3, min:'25000000' },
      { tier:2, min:'5000000'  },
      { tier:1, min:'1000000'  },
      { tier:0, min:'0' }
    ];

    // One-time disclaimer gate
const AGREEMENTS = { col:'agreements' }; // Firestore collection: agreements/<wallet>


function agreementRef(addr){ return db.collection(AGREEMENTS.col).doc(addr); }

function disclaimerMessage(addr){
  const ts = new Date().toISOString();
  return [
    'CROnation ‚Äî Play at your own risk.',
    'Odds ~1 in 292,201,338 per ticket.',
    'No guarantees. Experimental community software.',
    `Wallet: ${addr}`,
    `Timestamp: ${ts}`,
    'By signing you acknowledge the above.'
  ].join('\n');
}

// minimalist modal API
function showDialog(){ $('dlg').style.display='flex'; }
function hideDialog(){ $('dlg').style.display='none'; }
$('dlg-cancel').onclick = ()=> hideDialog();

    
    // Zero freebies for tier 0
    const FREE = { 0:0, 1:1, 2:3, 3:5 };
    const NUM = { primMin:1, primMax:69, primPick:5, megaMin:1, megaMax:26 };

    // Admin flags (Firestore: config/app.flags)
    const CONFIG_DOC = { col: 'config', doc: 'app' };
    const FLAGS_DEFAULT = { pauseAll:false, pauseClaims:false, pauseBuys:false };
    let __flags = { ...FLAGS_DEFAULT };

    /* ========= Firebase ========= */
    firebase.initializeApp({
      apiKey:"AIzaSyAJ0eSdO1mEYdbVNVRbiB0BlOwn6UEjT10",
      authDomain:"cronation-6058b.firebaseapp.com",
      projectId:"cronation-6058b",
      storageBucket:"cronation-6058b.appspot.com",
      appId:"1:303748855698:web:b03fe82e7314ab371bf34b"
    });
    const db = firebase.firestore();

    /* ========= Helpers ========= */
    const $ = (id)=>document.getElementById(id);
    const setText=(id,v)=>{ const n=$(id); if(n) n.textContent=v; };
    const short=(a)=> a ? a.slice(0,6)+'‚Ä¶'+a.slice(-4) : '';
    const toast = (msg)=>{ const t=$('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(t._h); t._h=setTimeout(()=>t.classList.remove('show'),2600); };
    const setBusy = (on)=>{ const l=$('loader'); l.setAttribute('aria-busy',on?'true':'false'); l.setAttribute('aria-hidden',on?'false':'true'); };

    // Debug
    const DBG = [];
    function dbg(...a){
      try{ const line=a.map(x=>(typeof x==='object'?JSON.stringify(x):String(x))).join(' ');
        DBG.push(line); const pre=$('dbg'); if(pre) pre.textContent=DBG.join('\n');
      }catch(_){}
    }

    setText('year', new Date().getFullYear());

    // HTTPS guard
    (function httpsGuard(){
      const ok = (location.protocol === 'https:' || location.hostname === 'localhost');
      if(!ok){ const w=$('envWarn'); w.style.display='block'; w.textContent='Serve over HTTPS or localhost. Wallets may refuse http:// or file://.'; dbg('WARN non-https', location.href); }
    })();

    // Mobile menu
    (function mobileMenu(){
      const btn = $('hamburger'); const menu = $('mobile-menu'); if(!btn || !menu) return;
      const close = () => { menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); };
      const open  = () => { menu.classList.add('open');  btn.setAttribute('aria-expanded','true'); };
      btn.addEventListener('click', () => { (btn.getAttribute('aria-expanded') === 'true') ? close() : open(); });
      menu.querySelectorAll('a').forEach(a => a.addEventListener('click', close));
      window.addEventListener('keydown', e => { if(e.key === 'Escape') close(); }, { passive:true });
      window.addEventListener('click', e => { if(!menu.contains(e.target) && e.target !== btn && !btn.contains(e.target)) close(); }, { passive:true });
      window.addEventListener('resize', () => { if(window.innerWidth > 640) close(); }, { passive:true });
    })();

    /* ========= Wallet detection ========= */
    function detectCDC(p){ return !!(p && (p.isDeFiWallet || p.isDeficonnectProvider || p.isCryptoCom)); }
    function pickInjectedProvider(){
      const eth = window.ethereum;
      if (!eth) return window.deficonnectProvider || null;
      if (Array.isArray(eth.providers) && eth.providers.length){
        const mm  = eth.providers.find(p=>p && p.isMetaMask);
        const cdc = eth.providers.find(p=>detectCDC(p));
        return mm || cdc || eth.providers[0];
      }
      return eth;
    }
    function waitForEthereum(timeout=1800){
      return new Promise((resolve)=>{
        if (window.ethereum) return resolve(window.ethereum);
        const t=setTimeout(()=>resolve(window.ethereum||null),timeout);
        window.addEventListener('ethereum#initialized',()=>{ clearTimeout(t); resolve(window.ethereum||null); },{once:true});
      });
    }

    /* ========= App state ========= */
    let injected=null, provider=null, signer=null, addr=null;
    let __closeAt=0;
    let __drawStatus = 'open';     // 'open' | 'closed'

    function applyFlagsToUI(){
      // Banner + buttons tooltips
      const pausedMsg =
        __flags.pauseAll ? 'Platform paused' :
        __flags.pauseBuys ? 'Purchases paused' :
        __flags.pauseClaims ? 'Free claims paused' : '';

      const banner = $('platformBanner');
      if (banner){
        banner.innerHTML = pausedMsg ? `<b>${pausedMsg}.</b>` : '<b>Mega Jackpot Draw.</b>';
      }

      const canClaim = !__flags.pauseAll && !__flags.pauseClaims && (__drawStatus==='open');
      const canBuy   = !__flags.pauseAll && !__flags.pauseBuys   && (__drawStatus==='open');

      const qc=$('quick-claim'), mc=$('manual-claim'), buy=$('buy');
      if(qc){ qc.disabled = !canClaim; qc.title = canClaim?'':'Claims disabled'; }
      if(mc){ mc.disabled = !canClaim; mc.title = canClaim?'':'Claims disabled'; }
      if(buy){ buy.disabled = !canBuy; buy.title = canBuy?'':'Purchases disabled'; }
    }

    function wireProviderEvents(){
      if(!injected || injected._wired_draw) return;
      injected._wired_draw = true;
      injected.on?.('accountsChanged', async (acc)=>{
        dbg('accountsChanged', acc);
        if (acc && acc[0]){
          addr = acc[0].toLowerCase();
          setText('addr-pill', short(addr));
          await afterConnect();
        } else {
          doDisconnectUI();
        }
      });
      injected.on?.('chainChanged', (cid)=>{ dbg('chainChanged', cid); location.reload(); });
    }

    async function ensureCronos(){
      if(!injected) return;
      const desired = CRONOS.chainIdHex;
      let current;
      try{ current = await injected.request({method:'eth_chainId'}); dbg('chainId', current); }catch(e){ dbg('eth_chainId error', e?.message); }
      if ((current||'').toLowerCase() === desired) return;
      try{
        await injected.request({ method:'wallet_switchEthereumChain', params:[{ chainId:desired }]});
      }catch(e){
        if (e?.code === 4902){
          dbg('Adding Cronos via addEthereumChain');
          await injected.request({ method:'wallet_addEthereumChain', params:[{
            chainId:desired, chainName:'Cronos Mainnet',
            nativeCurrency:{ name:'Cronos', symbol:'CRO', decimals:18 },
            rpcUrls:[CRONOS.rpc], blockExplorerUrls:['https://cronoscan.com']
          }]});
        } else {
          throw e;
        }
      }
    }

    async function connect(){
  setBusy(true);
  try{
    await waitForEthereum();
    injected = pickInjectedProvider();
    dbg('picked provider', injected ? (injected.isMetaMask?'MetaMask':'CDC/Other') : 'none');
    if(!injected){
      alert('No wallet detected. Open this page inside MetaMask or Crypto.com DeFi Wallet.');
      dbg('no injected provider found');
      return;
    }

    // 1) Ask wallet for permission to expose accounts
    try { await injected.request({ method:'eth_requestAccounts' }); }
    catch(e){ alert('Connection cancelled.'); dbg('eth_requestAccounts', e?.message); return; }

    // 2) Create provider/signer + discover address
    provider = new ethers.providers.Web3Provider(injected, 'any');
    signer   = provider.getSigner();
    try { addr = (await signer.getAddress()).toLowerCase(); }
    catch(e){ alert('Could not read wallet address.'); dbg('getAddress', e?.message); return; }

    // (optional) make sure we‚Äôre on Cronos
    try { await ensureCronos(); } catch(e){ dbg('ensureCronos', e?.message); }

    // 3) REQUIRE 1-TIME DISCLAIMER SIGNATURE (inserted here)
    async function requireAgreement(){
      const existing = await agreementRef(addr).get().catch(()=>null);
      if (existing && existing.exists) return true;

      const ok = await new Promise((resolve)=>{
        showDialog();
        const agree  = $('dlg-agree');
        const cancel = $('dlg-cancel');

        const onAgree = async ()=>{
          agree.disabled = true;
          try{
            const msg = disclaimerMessage(addr);
            const sig = await signer.signMessage(msg); // EIP-191 personal_sign
            await agreementRef(addr).set({
              wallet: addr,
              message: msg,
              signature: sig,
              ua: navigator.userAgent || '',
              signedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge:true });
            hideDialog();
            resolve(true);
          }catch(e){
            console.warn('sign canceled/failed', e?.message||e);
            agree.disabled = false;
            hideDialog();
            resolve(false);
          }
        };

        const onCancel = ()=>{ hideDialog(); resolve(false); };

        agree.onclick  = onAgree;
        cancel.onclick = onCancel;
      });

      return ok;
    }

    const ok = await requireAgreement();
    if(!ok){
      toast('Signature required to continue.');
      return; // do NOT mark as connected, do NOT show app
    }

    // 4) Only NOW ‚Äúremember‚Äù the connection and reveal the app UI
    localStorage.setItem(LS_CONNECTED, '1');

    setText('addr-pill', short(addr));
    const chainId = await injected.request({method:'eth_chainId'}).catch(()=>null);
    setText('chain-pill', 'Chain ' + (chainId||'?'));

    $('connect').style.display='none';
    $('disconnect').style.display='inline-block';

    wireProviderEvents();
    await afterConnect();

  }catch(e){
    dbg('connect error', e?.message || e);
    alert('Wallet connect failed ‚Äî try in your wallet‚Äôs in-app browser.');
  }finally{
    setBusy(false);
  }
}

    function doDisconnectUI(){
      addr = null; provider=null; signer=null;
      $('app').style.display='none';
      $('admin').style.display='none';
      $('connect').style.display='inline-block';
      $('disconnect').style.display='none';
      setText('addr-pill','‚Äî'); setText('tier-pill','Tier: ‚Äî'); setText('free-pill','Free left: ‚Äî');
    }

    function disconnect(){
      // cannot force the extension to forget, but clear our state
      localStorage.removeItem(LS_CONNECTED);
      doDisconnectUI();
      toast('Disconnected.');
    }

    /* ========= Draw + Tier ========= */
    async function loadDraw(){
      try{
        const snap = await db.collection('draws').doc(DRAW_ID).get();
        const d = snap.exists ? snap.data() : { status:'open', commitHash:'‚Äî', closeAt:Date.now()+7*864e5, pots:{cron8:0,cro:0} };
        __drawStatus = d.status || 'open';
        setText('status-pill', d.status||'‚Äî');
        setText('jp-closes', d.closeAt ? new Date(d.closeAt).toLocaleString() : '‚Äî');
        setText('jp-cron8', (d.pots?.cron8||0).toLocaleString());
        setText('jp-cro',   (d.pots?.cro||0).toLocaleString());
        __closeAt = d.closeAt||0;
        applyFlagsToUI();
      }catch(e){ dbg('loadDraw', e?.message); }
    }
    setInterval(()=>{
      if(!__closeAt){ setText('countdown','‚Äî'); return; }
      const s = Math.max(0, Math.floor((__closeAt - Date.now())/1000));
      const d = Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60), sec=s%60;
      setText('countdown', `${d}d ${h}h ${m}m ${sec}s`);
    }, 1000);

    async function restorePassport(){
      try{ if(!addr) return; await db.collection('passports').doc(addr).get(); }catch(e){ dbg('restorePassport', e?.message); }
    }

    async function cron8Balance(a){
      const read = new ethers.providers.JsonRpcProvider(CRONOS.rpc);
      const erc20 = new ethers.Contract(CRON8.address, CRON8.abi, read);
      return await erc20.balanceOf(a);
    }
    const parseUnits=(v,d)=> ethers.utils.parseUnits(v,d);

    async function refreshTier(){
      if(!addr) return;
      try{
        const bal = await cron8Balance(addr);
        let tier = 0;
        for (const t of TIER){
          if (ethers.BigNumber.from(bal).gte(parseUnits(t.min, CRON8.decimals))){ tier = t.tier; break; }
        }
        setText('tier-pill', 'Tier: ' + (tier===0?'None':('T'+tier)));

        const claimed = await db.collection('tickets')
          .where('drawId','==',DRAW_ID).where('wallet','==',addr).where('isFree','==',true).get()
          .then(q=>q.size).catch(()=>0);
        const left = Math.max(0, (FREE[tier] ?? 0) - claimed);
        setText('free-pill', 'Free left: ' + left);
        window.__freeLeft = left;
      }catch(e){ dbg('refreshTier', e?.message); setText('tier-pill', 'Tier: ‚Äî'); setText('free-pill', 'Free left: ‚Äî'); }
    }

    const primSel = new Set();
    let mega = NUM.megaMin;
    function renderPicker(){
      const prim = $('prim'), m = $('mega');
      prim.innerHTML = ''; m.innerHTML='';
      for(let n=NUM.primMin; n<=NUM.primMax; n++){
        const b = document.createElement('button');
        b.type='button'; b.className='n' + (primSel.has(n)?' on':''); b.textContent=String(n);
        b.onclick = ()=>{ if(primSel.has(n)) primSel.delete(n); else if(primSel.size<NUM.primPick) primSel.add(n); renderPicker(); };
        prim.appendChild(b);
      }
      for(let n=NUM.megaMin; n<=NUM.megaMax; n++){
        const b = document.createElement('button');
        b.type='button'; b.className='n mega' + (mega===n?' on':''); b.textContent=String(n);
        b.onclick = ()=>{ mega = n; renderPicker(); };
        m.appendChild(b);
      }
    }
    renderPicker();

    function quickPick(){
      const s=new Set(); while(s.size<NUM.primPick){ s.add(Math.floor(Math.random()*(NUM.primMax-NUM.primMin+1))+NUM.primMin); }
      const primary=[...s].sort((a,b)=>a-b);
      const megaNum=Math.floor(Math.random()*(NUM.megaMax-NUM.megaMin+1))+NUM.megaMin;
      return { primary, mega: megaNum };
    }

    /* ========= Live admin flags subscription ========= */
    db.collection(CONFIG_DOC.col).doc(CONFIG_DOC.doc).onSnapshot(snap => {
      const data = snap.exists ? snap.data() : {};
      __flags = { ...FLAGS_DEFAULT, ...(data.flags || {}) };
      dbg('flags', __flags);
      applyFlagsToUI();
    }, (err)=>dbg('flags subscribe error', err?.message||err));

    /* ========= Claim & Buy ========= */
    $('quick-claim').onclick = async ()=>{
      if(!addr) return alert('Connect wallet first');

      // ensure the disclaimer was signed (in case they connected in a previous tab)
const agreed = await agreementRef(addr).get().then(s=>s.exists).catch(()=>false);
if(!agreed){
  alert('Please accept the disclaimer first (you will be asked to sign once).');
  // optionally pop the modal and run the same sign flow:
  $('connect').click(); // leverage the connect flow to show modal/sign again
  return;
}

      // Guards
      if (__flags.pauseAll || __flags.pauseClaims) return alert('Free claims are currently paused.');
      if ((__drawStatus||'open') !== 'open') return alert('This draw is closed.');
      if((window.__freeLeft ?? 0) <= 0) return alert('No free entries left for your tier');

      try{
        const picks = quickPick();
        await db.collection('tickets').add({
          drawId:DRAW_ID, wallet:addr, picks:picks.primary, mega:picks.mega, isFree:true,
          created: firebase.firestore.FieldValue.serverTimestamp()
        });
        await loadMine(); await refreshTier();
        toast('Free ticket claimed ‚úÖ');
      }catch(e){ dbg('claim quick', e?.message); alert('Claim failed.'); }
    };

    $('manual-claim').onclick = async ()=>{
      if(!addr) return alert('Connect wallet first');

      // ensure the disclaimer was signed (in case they connected in a previous tab)
const agreed = await agreementRef(addr).get().then(s=>s.exists).catch(()=>false);
if(!agreed){
  alert('Please accept the disclaimer first (you will be asked to sign once).');
  // optionally pop the modal and run the same sign flow:
  $('connect').click(); // leverage the connect flow to show modal/sign again
  return;
}

      // Correct guards for manual free claims
      if (__flags.pauseAll || __flags.pauseClaims) return alert('Free claims are currently paused.');
      if ((__drawStatus||'open') !== 'open') return alert('This draw is closed.');

      if(primSel.size !== NUM.primPick) return alert(`Pick exactly ${NUM.primPick} numbers`);
      if((window.__freeLeft ?? 0) <= 0) return alert('No free entries left for your tier');
      try{
        const picks = { primary:[...primSel].sort((a,b)=>a-b), mega };
        await db.collection('tickets').add({
          drawId:DRAW_ID, wallet:addr, picks:picks.primary, mega:picks.mega, isFree:true,
          created: firebase.firestore.FieldValue.serverTimestamp()
        });
        primSel.clear(); mega = NUM.megaMin; renderPicker();
        await loadMine(); await refreshTier();
        toast('Free ticket claimed ‚úÖ');
      }catch(e){ dbg('claim manual', e?.message); alert('Claim failed.'); }
    };

    let __nextBuyAt = 0;
    $('buy').onclick = async ()=>{
      if(!addr) return alert('Connect wallet first');

      // ensure the disclaimer was signed (in case they connected in a previous tab)
const agreed = await agreementRef(addr).get().then(s=>s.exists).catch(()=>false);
if(!agreed){
  alert('Please accept the disclaimer first (you will be asked to sign once).');
  // optionally pop the modal and run the same sign flow:
  $('connect').click(); // leverage the connect flow to show modal/sign again
  return;
}

      if (__flags.pauseAll || __flags.pauseBuys) return alert('Purchases are currently paused.');
      if ((__drawStatus||'open') !== 'open') return alert('This draw is closed.');

      const now=Date.now(); if(now<__nextBuyAt) return alert(`Please wait ${Math.ceil((__nextBuyAt-now)/1000)}s‚Ä¶`);
      try{
        await ensureCronos();
        const qty=Math.max(1, parseInt(($('qty').value||'1'),10));
        const total=ethers.utils.parseEther(String(15 * qty));
        await injected.request({ method:'eth_sendTransaction', params:[{ from:addr, to:DEV_WALLET, value: total.toHexString() }]});
        __nextBuyAt=Date.now()+3000;

        const batch=[];
        for(let i=0;i<qty;i++){
          const picks=quickPick();
          batch.push(db.collection('tickets').add({
            drawId:DRAW_ID, wallet:addr, picks:picks.primary, mega:picks.mega, isFree:false,
            created: firebase.firestore.FieldValue.serverTimestamp()
          }));
        }
        batch.push(db.collection('ledger').add({
          drawId:DRAW_ID, type:'purchase', wallet:addr, qty, priceCro:15, to:DEV_WALLET,
          at: firebase.firestore.FieldValue.serverTimestamp()
        }));
        await Promise.all(batch);
        await loadMine();
        alert(`Purchased ${qty} ticket(s). CRO sent.`);
      }catch(e){ dbg('buy failed', e?.message); alert('Payment cancelled or failed.'); }
    };

    async function loadMine(){
      if(!addr){ $('tickets').innerHTML = '<div class="muted">Connect wallet to see your tickets.</div>'; return; }
      try{
        const snap = await db.collection('tickets')
          .where('drawId','==',DRAW_ID).where('wallet','==',addr).orderBy('created','desc').get();
        const out=[];
        snap.forEach(doc=>{
          const d=doc.data();
          out.push(`<div class="card"><div class="body">
            <div class="muted">${d.isFree?'Free':'Paid'}</div>
            <div class="mono" style="margin-top:4px;">${(d.picks||[]).join(' - ')}  |  ‚òÖ ${d.mega}</div>
          </div></div>`);
        });
        $('tickets').innerHTML = out.join('') || '<div class="muted">No tickets yet.</div>';
      }catch(e){ dbg('loadMine', e?.message); $('tickets').innerHTML = '<div class="muted">Could not load tickets.</div>'; }
    }

    /* ========= Admin (commit‚Äìreveal + flags) ========= */
    const SEED_KEY='cronation_draw_seed';
    const toHex=(buf)=>Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    async function sha256Hex(str){ const enc=new TextEncoder(); const buf=await crypto.subtle.digest('SHA-256', enc.encode(str)); return '0x'+toHex(buf); }
    function randomSeed(){ const b=new Uint8Array(32); crypto.getRandomValues(b); return '0x'+Array.from(b).map(x=>x.toString(16).padStart(2,'0')).join(''); }

    async function adminRefresh(){
      try{
        const snap=await db.collection('draws').doc(DRAW_ID).get();
        if(!snap.exists){ setText('admin-status','status: (no draw)'); setText('admin-commit','‚Äî'); setText('admin-reveal','‚Äî'); await adminLoadFlags(); return; }
        const d=snap.data();
        __drawStatus = d.status || 'open';
        setText('admin-status',`status: ${__drawStatus}`);
        setText('admin-commit',d.commitHash||'‚Äî');
        setText('admin-reveal',d.revealSeed||localStorage.getItem(SEED_KEY)||'‚Äî');
        if(d.closeAt) $('admin-closeAt').value=new Date(d.closeAt).toISOString().slice(0,16);
        $('admin-cron8').value=d.pots?.cron8 ?? 0; $('admin-cro').value=d.pots?.cro ?? 0;
        await adminLoadFlags();
        applyFlagsToUI();
      }catch(e){ dbg('adminRefresh', e?.message); }
    }

    async function adminLoadFlags(){
      try{
        const snap = await db.collection(CONFIG_DOC.col).doc(CONFIG_DOC.doc).get();
        const data = snap.exists ? snap.data() : {};
        const f = { ...FLAGS_DEFAULT, ...(data.flags || {}) };
        $('flag-pause-all').checked   = !!f.pauseAll;
        $('flag-pause-claims').checked= !!f.pauseClaims;
        $('flag-pause-buys').checked  = !!f.pauseBuys;
      }catch(e){ dbg('adminLoadFlags', e?.message); }
    }

    $('admin-save-flags').onclick = async ()=>{
      try{
        const f = {
          pauseAll:   $('flag-pause-all').checked,
          pauseClaims:$('flag-pause-claims').checked,
          pauseBuys:  $('flag-pause-buys').checked,
        };
        await db.collection(CONFIG_DOC.col).doc(CONFIG_DOC.doc)
          .set({ flags: f }, { merge:true });
        toast('Flags saved ‚úÖ');
      }catch(e){ dbg('admin-save-flags', e?.message); alert('Saving flags failed. Check Firestore rules.'); }
    };

    $('admin-open').onclick = async ()=>{
      try{
        const seed=randomSeed(); const commit=await sha256Hex(seed); localStorage.setItem(SEED_KEY,seed);
        const closeAtStr=$('admin-closeAt').value; const closeAt=closeAtStr? new Date(closeAtStr).getTime() : (Date.now()+7*864e5);
        const cron8=parseFloat($('admin-cron8').value||'0')||0; const cro=parseFloat($('admin-cro').value||'0')||0;
        await db.collection('draws').doc(DRAW_ID).set({
          status:'open', commitHash:commit, closeAt, pots:{cron8,cro},
          revealSeed: firebase.firestore.FieldValue.delete()
        },{merge:true});
        await adminRefresh(); await loadDraw(); alert('Draw opened. Seed saved locally.');
      }catch(e){ dbg('admin-open', e?.message); alert('Open failed.'); }
    };

    $('admin-close').onclick = async ()=>{
      try{
        const seed=localStorage.getItem(SEED_KEY); if(!seed) return alert('No local seed to reveal.');
        await db.collection('draws').doc(DRAW_ID).set({ status:'closed', revealSeed:seed },{merge:true});
        await adminRefresh(); await loadDraw(); alert('Draw closed & seed revealed.');
      }catch(e){ dbg('admin-close', e?.message); alert('Close failed.'); }
    };

    $('admin-refresh').onclick = adminRefresh;
    $('copy-commit').onclick = ()=> navigator.clipboard.writeText(($('admin-commit').textContent||'').trim());
    $('copy-reveal').onclick = ()=> navigator.clipboard.writeText(($('admin-reveal').textContent||'').trim());

    /* ========= Boot (no auto-connect UI) ========= */
    (async ()=>{
      await loadDraw();

      await waitForEthereum();
      injected = pickInjectedProvider();

      // Bind buttons once
      const btnConnect = $('connect');
      const btnDisc = $('disconnect');
      if(btnConnect && !btnConnect.__bound){ btnConnect.addEventListener('click', (ev)=>{ ev.preventDefault(); connect(); }, { passive:false }); btnConnect.__bound = true; }
      if(btnDisc && !btnDisc.__bound){ btnDisc.addEventListener('click', (ev)=>{ ev.preventDefault(); disconnect(); }, { passive:false }); btnDisc.__bound = true; }

      if (injected){
        try{
          const chainId = await injected.request({method:'eth_chainId'}).catch(()=>null);
          setText('chain-pill','Chain ' + (chainId||'‚Äî'));

          // Don‚Äôt auto-connect UI; just show address if already authorized AND user opted to remember
          const acc = await injected.request({ method:'eth_accounts' }).catch(()=>[]);
          const shouldRestore = localStorage.getItem(LS_CONNECTED) === '1';
          if (shouldRestore && acc && acc[0]){
            provider = new ethers.providers.Web3Provider(injected, 'any');
            signer   = provider.getSigner();
            addr     = acc[0].toLowerCase();
            setText('addr-pill', short(addr));
            $('connect').style.display='none';
            $('disconnect').style.display='inline-block';
            wireProviderEvents();
            await afterConnect();
          } else {
            // keep UI disconnected
            setText('addr-pill','‚Äî');
          }
        }catch(e){ dbg('boot', e?.message); }
      } else {
        dbg('no provider on boot');
      }
    })();

    /* ========= After connect ========= */
    async function afterConnect(){
      $('app').style.display='grid';
      await loadDraw();
      await refreshTier();
      await restorePassport();
      await loadMine();

      const isAdmin = !!addr && (addr.toLowerCase() === ADMIN_WALLET.toLowerCase());
      $('admin').style.display = isAdmin ? 'block' : 'none';
      const link = $('adminLink'); if (link) link.style.display = isAdmin ? 'inline-block' : 'none';
      if(isAdmin) await adminRefresh();
    }

    /* ========= Debug toggle ========= */
    (function initDebug(){
      const on = new URLSearchParams(location.search).get('debug') === '1';
      $('debug').style.display = on ? 'block' : 'none';
      const btn = $('toggleDebug');
      if(btn){
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
        btn.onclick = () => {
          const open = $('debug').style.display !== 'block';
          $('debug').style.display = open ? 'block' : 'none';
          btn.setAttribute('aria-pressed', open ? 'true':'false');
          btn.textContent = open ? 'Hide debug' : 'Show debug';
        };
      }
    })();
  </script>
</body>
</html>
